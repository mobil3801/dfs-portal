import{j as e}from"./radix-ui-BhRELLXi.js";import{r as s}from"./react-core-CKNU0hQt.js";import{t,T as r,a,b as i,c as n,d as l,e as c,B as o,f as d,C as u,g as m,h as p,i as h,S as x,j as g,u as j,k as f,l as _,I as y}from"./index-s81fdLZV.js";import{D as w,a as N,b as v,c as b,d as C}from"./dialog-DoXR3LdX.js";import{P as S,I as D,n as P,D as I,m as $,F,R as M,X as k,J as A,K as L,U as E,x as U,N as z,O,Q as T,V,W as R,Y as q}from"./utilities-DVevn_gw.js";import{u as B}from"./use-mobile-BQxxJ7Jh.js";import{s as W,g as Y}from"./invariantSafeHelper-CpdXj1Qs.js";import{u as J}from"./routing-DcURAnU1.js";import"./data-management-CF8GQrOz.js";import"./animations-Cc9qW4PM.js";const K=({isOpen:d,onClose:u,productId:m,productName:p})=>{const[h,x]=s.useState([]),[g,j]=s.useState(!1);s.useEffect(()=>{d&&m&&f()},[d,m]);const f=async()=>{try{j(!0),console.log("Loading product logs for product ID:",m);const{data:e,error:s}=await window.ezsite.apis.tablePage("11756",{PageNo:1,PageSize:100,OrderByField:"change_date",IsAsc:!1,Filters:[{name:"product_id",op:"Equal",value:m}]});if(s)throw console.error("API error loading logs:",s),s;console.log("Loaded logs:",e?.List||[]),x(e?.List||[])}catch(e){console.error("Error loading product logs:",e),t({title:"Error",description:`Failed to load product change logs: ${e}`,variant:"destructive"})}finally{j(!1)}},_=e=>{if(!e)return"-";try{return new Date(e).toLocaleString()}catch{return"-"}},y=(e,s)=>{if(!s||""===s)return"-";if(e.includes("price")||"profit_margin"===e){const e=parseFloat(s);if(!isNaN(e))return`$${e.toFixed(2)}`}if(e.includes("date"))try{return new Date(s).toLocaleDateString()}catch{return s}return s},F=s=>{switch(s){case"last_shopping_date":return e.jsx($,{className:"w-4 h-4"});case"case_price":case"unit_price":case"retail_price":return e.jsx(I,{className:"w-4 h-4"});case"unit_per_case":return e.jsx(S,{className:"w-4 h-4"});case"profit_margin":return e.jsx(P,{className:"w-4 h-4"});default:return null}},M=e=>{switch(e){case"last_shopping_date":return"Last Shopping Date";case"case_price":return"Case Price";case"unit_per_case":return"Unit Per Case";case"unit_price":return"Unit Price";case"retail_price":return"Retail Price";case"profit_margin":return"Profit Margin";default:return e.replace("_"," ").replace(/\b\w/g,e=>e.toUpperCase())}},k=e=>{switch(e){case"last_shopping_date":return"bg-blue-100 text-blue-800";case"case_price":return"bg-green-100 text-green-800";case"unit_per_case":return"bg-purple-100 text-purple-800";case"unit_price":return"bg-orange-100 text-orange-800";case"retail_price":return"bg-red-100 text-red-800";case"profit_margin":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}};return e.jsx(w,{open:d,onOpenChange:u,children:e.jsxs(N,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(v,{children:[e.jsxs(b,{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"w-5 h-5"}),e.jsx("span",{children:"Product Change Logs"})]}),e.jsxs(C,{children:["Change history for: ",e.jsx("span",{className:"font-medium",children:p})]})]}),e.jsx("div",{className:"mt-4",children:g?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,t)=>e.jsx("div",{className:"h-16 bg-gray-100 rounded animate-pulse"},t))}):0===h.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(S,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No change logs found for this product"}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Changes will appear here when product information is updated"})]}):e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(r,{children:[e.jsx(a,{children:e.jsxs(i,{children:[e.jsx(n,{children:"Field"}),e.jsx(n,{children:"Change Date"}),e.jsx(n,{children:"Old Value"}),e.jsx(n,{className:"text-center",children:"â†’"}),e.jsx(n,{children:"New Value"})]})}),e.jsx(l,{children:h.map(s=>e.jsxs(i,{children:[e.jsx(c,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[F(s.field_name),e.jsx(o,{className:k(s.field_name),children:M(s.field_name)})]})}),e.jsx(c,{className:"text-sm text-gray-600",children:_(s.change_date)}),e.jsx(c,{children:e.jsx("span",{className:"px-2 py-1 bg-red-50 text-red-700 rounded text-sm",children:y(s.field_name,s.old_value)})}),e.jsx(c,{className:"text-center",children:e.jsx(D,{className:"w-4 h-4 text-gray-400"})}),e.jsx(c,{children:e.jsx("span",{className:"px-2 py-1 bg-green-50 text-green-700 rounded text-sm",children:y(s.field_name,s.new_value)})})]},s.ID))})]})})})]})})},Q=({isOpen:r,onClose:a,productId:i,productName:n})=>{const[l,c]=s.useState([]),[g,j]=s.useState(!1),[f,_]=s.useState({});s.useEffect(()=>{r&&i&&y()},[r,i]);const y=async()=>{j(!0);try{const{data:e,error:s}=await window.ezsite.apis.tablePage("24010",{PageNo:1,PageSize:100,OrderByField:"change_timestamp",IsAsc:!1,Filters:[{name:"product_id",op:"Equal",value:i}]});if(s)throw s;const t=e?.List||[];c(t);const r=[...new Set(t.map(e=>e.changed_by))];await S(r)}catch(e){console.error("Error fetching changelog:",e),t({title:"Error",description:"Failed to load changelog data",variant:"destructive"})}finally{j(!1)}},S=async e=>{try{const t={};for(const r of e)try{const{data:e,error:s}=await window.ezsite.apis.tablePage("11725",{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!0,Filters:[{name:"user_id",op:"Equal",value:r}]});if(!s&&e?.List?.[0]){const s=e.List[0];t[r]=`${s.employee_id||"Unknown"} (ID: ${r})`}else t[r]=`User ${r}`}catch(s){t[r]=`User ${r}`}_(t)}catch(s){console.error("Error fetching user names:",s)}},D=(e,s)=>{if(!s)return"Empty";if(e.includes("price")||"profit_margin"===e){const t=parseFloat(s);if(!isNaN(t))return"profit_margin"===e?`${t.toFixed(2)}%`:`$${t.toFixed(2)}`}if(e.includes("date"))try{return A(new Date(s),"MMM dd, yyyy")}catch{return s}return s},I=e=>{switch(e.toLowerCase()){case"create":return"bg-green-100 text-green-800";case"update":return"bg-blue-100 text-blue-800";case"delete":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},U=(s,t,r)=>{if(s.includes("price")){const s=parseFloat(t),a=parseFloat(r);if(!isNaN(s)&&!isNaN(a)){if(a>s)return e.jsx(P,{className:"w-4 h-4 text-green-600 inline ml-1"});if(a<s)return e.jsx(P,{className:"w-4 h-4 text-red-600 inline ml-1 rotate-180"})}}return null},z=(e=>{const s={};return e.forEach(e=>{const t=A(new Date(e.change_timestamp),"yyyy-MM-dd");s[t]||(s[t]=[]),s[t].push(e)}),Object.entries(s).sort(([e],[s])=>s.localeCompare(e))})(l);return e.jsx(w,{open:r,onOpenChange:a,children:e.jsxs(N,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx(v,{className:"flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(b,{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"w-5 h-5"}),e.jsx("span",{children:"Product Changelog"})]}),e.jsxs(C,{children:["Change history for ",e.jsx("strong",{children:n})," (Product ID: ",i,")"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:y,disabled:g,className:"flex items-center space-x-1",children:[e.jsx(M,{className:"w-4 h-4 "+(g?"animate-spin":"")}),e.jsx("span",{children:"Refresh"})]}),e.jsx(d,{variant:"outline",size:"sm",onClick:a,children:e.jsx(k,{className:"w-4 h-4"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-auto space-y-4",children:g?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Loading changelog..."})]})}):0===l.length?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(F,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Changes Found"}),e.jsx("p",{className:"text-gray-500",children:"This product has no recorded changes yet."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(u,{children:[e.jsx(m,{children:e.jsx(p,{className:"text-lg",children:"Change Summary"})}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:l.length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Total Changes"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:l.filter(e=>"create"===e.change_type).length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Created"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:l.filter(e=>"update"===e.change_type).length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Updated"})]})]})})]}),e.jsx("div",{className:"space-y-4",children:z.map(([s,t])=>e.jsxs(u,{children:[e.jsx(m,{children:e.jsxs(p,{className:"flex items-center space-x-2 text-base",children:[e.jsx($,{className:"w-4 h-4"}),e.jsx("span",{children:A(new Date(s),"EEEE, MMMM dd, yyyy")}),e.jsxs(o,{variant:"secondary",children:[t.length," changes"]})]})}),e.jsx(h,{children:e.jsx("div",{className:"space-y-3",children:t.map(s=>{return e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(o,{className:I(s.change_type),children:s.change_type.toUpperCase()}),e.jsx("span",{className:"font-medium",children:(t=s.field_name,{last_shopping_date:"Last Shopping Date",case_price:"Case Price",unit_per_case:"Unit Per Case",unit_price:"Unit Price",retail_price:"Retail Price",profit_margin:"Profit Margin",product_name:"Product Name",category:"Category",supplier:"Supplier",weight:"Weight",weight_unit:"Weight Unit",department:"Department",description:"Description",quantity_in_stock:"Stock Quantity",minimum_stock:"Minimum Stock"}[t]||t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()))})]}),e.jsxs("div",{className:"text-sm text-gray-500 flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(L,{className:"w-3 h-3"}),e.jsx("span",{children:A(new Date(s.change_timestamp),"h:mm aa")})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(E,{className:"w-3 h-3"}),e.jsx("span",{children:f[s.changed_by]||`User ${s.changed_by}`})]})]})]}),"update"===s.change_type&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 mb-1",children:"Previous Value:"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded px-3 py-2",children:D(s.field_name,s.old_value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 mb-1",children:"New Value:"}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded px-3 py-2 flex items-center",children:[D(s.field_name,s.new_value),U(s.field_name,s.old_value,s.new_value)]})]})]}),"create"===s.change_type&&e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"text-gray-500 mb-1",children:"Initial Value:"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded px-3 py-2",children:D(s.field_name,s.new_value)})]}),s.change_summary&&e.jsxs("div",{className:"mt-3 text-sm text-gray-600",children:[e.jsx("strong",{children:"Summary:"})," ",s.change_summary]})]},s.ID);var t})})})]},s))})]})}),e.jsx(x,{className:"my-4"}),e.jsx("div",{className:"flex justify-end space-x-2 flex-shrink-0",children:e.jsx(d,{variant:"outline",onClick:a,children:"Close"})})]})})},G=({text:s,searchTerms:t,allMatch:r})=>{if(!t.length||!s)return e.jsx(e.Fragment,{children:s});const a=t.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),i=new RegExp(`(${a.join("|")})`,"gi"),n=s.split(i);return e.jsx(e.Fragment,{children:n.map((s,a)=>t.some(e=>s.toLowerCase()===e.toLowerCase())?e.jsx("span",{className:"font-semibold "+(r?"bg-green-200 text-green-800":"bg-yellow-200 text-yellow-800"),children:s},a):s)})},H=({children:s,className:t="",fallbackComponent:r})=>{const a=B();return a.isMobile&&r?e.jsx(e.Fragment,{children:r}):e.jsx("div",{className:g("overflow-x-auto",a.isMobile&&"overflow-x-scroll",t),children:s})},X=({children:s,className:t="",spacing:r="md"})=>{const a=B(),i=g("flex flex-col",{sm:"space-y-2 sm:space-y-3",md:"space-y-4 sm:space-y-6",lg:"space-y-6 sm:space-y-8"}[r],a.isMobile&&"px-1",t);return e.jsx("div",{className:i,children:s})},Z=({products:s,searchTerm:t,onViewLogs:r,onSaveProduct:a,onDeleteProduct:i,savingProductId:n,userRole:l})=>{const c=e=>{if(!e)return"-";try{return new Date(e).toLocaleDateString()}catch{return"-"}},x=s=>{if(!t||!s)return{keywords:[],allMatch:!1,highlightComponent:s};const r=t.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0),a=s.toLowerCase(),i=r.every(e=>a.includes(e));return{keywords:r,allMatch:i,highlightComponent:e.jsx(G,{text:s,searchTerms:r,allMatch:i})}};return e.jsx("div",{className:"grid grid-cols-1 gap-4",children:s.map(s=>{const g=(e=>{if(e.unit_price&&e.retail_price&&e.retail_price>0){const s=(e.retail_price-e.unit_price)/e.retail_price*100;return{value:s,variant:s>20?"default":s>10?"secondary":"destructive"}}return null})(s);return e.jsxs(u,{className:"hover:shadow-md transition-shadow",children:[e.jsxs(m,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(p,{className:"text-lg leading-tight",children:t?x(s.product_name).highlightComponent:s.product_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsxs(o,{variant:"outline",className:"text-xs",children:["#",s.serial_number||"-"]}),e.jsx(o,{variant:"outline",className:"text-xs",children:t?x(s.department||"Convenience Store").highlightComponent:s.department||"Convenience Store"})]})]}),e.jsxs("div",{className:"flex items-center space-x-1 ml-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:()=>r(s.ID,s.product_name),className:"p-2",title:"View logs",children:e.jsx(F,{className:"w-4 h-4"})}),("Administrator"===l||"Admin"===l)&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>a(s.ID),disabled:n===s.ID,className:"p-2",title:"Save product",children:n===s.ID?e.jsx(U,{className:"w-4 h-4 animate-spin"}):e.jsx(z,{className:"w-4 h-4"})}),("Administrator"===l||"Admin"===l)&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>i(s.ID),className:"p-2 text-red-600 hover:text-red-700",title:"Delete product",children:e.jsx(O,{className:"w-4 h-4"})})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-2 line-clamp-2",children:t?x(s.description).highlightComponent:s.description})]}),e.jsxs(h,{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Unit Price:"}),e.jsx("div",{className:"font-medium",children:s.unit_price?`$${s.unit_price.toFixed(2)}`:"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Retail Price:"}),e.jsx("div",{className:"font-medium",children:s.retail_price?`$${s.retail_price.toFixed(2)}`:"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Case Price:"}),e.jsx("div",{className:"font-medium",children:s.case_price?`$${s.case_price.toFixed(2)}`:"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Profit Margin:"}),e.jsx("div",{className:"font-medium",children:g?e.jsxs(o,{variant:g.variant,className:"text-xs",children:[g.value.toFixed(1),"%"]}):"-"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 text-sm border-t pt-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Weight:"}),e.jsx("span",{className:"font-medium",children:s.weight&&s.weight>0?`${s.weight} ${s.weight_unit||"lb"}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Supplier:"}),e.jsx("span",{className:"font-medium truncate ml-2",children:t?x(s.supplier||"-").highlightComponent:s.supplier||"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Unit per Case:"}),e.jsx("span",{className:"font-medium",children:s.unit_per_case||"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Last Updated:"}),e.jsx("span",{className:"font-medium",children:c(s.last_updated_date)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Last Shopping:"}),e.jsx("span",{className:"font-medium",children:c(s.last_shopping_date)})]})]})]})]},s.ID)})})},ee=()=>{const x=J(),{userProfile:g}=j(),w=B(),{canCreate:N,canEdit:v,canDelete:b,isModuleAccessEnabled:C}=f(),D=N("products"),P=v("products");b("products");const[I,$]=s.useState([]),[A,L]=s.useState([]),[E,z]=s.useState(!0),[ee,se]=s.useState(""),[te,re]=s.useState(0),[ae,ie]=s.useState(!1),[ne,le]=s.useState(!1),[ce,oe]=s.useState(null),[de,ue]=s.useState(""),[me,pe]=s.useState(!1),[he,xe]=s.useState(!0),[ge,je]=s.useState(!1),[fe,_e]=s.useState(null),[ye,we]=s.useState(!1),Ne=50,[ve,be]=s.useState(Ne),Ce=s.useRef(null);s.useEffect(()=>{const e=setTimeout(()=>{ue(ee),be(Ne)},300);return()=>clearTimeout(e)},[ee,Ne]),s.useEffect(()=>{Se()},[]),s.useEffect(()=>{De()},[de,ve,A]);const Se=async()=>{try{z(!0);const{data:e,error:s}=await window.ezsite.apis.tablePage("11726",{PageNo:1,PageSize:1e3,OrderByField:"ID",IsAsc:!1,Filters:[]});if(s)throw s;L(e?.List||[])}catch(e){console.error("Error loading products:",e),t({title:"Error",description:"Failed to load products",variant:"destructive"})}finally{z(!1)}},De=()=>{pe(!!de);let e=A;if(de){const s=de.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0);e=A.filter(e=>{const t=[e.product_name,e.description,e.category,e.supplier,e.department,e.bar_code_case,e.bar_code_unit,e.serial_number?.toString()].join(" ").toLowerCase();return s.every(e=>t.includes(e))})}de||(e=e.sort((e,s)=>(e.serial_number||0)-(s.serial_number||0)));const s=e.slice(0,ve);$(s),re(e.length),xe(ve<e.length)},Pe=async()=>{try{we(!0),console.log("Starting auto-adjustment of serial numbers...");const{data:e,error:s}=await window.ezsite.apis.tablePage("11726",{PageNo:1,PageSize:1e3,OrderByField:"ID",IsAsc:!0,Filters:[]});if(s)throw s;const r=e?.List||[];console.log(`Found ${r.length} products for serial number adjustment`);let a=!1;for(let t=0;t<r.length;t++){const e=t+1,s=r[t].serial_number;if(s!==e){a=!0,console.log(`Product ID ${r[t].ID} has serial ${s}, should be ${e}`);break}}if(!a)return void console.log("Serial numbers are already continuous, no adjustment needed");const i=r.map(async(e,s)=>{const t=s+1,r=e.serial_number;if(r!==t){console.log(`Updating product ID ${e.ID} serial from ${r} to ${t}`);const s={ID:e.ID,serial_number:t,product_name:e.product_name,category:e.category||"",quantity_in_stock:e.quantity_in_stock||0,minimum_stock:e.minimum_stock||0,supplier:e.supplier||"",description:e.description||"",weight:e.weight||0,weight_unit:e.weight_unit||"lb",department:e.department||"Convenience Store",merchant_id:e.merchant_id||null,bar_code_case:e.bar_code_case||"",bar_code_unit:e.bar_code_unit||"",last_updated_date:(new Date).toISOString(),last_shopping_date:e.last_shopping_date||null,case_price:e.case_price||0,unit_per_case:e.unit_per_case||1,unit_price:e.unit_price||0,retail_price:e.retail_price||0,overdue:e.overdue||!1,created_by:e.created_by||g?.user_id||null},{error:a}=await window.ezsite.apis.tableUpdate("11726",s);if(a)throw console.error(`Failed to update serial for product ID ${e.ID}:`,a),a}});await Promise.all(i),console.log("Serial number auto-adjustment completed successfully"),t({title:"Serial Numbers Updated",description:"Product serial numbers have been automatically adjusted to maintain continuity.",duration:3e3})}catch(e){console.error("Error during serial number auto-adjustment:",e),t({title:"Warning",description:"Failed to auto-adjust serial numbers. Please check the system logs.",variant:"destructive",duration:5e3})}finally{we(!1)}},Ie=async e=>{if(console.log("handleDelete called for product ID:",e),"Administrator"!==g?.role&&"Admin"!==g?.role)return void t({title:"Access Denied",description:"Only administrators can delete products.",variant:"destructive"});const s=confirm("Are you sure you want to delete this product? This action cannot be undone. Serial numbers will be automatically adjusted to maintain continuity.");if(console.log("User confirmed deletion:",s),s)try{console.log("Attempting to delete product with ID:",e);const{error:s}=await window.ezsite.apis.tableDelete("11726",{ID:e});if(s)throw console.error("API returned error:",s),s;console.log("Product deleted successfully"),t({title:"Success",description:"Product deleted successfully. Adjusting serial numbers...",duration:2e3}),await Pe(),Se()}catch(r){console.error("Error deleting product:",r),t({title:"Error",description:`Failed to delete product: ${r}`,variant:"destructive"})}else console.log("Deletion cancelled by user")},$e=s.useCallback(()=>{!ge&&he&&(je(!0),setTimeout(()=>{be(e=>e+Ne),je(!1)},300))},[ge,he,Ne]);s.useEffect(()=>{const e=new IntersectionObserver(e=>{e[0].isIntersecting&&he&&!ge&&$e()},{threshold:.1,rootMargin:"100px"}),s=Ce.current;return s&&e.observe(s),()=>{s&&e.unobserve(s)}},[$e,he,ge]);const Fe=(e,s)=>{console.log("handleViewLogs called for:",{productId:e,productName:s}),oe({id:e,name:s}),ie(!0),console.log("Logs modal should now be open")},Me=s=>{if(!de||!s)return{keywords:[],allMatch:!1,highlightComponent:s};const t=de.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0),r=s.toLowerCase(),a=t.every(e=>r.includes(e));return{keywords:t,allMatch:a,highlightComponent:e.jsx(G,{text:s,searchTerms:t,allMatch:a})}},ke=()=>{se(""),be(Ne)};return e.jsxs(X,{spacing:"lg",children:[e.jsxs(u,{children:[e.jsx(m,{children:e.jsxs("div",{className:"flex items-center "+(w.isMobile?"flex-col space-y-4":"justify-between"),children:[e.jsxs("div",{className:w.isMobile?"text-center":"",children:[e.jsxs(p,{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"w-6 h-6"}),e.jsx("span",{children:"Products"})]}),e.jsx(_,{className:w.isMobile?"text-center mt-2":"",children:"Manage your product inventory - Search across all product fields for similar items"})]}),e.jsxs("div",{className:"flex items-center space-x-2 "+(w.isMobile?"flex-col space-y-2 space-x-0 w-full":""),children:[e.jsx(d,{onClick:async()=>{confirm("Manually adjust all serial numbers to be continuous (1, 2, 3, etc.)? This will update all products based on their creation order.")&&(await Pe(),Se())},variant:"outline",className:"bg-purple-50 hover:bg-purple-100 text-purple-600 border-purple-200 "+(w.isMobile?"w-full":""),disabled:ye,children:ye?e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4 mr-2 animate-spin"}),"Adjusting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Fix Serial Numbers"]})}),D&&e.jsxs(d,{onClick:()=>x("/products/new"),className:"bg-brand-600 hover:bg-brand-700 text-white "+(w.isMobile?"w-full":""),children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),"Add Product"]}),!D&&C&&e.jsx(o,{variant:"secondary",className:"text-xs",children:"Create access disabled by admin"})]})]})}),e.jsxs(h,{children:[e.jsxs("div",{className:"flex items-center mb-6 "+(w.isMobile?"flex-col space-y-3":"space-x-2"),children:[e.jsxs("div",{className:"relative "+(w.isMobile?"w-full":"flex-1 max-w-sm"),children:[e.jsx(V,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),ee&&e.jsx("button",{onClick:ke,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 w-4 h-4 flex items-center justify-center",title:"Clear search",children:e.jsx(k,{className:"w-4 h-4"})}),e.jsx(y,{placeholder:w.isMobile?"Search products...":"Search products by name, description, category, supplier, barcode...",value:ee,onChange:e=>se(e.target.value),className:"pl-10 "+(ee?"pr-10":"pr-3")})]}),de&&e.jsxs("div",{className:"flex items-center space-x-2 "+(w.isMobile?"w-full justify-center":""),children:[e.jsxs(o,{variant:"secondary",children:[te," result",1!==te?"s":""," found"]}),e.jsx(d,{variant:"outline",size:"sm",onClick:ke,children:"Clear"})]})]}),E?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,t)=>e.jsx("div",{className:"bg-gray-100 rounded animate-pulse "+(w.isMobile?"h-32":"h-16")},t))}):0===I.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(S,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:de?`No products found matching "${de}"`:"No products found"}),e.jsx(d,{variant:"outline",className:"mt-4",onClick:()=>de?ke():D?x("/products/new"):null,disabled:!de&&!D,children:de?"Clear Search":D?"Add Your First Product":"No Create Permission"})]}):w.isMobile?e.jsx(Z,{products:I,searchTerm:de,onViewLogs:Fe,onSaveProduct:async(e=null)=>{console.log("handleSaveProduct called for product ID:",e);const s=null===e;if(!s||D)if(s||P){_e(e||-1);try{if(s){if(!confirm("Create a new product entry? This will add a new product with default values that you can edit."))return console.log("Product creation cancelled by user"),void _e(null);const{data:e}=await window.ezsite.apis.tablePage("11726",{PageNo:1,PageSize:1,OrderByField:"serial_number",IsAsc:!1,Filters:[]}),s=(e?.List?.[0]?.serial_number||0)+1,r={serial_number:s,product_name:`New Product ${s}`,category:"General",quantity_in_stock:0,minimum_stock:0,supplier:"",description:"Please update this product information",weight:0,weight_unit:"lb",department:"Convenience Store",merchant_id:null,bar_code_case:"",bar_code_unit:"",last_updated_date:(new Date).toISOString(),last_shopping_date:null,case_price:0,unit_per_case:1,unit_price:0,retail_price:0,overdue:!1,created_by:g?.user_id||null};console.log("Creating new product with data:",r);const{error:a}=await window.ezsite.apis.tableCreate("11726",r);if(a)throw console.error("API returned error:",a),a;console.log("New product created successfully with serial:",s),t({title:"Success",description:`New product created with serial #${s}. Please edit it to add complete information.`,duration:5e3}),await Pe()}else{const s=I.find(s=>s.ID===e);if(!s)throw new Error("Product not found");if(!confirm(`Save updates to "${s.product_name}"? This will update the product information with current values. Serial numbers will be automatically adjusted if needed.`))return console.log("Product update cancelled by user"),void _e(null);console.log("Updating product:",s);const r={ID:s.ID,product_name:s.product_name,category:s.category||"",quantity_in_stock:s.quantity_in_stock||0,minimum_stock:s.minimum_stock||0,supplier:s.supplier||"",description:s.description||"",serial_number:s.serial_number||0,weight:s.weight||0,weight_unit:s.weight_unit||"lb",department:s.department||"Convenience Store",merchant_id:s.merchant_id||null,bar_code_case:s.bar_code_case||"",bar_code_unit:s.bar_code_unit||"",last_updated_date:(new Date).toISOString(),last_shopping_date:s.last_shopping_date||null,case_price:s.case_price||0,unit_per_case:s.unit_per_case||1,unit_price:s.unit_price||0,retail_price:s.retail_price||0,overdue:s.overdue||!1,created_by:s.created_by||g?.user_id||null};console.log("Updating product with data:",r);const{error:a}=await window.ezsite.apis.tableUpdate("11726",r);if(a)throw console.error("API returned error:",a),a;console.log("Product updated successfully with ID:",s.ID),t({title:"Success",description:`"${s.product_name}" updated successfully`,duration:3e3}),await Pe()}Se()}catch(r){console.error("Error saving product:",r),t({title:"Error",description:`Failed to ${s?"create":"update"} product: ${r}`,variant:"destructive"})}finally{_e(null)}}else t({title:"Access Denied",description:"You don't have permission to edit products.",variant:"destructive"});else t({title:"Access Denied",description:"You don't have permission to create products.",variant:"destructive"})},onDeleteProduct:Ie,savingProductId:fe,userRole:g?.role}):e.jsx(H,{className:"border rounded-lg overflow-hidden",children:e.jsxs(r,{children:[e.jsx(a,{children:e.jsxs(i,{children:[e.jsx(n,{children:"Serial"}),e.jsx(n,{children:"Product Name"}),e.jsx(n,{children:"Weight"}),e.jsx(n,{children:"Department"}),e.jsx(n,{children:"Merchant"}),e.jsx(n,{children:"Last Updated Date"}),e.jsx(n,{children:"Last Shopping Date"}),e.jsx(n,{children:"Case Price"}),e.jsx(n,{children:"Unit Per Case"}),e.jsx(n,{children:"Unit Price"}),e.jsx(n,{children:"Retail Price"}),e.jsx(n,{children:"Profit Margin"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(l,{children:W(I,(s,r)=>{const a=e=>{if(!e)return"-";try{return new Date(e).toLocaleDateString()}catch{return"-"}};return e.jsxs(i,{children:[e.jsx(c,{className:"font-medium",children:s.serial_number||"-"}),e.jsx(c,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:de?Me(s.product_name).highlightComponent:s.product_name}),s.description&&e.jsx("p",{className:"text-sm text-gray-500 truncate max-w-xs",children:de?Me(s.description).highlightComponent:s.description})]})}),e.jsx(c,{children:s.weight&&s.weight>0?`${s.weight} ${s.weight_unit||"lb"}`:"-"}),e.jsx(c,{children:e.jsx(o,{variant:"outline",children:de?Me(s.department||"Convenience Store").highlightComponent:s.department||"Convenience Store"})}),e.jsx(c,{children:de?Me(s.supplier||"-").highlightComponent:s.supplier||"-"}),e.jsx(c,{children:a(s.last_updated_date)}),e.jsx(c,{children:a(s.last_shopping_date)}),e.jsx(c,{children:s.case_price?`$${s.case_price.toFixed(2)}`:"-"}),e.jsx(c,{children:s.unit_per_case||"-"}),e.jsx(c,{children:s.unit_price?`$${s.unit_price.toFixed(2)}`:"-"}),e.jsx(c,{children:s.retail_price?`$${s.retail_price.toFixed(2)}`:"-"}),e.jsx(c,{children:(()=>{if(s.unit_price&&s.retail_price&&s.retail_price>0){const t=(s.retail_price-s.unit_price)/s.retail_price*100;return e.jsxs(o,{variant:t>20?"default":t>10?"secondary":"destructive",className:"text-xs",children:[t.toFixed(1),"%"]})}return"-"})()}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center space-x-1",children:["Administrator"===g?.role||"Admin"===g?.role?e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{var e;console.log("Editing product:",s.ID),e=s.ID,console.log("handleEdit called for product ID:",e),"Administrator"===g?.role||"Admin"===g?.role?x(`/products/${e}/edit`):t({title:"Access Denied",description:"Only administrators can edit products.",variant:"destructive"})},title:"Edit product",className:"text-blue-600 hover:text-blue-700",children:e.jsx(R,{className:"w-4 h-4"})}):null,e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{var e,t;console.log("Viewing changelog for product:",s.ID,s.product_name),e=s.ID,t=s.product_name,console.log("handleViewChangelog called for:",{productId:e,productName:t}),oe({id:e,name:t}),le(!0),console.log("Changelog modal should now be open")},title:"View changelog",className:"text-green-600 hover:text-green-700",children:e.jsx(q,{className:"w-4 h-4"})}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{console.log("Viewing logs for product:",s.ID,s.product_name),Fe(s.ID,s.product_name)},title:"View change logs",children:e.jsx(F,{className:"w-4 h-4"})}),"Administrator"===g?.role||"Admin"===g?.role?e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{console.log("Deleting product:",s.ID),Ie(s.ID)},className:"text-red-600 hover:text-red-700",title:"Delete product",children:e.jsx(O,{className:"w-4 h-4"})}):null]})})]},Y(s,r,"product"))})})]})}),I.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-sm text-gray-700 text-center mb-4",children:(()=>{if(0===te)return"";const e=Math.min(I.length,te);return de?`Showing ${e} of ${te} products matching "${de}"`:he?`Showing ${e} of ${te} products - Scroll down to load more`:`Showing all ${te} products`})()}),he&&e.jsx("div",{ref:Ce,className:"flex items-center justify-center py-8",children:ge?e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx(U,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Loading more products..."})]}):e.jsx("div",{className:"text-gray-400 text-sm",children:"Scroll down to load more products"})}),!he&&te>Ne&&e.jsxs("div",{className:"text-center py-4 text-sm text-gray-500",children:["You've reached the end - all ",te," products loaded"]})]})]})]}),ce&&e.jsx(K,{isOpen:ae,onClose:()=>{ie(!1),oe(null)},productId:ce.id,productName:ce.name}),ce&&e.jsx(Q,{isOpen:ne,onClose:()=>{le(!1),oe(null)},productId:ce.id,productName:ce.name})]})};export{ee as default};
