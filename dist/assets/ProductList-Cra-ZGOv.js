import{j as e}from"./radix-ui-woSLwCdF.js";import{r as s}from"./react-core-CKNU0hQt.js";import{t,D as r,a,b as i,c as n,d as c,B as l,e as d,C as o,f as u,g as m,h,S as p,i as x,u as g,j,k as _,I as f}from"./index-mhPlV2HJ.js";import{T as y,a as N,b as v,c as w,d as b,e as C}from"./table-CifGLKnD.js";import{P as S,N as P,p as D,D as $,n as I,F,R as M,X as k,O as E,f as L,U as z,z as A,Q as U,V as O,W as T,Y as V,Z as R,_ as q}from"./utilities-BBdJI3Xi.js";import{u as B}from"./use-mobile-BQxxJ7Jh.js";import{s as W,g as Y}from"./invariantSafeHelper-CpdXj1Qs.js";import{u as Q}from"./routing-DcURAnU1.js";import"./data-management-r38r-ocq.js";import"./animations-CdlE0-Ca.js";const G=({isOpen:d,onClose:o,productId:u,productName:m})=>{const[h,p]=s.useState([]),[x,g]=s.useState(!1);s.useEffect(()=>{d&&u&&j()},[d,u]);const j=async()=>{try{g(!0),console.log("Loading product logs for product ID:",u);const{data:e,error:s}=await window.ezsite.apis.tablePage("11756",{PageNo:1,PageSize:100,OrderByField:"change_date",IsAsc:!1,Filters:[{name:"product_id",op:"Equal",value:u}]});if(s)throw console.error("API error loading logs:",s),s;console.log("Loaded logs:",e?.List||[]),p(e?.List||[])}catch(e){console.error("Error loading product logs:",e),t({title:"Error",description:`Failed to load product change logs: ${e}`,variant:"destructive"})}finally{g(!1)}},_=e=>{if(!e)return"-";try{return new Date(e).toLocaleString()}catch{return"-"}},f=(e,s)=>{if(!s||""===s)return"-";if(e.includes("price")||"profit_margin"===e){const e=parseFloat(s);if(!isNaN(e))return`$${e.toFixed(2)}`}if(e.includes("date"))try{return new Date(s).toLocaleDateString()}catch{return s}return s},F=s=>{switch(s){case"last_shopping_date":return e.jsx(I,{className:"w-4 h-4"});case"case_price":case"unit_price":case"retail_price":return e.jsx($,{className:"w-4 h-4"});case"unit_per_case":return e.jsx(S,{className:"w-4 h-4"});case"profit_margin":return e.jsx(D,{className:"w-4 h-4"});default:return null}},M=e=>{switch(e){case"last_shopping_date":return"Last Shopping Date";case"case_price":return"Case Price";case"unit_per_case":return"Unit Per Case";case"unit_price":return"Unit Price";case"retail_price":return"Retail Price";case"profit_margin":return"Profit Margin";default:return e.replace("_"," ").replace(/\b\w/g,e=>e.toUpperCase())}},k=e=>{switch(e){case"last_shopping_date":return"bg-blue-100 text-blue-800";case"case_price":return"bg-green-100 text-green-800";case"unit_per_case":return"bg-purple-100 text-purple-800";case"unit_price":return"bg-orange-100 text-orange-800";case"retail_price":return"bg-red-100 text-red-800";case"profit_margin":return"bg-yellow-100 text-yellow-800";default:return"bg-gray-100 text-gray-800"}};return e.jsx(r,{open:d,onOpenChange:o,children:e.jsxs(a,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[e.jsxs(i,{children:[e.jsxs(n,{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"w-5 h-5"}),e.jsx("span",{children:"Product Change Logs"})]}),e.jsxs(c,{children:["Change history for: ",e.jsx("span",{className:"font-medium",children:m})]})]}),e.jsx("div",{className:"mt-4",children:x?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,t)=>e.jsx("div",{className:"h-16 bg-gray-100 rounded animate-pulse"},t))}):0===h.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(S,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No change logs found for this product"}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Changes will appear here when product information is updated"})]}):e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(y,{children:[e.jsx(N,{children:e.jsxs(v,{children:[e.jsx(w,{children:"Field"}),e.jsx(w,{children:"Change Date"}),e.jsx(w,{children:"Old Value"}),e.jsx(w,{className:"text-center",children:"â†’"}),e.jsx(w,{children:"New Value"})]})}),e.jsx(b,{children:h.map(s=>e.jsxs(v,{children:[e.jsx(C,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[F(s.field_name),e.jsx(l,{className:k(s.field_name),children:M(s.field_name)})]})}),e.jsx(C,{className:"text-sm text-gray-600",children:_(s.change_date)}),e.jsx(C,{children:e.jsx("span",{className:"px-2 py-1 bg-red-50 text-red-700 rounded text-sm",children:f(s.field_name,s.old_value)})}),e.jsx(C,{className:"text-center",children:e.jsx(P,{className:"w-4 h-4 text-gray-400"})}),e.jsx(C,{children:e.jsx("span",{className:"px-2 py-1 bg-green-50 text-green-700 rounded text-sm",children:f(s.field_name,s.new_value)})})]},s.ID))})]})})})]})})},H=({isOpen:x,onClose:g,productId:j,productName:_})=>{const[f,y]=s.useState([]),[N,v]=s.useState(!1),[w,b]=s.useState({});s.useEffect(()=>{x&&j&&C()},[x,j]);const C=async()=>{v(!0);try{const{data:e,error:s}=await window.ezsite.apis.tablePage("24010",{PageNo:1,PageSize:100,OrderByField:"change_timestamp",IsAsc:!1,Filters:[{name:"product_id",op:"Equal",value:j}]});if(s)throw s;const t=e?.List||[];y(t);const r=[...new Set(t.map(e=>e.changed_by))];await S(r)}catch(e){console.error("Error fetching changelog:",e),t({title:"Error",description:"Failed to load changelog data",variant:"destructive"})}finally{v(!1)}},S=async e=>{try{const t={};for(const r of e)try{const{data:e,error:s}=await window.ezsite.apis.tablePage("11725",{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!0,Filters:[{name:"user_id",op:"Equal",value:r}]});if(!s&&e?.List?.[0]){const s=e.List[0];t[r]=`${s.employee_id||"Unknown"} (ID: ${r})`}else t[r]=`User ${r}`}catch(s){t[r]=`User ${r}`}b(t)}catch(s){console.error("Error fetching user names:",s)}},P=(e,s)=>{if(!s)return"Empty";if(e.includes("price")||"profit_margin"===e){const t=parseFloat(s);if(!isNaN(t))return"profit_margin"===e?`${t.toFixed(2)}%`:`$${t.toFixed(2)}`}if(e.includes("date"))try{return E(new Date(s),"MMM dd, yyyy")}catch{return s}return s},$=e=>{switch(e.toLowerCase()){case"create":return"bg-green-100 text-green-800";case"update":return"bg-blue-100 text-blue-800";case"delete":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},A=(s,t,r)=>{if(s.includes("price")){const s=parseFloat(t),a=parseFloat(r);if(!isNaN(s)&&!isNaN(a)){if(a>s)return e.jsx(D,{className:"w-4 h-4 text-green-600 inline ml-1"});if(a<s)return e.jsx(D,{className:"w-4 h-4 text-red-600 inline ml-1 rotate-180"})}}return null},U=(e=>{const s={};return e.forEach(e=>{const t=E(new Date(e.change_timestamp),"yyyy-MM-dd");s[t]||(s[t]=[]),s[t].push(e)}),Object.entries(s).sort(([e],[s])=>s.localeCompare(e))})(f);return e.jsx(r,{open:x,onOpenChange:g,children:e.jsxs(a,{className:"max-w-6xl max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsx(i,{className:"flex-shrink-0",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(n,{className:"flex items-center space-x-2",children:[e.jsx(F,{className:"w-5 h-5"}),e.jsx("span",{children:"Product Changelog"})]}),e.jsxs(c,{children:["Change history for ",e.jsx("strong",{children:_})," (Product ID: ",j,")"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:C,disabled:N,className:"flex items-center space-x-1",children:[e.jsx(M,{className:"w-4 h-4 "+(N?"animate-spin":"")}),e.jsx("span",{children:"Refresh"})]}),e.jsx(d,{variant:"outline",size:"sm",onClick:g,children:e.jsx(k,{className:"w-4 h-4"})})]})]})}),e.jsx("div",{className:"flex-1 overflow-auto space-y-4",children:N?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Loading changelog..."})]})}):0===f.length?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(F,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No Changes Found"}),e.jsx("p",{className:"text-gray-500",children:"This product has no recorded changes yet."})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(o,{children:[e.jsx(u,{children:e.jsx(m,{className:"text-lg",children:"Change Summary"})}),e.jsx(h,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:f.length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Total Changes"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:f.filter(e=>"create"===e.change_type).length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Created"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:f.filter(e=>"update"===e.change_type).length}),e.jsx("div",{className:"text-sm text-gray-500",children:"Updated"})]})]})})]}),e.jsx("div",{className:"space-y-4",children:U.map(([s,t])=>e.jsxs(o,{children:[e.jsx(u,{children:e.jsxs(m,{className:"flex items-center space-x-2 text-base",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{children:E(new Date(s),"EEEE, MMMM dd, yyyy")}),e.jsxs(l,{variant:"secondary",children:[t.length," changes"]})]})}),e.jsx(h,{children:e.jsx("div",{className:"space-y-3",children:t.map(s=>{return e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(l,{className:$(s.change_type),children:s.change_type.toUpperCase()}),e.jsx("span",{className:"font-medium",children:(t=s.field_name,{last_shopping_date:"Last Shopping Date",case_price:"Case Price",unit_per_case:"Unit Per Case",unit_price:"Unit Price",retail_price:"Retail Price",profit_margin:"Profit Margin",product_name:"Product Name",category:"Category",supplier:"Supplier",weight:"Weight",weight_unit:"Weight Unit",department:"Department",description:"Description",quantity_in_stock:"Stock Quantity",minimum_stock:"Minimum Stock"}[t]||t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()))})]}),e.jsxs("div",{className:"text-sm text-gray-500 flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(L,{className:"w-3 h-3"}),e.jsx("span",{children:E(new Date(s.change_timestamp),"h:mm aa")})]}),e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(z,{className:"w-3 h-3"}),e.jsx("span",{children:w[s.changed_by]||`User ${s.changed_by}`})]})]})]}),"update"===s.change_type&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 mb-1",children:"Previous Value:"}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded px-3 py-2",children:P(s.field_name,s.old_value)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-gray-500 mb-1",children:"New Value:"}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded px-3 py-2 flex items-center",children:[P(s.field_name,s.new_value),A(s.field_name,s.old_value,s.new_value)]})]})]}),"create"===s.change_type&&e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"text-gray-500 mb-1",children:"Initial Value:"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded px-3 py-2",children:P(s.field_name,s.new_value)})]}),s.change_summary&&e.jsxs("div",{className:"mt-3 text-sm text-gray-600",children:[e.jsx("strong",{children:"Summary:"})," ",s.change_summary]})]},s.ID);var t})})})]},s))})]})}),e.jsx(p,{className:"my-4"}),e.jsx("div",{className:"flex justify-end space-x-2 flex-shrink-0",children:e.jsx(d,{variant:"outline",onClick:g,children:"Close"})})]})})},Z=({text:s,searchTerms:t,allMatch:r})=>{if(!t.length||!s)return e.jsx(e.Fragment,{children:s});const a=t.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")),i=new RegExp(`(${a.join("|")})`,"gi"),n=s.split(i);return e.jsx(e.Fragment,{children:n.map((s,a)=>t.some(e=>s.toLowerCase()===e.toLowerCase())?e.jsx("span",{className:"font-semibold "+(r?"bg-green-200 text-green-800":"bg-yellow-200 text-yellow-800"),children:s},a):s)})},J=({children:s,className:t="",fallbackComponent:r})=>{const a=B();return a.isMobile&&r?e.jsx(e.Fragment,{children:r}):e.jsx("div",{className:x("overflow-x-auto",a.isMobile&&"overflow-x-scroll",t),children:s})},K=({children:s,className:t="",spacing:r="md"})=>{const a=B(),i=x("flex flex-col",{sm:"space-y-2 sm:space-y-3",md:"space-y-4 sm:space-y-6",lg:"space-y-6 sm:space-y-8"}[r],a.isMobile&&"px-1",t);return e.jsx("div",{className:i,children:s})},X=({products:s,searchTerm:t,onViewLogs:r,onSaveProduct:a,onDeleteProduct:i,savingProductId:n,userRole:c})=>{const p=e=>{if(!e)return"-";try{return new Date(e).toLocaleDateString()}catch{return"-"}},x=s=>{if(!t||!s)return{keywords:[],allMatch:!1,highlightComponent:s};const r=t.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0),a=s.toLowerCase(),i=r.every(e=>a.includes(e));return{keywords:r,allMatch:i,highlightComponent:e.jsx(Z,{text:s,searchTerms:r,allMatch:i})}};return e.jsx("div",{className:"grid grid-cols-1 gap-4",children:s.map(s=>{const g=(e=>{if(e.unit_price&&e.retail_price&&e.retail_price>0){const s=(e.retail_price-e.unit_price)/e.retail_price*100;return{value:s,variant:s>20?"default":s>10?"secondary":"destructive"}}return null})(s);return e.jsxs(o,{className:"hover:shadow-md transition-shadow",children:[e.jsxs(u,{className:"pb-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(m,{className:"text-lg leading-tight",children:t?x(s.product_name).highlightComponent:s.product_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsxs(l,{variant:"outline",className:"text-xs",children:["#",s.serial_number||"-"]}),e.jsx(l,{variant:"outline",className:"text-xs",children:t?x(s.department||"Convenience Store").highlightComponent:s.department||"Convenience Store"})]})]}),e.jsxs("div",{className:"flex items-center space-x-1 ml-2",children:[e.jsx(d,{variant:"outline",size:"sm",onClick:()=>r(s.ID,s.product_name),className:"p-2",title:"View logs",children:e.jsx(F,{className:"w-4 h-4"})}),("Administrator"===c||"Admin"===c)&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>a(s.ID),disabled:n===s.ID,className:"p-2",title:"Save product",children:n===s.ID?e.jsx(A,{className:"w-4 h-4 animate-spin"}):e.jsx(U,{className:"w-4 h-4"})}),("Administrator"===c||"Admin"===c)&&e.jsx(d,{variant:"outline",size:"sm",onClick:()=>i(s.ID),className:"p-2 text-red-600 hover:text-red-700",title:"Delete product",children:e.jsx(O,{className:"w-4 h-4"})})]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-2 line-clamp-2",children:t?x(s.description).highlightComponent:s.description})]}),e.jsxs(h,{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Unit Price:"}),e.jsx("div",{className:"font-medium",children:s.unit_price?`$${s.unit_price.toFixed(2)}`:"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Retail Price:"}),e.jsx("div",{className:"font-medium",children:s.retail_price?`$${s.retail_price.toFixed(2)}`:"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Case Price:"}),e.jsx("div",{className:"font-medium",children:s.case_price?`$${s.case_price.toFixed(2)}`:"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Profit Margin:"}),e.jsx("div",{className:"font-medium",children:g?e.jsxs(l,{variant:g.variant,className:"text-xs",children:[g.value.toFixed(1),"%"]}):"-"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-2 text-sm border-t pt-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Weight:"}),e.jsx("span",{className:"font-medium",children:s.weight&&s.weight>0?`${s.weight} ${s.weight_unit||"lb"}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Supplier:"}),e.jsx("span",{className:"font-medium truncate ml-2",children:t?x(s.supplier||"-").highlightComponent:s.supplier||"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Unit per Case:"}),e.jsx("span",{className:"font-medium",children:s.unit_per_case||"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Last Updated:"}),e.jsx("span",{className:"font-medium",children:p(s.last_updated_date)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"Last Shopping:"}),e.jsx("span",{className:"font-medium",children:p(s.last_shopping_date)})]})]})]})]},s.ID)})})},ee=()=>{const r=Q(),{userProfile:a}=g(),i=B(),{canCreate:n,canEdit:c,canDelete:p,isModuleAccessEnabled:x}=j(),P=n("products"),D=c("products");p("products");const[$,I]=s.useState([]),[E,L]=s.useState([]),[z,U]=s.useState(!0),[ee,se]=s.useState(""),[te,re]=s.useState(0),[ae,ie]=s.useState(!1),[ne,ce]=s.useState(!1),[le,de]=s.useState(null),[oe,ue]=s.useState(""),[me,he]=s.useState(!1),[pe,xe]=s.useState(!0),[ge,je]=s.useState(!1),[_e,fe]=s.useState(null),[ye,Ne]=s.useState(!1),ve=50,[we,be]=s.useState(ve),Ce=s.useRef(null);s.useEffect(()=>{const e=setTimeout(()=>{ue(ee),be(ve)},300);return()=>clearTimeout(e)},[ee,ve]),s.useEffect(()=>{Se()},[]),s.useEffect(()=>{Pe()},[oe,we,E]);const Se=async()=>{try{U(!0);const{data:e,error:s}=await window.ezsite.apis.tablePage("11726",{PageNo:1,PageSize:1e3,OrderByField:"ID",IsAsc:!1,Filters:[]});if(s)throw console.error("Error loading products:",s),s;L(e?.List||[])}catch(e){console.error("Error loading products:",e),t({title:"Error",description:`Failed to load products: ${e}`,variant:"destructive"})}finally{U(!1)}},Pe=()=>{he(!!oe);let e=E;if(oe){const s=oe.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0);e=E.filter(e=>{const t=[e.product_name,e.description,e.category,e.supplier,e.department,e.bar_code_case,e.bar_code_unit,e.serial_number?.toString()].join(" ").toLowerCase();return s.every(e=>t.includes(e))})}oe||(e=e.sort((e,s)=>(e.serial_number||0)-(s.serial_number||0)));const s=e.slice(0,we);I(s),re(e.length),xe(we<e.length)},De=async()=>{try{Ne(!0);const{data:e,error:s}=await window.ezsite.apis.tablePage("11726",{PageNo:1,PageSize:1e3,OrderByField:"ID",IsAsc:!0,Filters:[]});if(s)throw s;const r=e?.List||[];let i=!1;for(let t=0;t<r.length;t++){const e=t+1;if(r[t].serial_number!==e){i=!0;break}}if(!i)return;const n=r.map(async(e,s)=>{const t=s+1;if(e.serial_number!==t){const s={ID:e.ID,serial_number:t,product_name:e.product_name,category:e.category||"",quantity_in_stock:e.quantity_in_stock||0,minimum_stock:e.minimum_stock||0,supplier:e.supplier||"",description:e.description||"",weight:e.weight||0,weight_unit:e.weight_unit||"lb",department:e.department||"Convenience Store",merchant_id:e.merchant_id||null,bar_code_case:e.bar_code_case||"",bar_code_unit:e.bar_code_unit||"",last_updated_date:(new Date).toISOString(),last_shopping_date:e.last_shopping_date||null,case_price:e.case_price||0,unit_per_case:e.unit_per_case||1,unit_price:e.unit_price||0,retail_price:e.retail_price||0,overdue:e.overdue||!1,created_by:e.created_by||a?.user_id||null},{error:r}=await window.ezsite.apis.tableUpdate("11726",s);if(r)throw console.error("Error updating product serial:",r),r}});await Promise.all(n),t({title:"Serial Numbers Updated",description:"Product serial numbers have been automatically adjusted to maintain continuity.",duration:3e3})}catch(e){console.error("Error adjusting serial numbers:",e),t({title:"Warning",description:"Failed to auto-adjust serial numbers. Please check the system logs.",variant:"destructive",duration:5e3})}finally{Ne(!1)}},$e=async e=>{if("admin"!==a?.role)return void t({title:"Access Denied",description:"Only administrators can delete products.",variant:"destructive"});if(confirm("Are you sure you want to delete this product? This action cannot be undone. Serial numbers will be automatically adjusted to maintain continuity."))try{const{error:s}=await window.ezsite.apis.tableDelete("11726",{ID:e});if(s)throw console.error("Error deleting product:",s),s;t({title:"Success",description:"Product deleted successfully. Adjusting serial numbers...",duration:2e3}),await De(),Se()}catch(s){console.error("Error deleting product:",s),t({title:"Error",description:`Failed to delete product: ${s}`,variant:"destructive"})}},Ie=s.useCallback(()=>{!ge&&pe&&(je(!0),setTimeout(()=>{be(e=>e+ve),je(!1)},300))},[ge,pe,ve]);s.useEffect(()=>{const e=new IntersectionObserver(e=>{e[0].isIntersecting&&pe&&!ge&&Ie()},{threshold:.1,rootMargin:"100px"}),s=Ce.current;return s&&e.observe(s),()=>{s&&e.unobserve(s)}},[Ie,pe,ge]);const Fe=(e,s)=>{de({id:e,name:s}),ie(!0)},Me=s=>{if(!oe||!s)return{keywords:[],allMatch:!1,highlightComponent:s};const t=oe.toLowerCase().trim().split(/\s+/).filter(e=>e.length>0),r=s.toLowerCase(),a=t.every(e=>r.includes(e));return{keywords:t,allMatch:a,highlightComponent:e.jsx(Z,{text:s,searchTerms:t,allMatch:a})}},ke=()=>{se(""),be(ve)};return e.jsxs(K,{spacing:"lg",children:[e.jsxs(o,{children:[e.jsx(u,{children:e.jsxs("div",{className:"flex items-center "+(i.isMobile?"flex-col space-y-4":"justify-between"),children:[e.jsxs("div",{className:i.isMobile?"text-center":"",children:[e.jsxs(m,{className:"flex items-center space-x-2",children:[e.jsx(S,{className:"w-6 h-6"}),e.jsx("span",{children:"Products"})]}),e.jsx(_,{className:i.isMobile?"text-center mt-2":"",children:"Manage your product inventory - Search across all product fields for similar items"})]}),e.jsxs("div",{className:"flex items-center space-x-2 "+(i.isMobile?"flex-col space-y-2 space-x-0 w-full":""),children:[e.jsx(d,{onClick:async()=>{confirm("Manually adjust all serial numbers to be continuous (1, 2, 3, etc.)? This will update all products based on their creation order.")&&(await De(),Se())},variant:"outline",className:"bg-purple-50 hover:bg-purple-100 text-purple-600 border-purple-200 "+(i.isMobile?"w-full":""),disabled:ye,children:ye?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2 animate-spin"}),"Adjusting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Fix Serial Numbers"]})}),P&&e.jsxs(d,{onClick:()=>r("/products/new"),className:"bg-brand-600 hover:bg-brand-700 text-white "+(i.isMobile?"w-full":""),children:[e.jsx(T,{className:"w-4 h-4 mr-2"}),"Add Product"]}),!P&&x&&e.jsx(l,{variant:"secondary",className:"text-xs",children:"Create access disabled by admin"})]})]})}),e.jsxs(h,{children:[e.jsxs("div",{className:"flex items-center mb-6 "+(i.isMobile?"flex-col space-y-3":"space-x-2"),children:[e.jsxs("div",{className:"relative "+(i.isMobile?"w-full":"flex-1 max-w-sm"),children:[e.jsx(V,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),ee&&e.jsx("button",{onClick:ke,className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 w-4 h-4 flex items-center justify-center",title:"Clear search",children:e.jsx(k,{className:"w-4 h-4"})}),e.jsx(f,{placeholder:i.isMobile?"Search products...":"Search products by name, description, category, supplier, barcode...",value:ee,onChange:e=>se(e.target.value),className:"pl-10 "+(ee?"pr-10":"pr-3")})]}),oe&&e.jsxs("div",{className:"flex items-center space-x-2 "+(i.isMobile?"w-full justify-center":""),children:[e.jsxs(l,{variant:"secondary",children:[te," result",1!==te?"s":""," found"]}),e.jsx(d,{variant:"outline",size:"sm",onClick:ke,children:"Clear"})]})]}),z?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,t)=>e.jsx("div",{className:"bg-gray-100 rounded animate-pulse "+(i.isMobile?"h-32":"h-16")},t))}):0===$.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(S,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:oe?`No products found matching "${oe}"`:"No products found"}),e.jsx(d,{variant:"outline",className:"mt-4",onClick:()=>oe?ke():P?r("/products/new"):null,disabled:!oe&&!P,children:oe?"Clear Search":P?"Add Your First Product":"No Create Permission"})]}):i.isMobile?e.jsx(X,{products:$,searchTerm:oe,onViewLogs:Fe,onSaveProduct:async(e=null)=>{const s=null===e;if(!s||P)if(s||D){fe(e||-1);try{if(s){if(!confirm("Create a new product entry? This will add a new product with default values that you can edit."))return void fe(null);const{data:e}=await window.ezsite.apis.tablePage("11726",{PageNo:1,PageSize:1,OrderByField:"serial_number",IsAsc:!1,Filters:[]}),s=(e?.List?.[0]?.serial_number||0)+1,r={serial_number:s,product_name:`New Product ${s}`,category:"General",quantity_in_stock:0,minimum_stock:0,supplier:"",description:"Please update this product information",weight:0,weight_unit:"lb",department:"Convenience Store",merchant_id:null,bar_code_case:"",bar_code_unit:"",last_updated_date:(new Date).toISOString(),last_shopping_date:null,case_price:0,unit_per_case:1,unit_price:0,retail_price:0,overdue:!1,created_by:a?.user_id||null},{error:i}=await window.ezsite.apis.tableCreate("11726",r);if(i)throw console.error("Error creating product:",i),i;t({title:"Success",description:`New product created with serial #${s}. Please edit it to add complete information.`,duration:5e3}),await De()}else{const s=$.find(s=>s.ID===e);if(!s)throw new Error("Product not found");if(!confirm(`Save updates to "${s.product_name}"? This will update the product information with current values. Serial numbers will be automatically adjusted if needed.`))return void fe(null);const r={ID:s.ID,product_name:s.product_name,category:s.category||"",quantity_in_stock:s.quantity_in_stock||0,minimum_stock:s.minimum_stock||0,supplier:s.supplier||"",description:s.description||"",serial_number:s.serial_number||0,weight:s.weight||0,weight_unit:s.weight_unit||"lb",department:s.department||"Convenience Store",merchant_id:s.merchant_id||null,bar_code_case:s.bar_code_case||"",bar_code_unit:s.bar_code_unit||"",last_updated_date:(new Date).toISOString(),last_shopping_date:s.last_shopping_date||null,case_price:s.case_price||0,unit_per_case:s.unit_per_case||1,unit_price:s.unit_price||0,retail_price:s.retail_price||0,overdue:s.overdue||!1,created_by:s.created_by||a?.user_id||null},{error:i}=await window.ezsite.apis.tableUpdate("11726",r);if(i)throw console.error("Error updating product:",i),i;t({title:"Success",description:`"${s.product_name}" updated successfully`,duration:3e3}),await De()}Se()}catch(r){console.error("Error saving product:",r),t({title:"Error",description:`Failed to ${s?"create":"update"} product: ${r}`,variant:"destructive"})}finally{fe(null)}}else t({title:"Access Denied",description:"You don't have permission to edit products.",variant:"destructive"});else t({title:"Access Denied",description:"You don't have permission to create products.",variant:"destructive"})},onDeleteProduct:$e,savingProductId:_e,userRole:a?.role}):e.jsx(J,{className:"border rounded-lg overflow-hidden",children:e.jsxs(y,{children:[e.jsx(N,{children:e.jsxs(v,{children:[e.jsx(w,{children:"Serial"}),e.jsx(w,{children:"Product Name"}),e.jsx(w,{children:"Weight"}),e.jsx(w,{children:"Department"}),e.jsx(w,{children:"Merchant"}),e.jsx(w,{children:"Last Updated Date"}),e.jsx(w,{children:"Last Shopping Date"}),e.jsx(w,{children:"Case Price"}),e.jsx(w,{children:"Unit Per Case"}),e.jsx(w,{children:"Unit Price"}),e.jsx(w,{children:"Retail Price"}),e.jsx(w,{children:"Profit Margin"}),e.jsx(w,{children:"Actions"})]})}),e.jsx(b,{children:W($,(s,i)=>{const n=e=>{if(!e)return"-";try{return new Date(e).toLocaleDateString()}catch{return"-"}};return e.jsxs(v,{children:[e.jsx(C,{className:"font-medium",children:s.serial_number||"-"}),e.jsx(C,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:oe?Me(s.product_name).highlightComponent:s.product_name}),s.description&&e.jsx("p",{className:"text-sm text-gray-500 truncate max-w-xs",children:oe?Me(s.description).highlightComponent:s.description})]})}),e.jsx(C,{children:s.weight&&s.weight>0?`${s.weight} ${s.weight_unit||"lb"}`:"-"}),e.jsx(C,{children:e.jsx(l,{variant:"outline",children:oe?Me(s.department||"Convenience Store").highlightComponent:s.department||"Convenience Store"})}),e.jsx(C,{children:oe?Me(s.supplier||"-").highlightComponent:s.supplier||"-"}),e.jsx(C,{children:n(s.last_updated_date)}),e.jsx(C,{children:n(s.last_shopping_date)}),e.jsx(C,{children:s.case_price?`$${s.case_price.toFixed(2)}`:"-"}),e.jsx(C,{children:s.unit_per_case||"-"}),e.jsx(C,{children:s.unit_price?`$${s.unit_price.toFixed(2)}`:"-"}),e.jsx(C,{children:s.retail_price?`$${s.retail_price.toFixed(2)}`:"-"}),e.jsx(C,{children:(()=>{if(s.unit_price&&s.retail_price&&s.retail_price>0){const t=(s.retail_price-s.unit_price)/s.retail_price*100;return e.jsxs(l,{variant:t>20?"default":t>10?"secondary":"destructive",className:"text-xs",children:[t.toFixed(1),"%"]})}return"-"})()}),e.jsx(C,{children:e.jsxs("div",{className:"flex items-center space-x-1",children:["admin"===a?.role?e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{return e=s.ID,console.log("handleEdit called for product ID:",e),void("admin"===a?.role?r(`/products/${e}/edit`):t({title:"Access Denied",description:"Only administrators can edit products.",variant:"destructive"}));var e},title:"Edit product",className:"text-blue-600 hover:text-blue-700",children:e.jsx(R,{className:"w-4 h-4"})}):null,e.jsx(d,{variant:"outline",size:"sm",onClick:()=>{return e=s.ID,t=s.product_name,de({id:e,name:t}),void ce(!0);var e,t},title:"View changelog",className:"text-green-600 hover:text-green-700",children:e.jsx(q,{className:"w-4 h-4"})}),e.jsx(d,{variant:"outline",size:"sm",onClick:()=>Fe(s.ID,s.product_name),title:"View change logs",children:e.jsx(F,{className:"w-4 h-4"})}),"admin"===a?.role?e.jsx(d,{variant:"outline",size:"sm",onClick:()=>$e(s.ID),className:"text-red-600 hover:text-red-700",title:"Delete product",children:e.jsx(O,{className:"w-4 h-4"})}):null]})})]},Y(s,i,"product"))})})]})}),$.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("p",{className:"text-sm text-gray-700 text-center mb-4",children:(()=>{if(0===te)return"";const e=Math.min($.length,te);return oe?`Showing ${e} of ${te} products matching "${oe}"`:pe?`Showing ${e} of ${te} products - Scroll down to load more`:`Showing all ${te} products`})()}),pe&&e.jsx("div",{ref:Ce,className:"flex items-center justify-center py-8",children:ge?e.jsxs("div",{className:"flex items-center space-x-2 text-gray-500",children:[e.jsx(A,{className:"w-5 h-5 animate-spin"}),e.jsx("span",{children:"Loading more products..."})]}):e.jsx("div",{className:"text-gray-400 text-sm",children:"Scroll down to load more products"})}),!pe&&te>ve&&e.jsxs("div",{className:"text-center py-4 text-sm text-gray-500",children:["You've reached the end - all ",te," products loaded"]})]})]})]}),le&&e.jsx(G,{isOpen:ae,onClose:()=>{ie(!1),de(null)},productId:le.id,productName:le.name}),le&&e.jsx(H,{isOpen:ne,onClose:()=>{ce(!1),de(null)},productId:le.id,productName:le.name})]})};export{ee as default};
