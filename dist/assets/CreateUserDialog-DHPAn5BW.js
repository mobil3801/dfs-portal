import{j as e}from"./radix-ui-Crli8-Dx.js";import{r as s}from"./react-core-CKNU0hQt.js";import{D as a,a as r,b as t,c as i}from"./dialog-W_eRI_WK.js";import{n as l,C as o,i as n,L as d,I as c,f as m,B as h,A as p,m as x}from"./index-CNwujOOT.js";import{S as u,c as j,d as g,a as f,b as v}from"./select-Cf4csPfA.js";import{U as w,r as y,v as N,w as b,a8 as A,d as L,a9 as S,x as C}from"./utilities-BH0DC7Sl.js";const _=({isOpen:_,onClose:E,onUserCreated:F})=>{const{toast:D}=l(),[P,$]=s.useState(!1),[O,I]=s.useState(!1),[M,U]=s.useState({email:"",password:"",firstName:"",lastName:"",phone:"",role:"Employee",station:"MOBIL",employee_id:"",hire_date:(new Date).toISOString().split("T")[0]}),k=(e,s)=>{U(a=>({...a,[e]:s}))},q=()=>{P||E()},T=s=>"ALL"===s?e.jsx(S,{className:"w-4 h-4"}):e.jsx(A,{className:"w-4 h-4"});return e.jsx(a,{open:_,onOpenChange:q,children:e.jsxs(r,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(t,{children:e.jsxs(i,{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{children:"Create New User"})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(o,{children:e.jsxs(n,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(y,{className:"w-4 h-4 text-blue-600"}),e.jsx("h3",{className:"font-semibold",children:"Account Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"email",children:"Email Address *"}),e.jsx(c,{id:"email",type:"email",value:M.email,onChange:e=>k("email",e.target.value),placeholder:"user@example.com",required:!0,disabled:P})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"password",children:"Password *"}),e.jsxs("div",{className:"relative",children:[e.jsx(c,{id:"password",type:O?"text":"password",value:M.password,onChange:e=>k("password",e.target.value),placeholder:"Enter password",required:!0,disabled:P}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",className:"absolute right-0 top-0 h-full px-3 hover:bg-transparent",onClick:()=>I(!O),disabled:P,children:O?e.jsx(N,{className:"w-4 h-4"}):e.jsx(b,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex space-x-2 mt-2",children:e.jsx(m,{type:"button",variant:"outline",size:"sm",onClick:()=>k("password",(()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";let s="";for(let a=0;a<12;a++)s+=e.charAt(Math.floor(70*Math.random()));return s})()),disabled:P,children:"Generate Password"})})]})]})]})}),e.jsx(o,{children:e.jsxs(n,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(w,{className:"w-4 h-4 text-green-600"}),e.jsx("h3",{className:"font-semibold",children:"Personal Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"firstName",children:"First Name *"}),e.jsx(c,{id:"firstName",value:M.firstName,onChange:e=>k("firstName",e.target.value),placeholder:"John",required:!0,disabled:P})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"lastName",children:"Last Name *"}),e.jsx(c,{id:"lastName",value:M.lastName,onChange:e=>k("lastName",e.target.value),placeholder:"Doe",required:!0,disabled:P})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"phone",children:"Phone Number *"}),e.jsx(c,{id:"phone",type:"tel",value:M.phone,onChange:e=>k("phone",e.target.value),placeholder:"(555) 123-4567",required:!0,disabled:P})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"hire_date",children:"Hire Date"}),e.jsx(c,{id:"hire_date",type:"date",value:M.hire_date,onChange:e=>k("hire_date",e.target.value),disabled:P})]})]})]})}),e.jsx(o,{children:e.jsxs(n,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(A,{className:"w-4 h-4 text-purple-600"}),e.jsx("h3",{className:"font-semibold",children:"Work Information"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(d,{htmlFor:"role",children:"Role *"}),e.jsxs(u,{value:M.role,onValueChange:e=>k("role",e),disabled:P,children:[e.jsx(j,{children:e.jsx(g,{placeholder:"Select role"})}),e.jsx(f,{children:["Administrator","Management","Employee"].map(s=>e.jsx(v,{value:s,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{className:"w-4 h-4"}),e.jsx("span",{children:s})]})},s))})]})]}),e.jsxs("div",{children:[e.jsx(d,{htmlFor:"station",children:"Station *"}),e.jsxs(u,{value:M.station,onValueChange:e=>k("station",e),disabled:P,children:[e.jsx(j,{children:e.jsx(g,{placeholder:"Select station"})}),e.jsx(f,{children:["ALL","MOBIL","AMOCO ROSEDALE","AMOCO BROOKLYN"].map(s=>e.jsx(v,{value:s,children:e.jsxs("div",{className:"flex items-center space-x-2",children:[T(s),e.jsx("span",{children:"ALL"===s?"ALL STATIONS":s})]})},s))})]}),"ALL"===M.station&&e.jsx("div",{className:"mt-2 p-2 bg-blue-50 border border-blue-200 rounded-md",children:e.jsxs("p",{className:"text-xs text-blue-700",children:[e.jsx(S,{className:"w-3 h-3 inline mr-1"}),"This user will have access to data from all stations based on their role permissions."]})})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(d,{htmlFor:"employee_id",children:"Employee ID *"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(c,{id:"employee_id",value:M.employee_id,onChange:e=>k("employee_id",e.target.value),placeholder:"EMP-123456",required:!0,disabled:P}),e.jsx(m,{type:"button",variant:"outline",onClick:()=>k("employee_id",`${"ALL"===M.station?"ALL":M.station.split(" ")[0].substring(0,3).toUpperCase()}-${Date.now().toString().slice(-6)}`),disabled:P,children:"Generate"})]})]})]})]})}),e.jsx(o,{children:e.jsxs(n,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(L,{className:"w-4 h-4 text-orange-600"}),e.jsx("h3",{className:"font-semibold",children:"Permissions Preview"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Dashboard Access"}),e.jsx(h,{variant:"default",children:"Granted"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Sales Reports"}),e.jsx(h,{variant:"Employee"!==M.role?"default":"secondary",children:"Employee"!==M.role?"Full Access":"View Only"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"User Management"}),e.jsx(h,{variant:"admin"===M.role?"default":"secondary",children:"admin"===M.role?"Full Access":"No Access"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"System Administration"}),e.jsx(h,{variant:"admin"===M.role?"default":"secondary",children:"admin"===M.role?"Full Access":"No Access"})]}),"ALL"===M.station&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Station Access"}),e.jsxs(h,{variant:"default",className:"bg-blue-600",children:[e.jsx(S,{className:"w-3 h-3 mr-1"}),"All Stations"]})]})]}),e.jsx(p,{className:"mt-4",children:e.jsxs(x,{className:"text-sm",children:["Permissions can be customized after user creation through the User Management interface.","ALL"===M.station&&e.jsxs("span",{className:"block mt-2 text-blue-700",children:[e.jsx("strong",{children:"Note:"})," Multi-station access allows this user to work with data from all stations according to their role permissions."]})]})})]})}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[e.jsx(m,{variant:"outline",onClick:q,disabled:P,children:"Cancel"}),e.jsx(m,{onClick:async()=>{const e=M.email&&M.email.includes("@")?!M.password||M.password.length<8?"Password must be at least 8 characters long":M.firstName.trim()?M.lastName.trim()?M.phone.trim()?M.employee_id.trim()?null:"Employee ID is required":"Phone number is required":"Last name is required":"First name is required":"Please enter a valid email address";if(e)D({title:"Validation Error",description:e,variant:"destructive"});else{$(!0);try{console.log("Starting user creation process..."),console.log("Registering user with email:",M.email);const{error:e}=await window.ezsite.apis.register({email:M.email,password:M.password});if(e)throw console.error("Authentication registration failed:",e),new Error(`Failed to create user account: ${e}`);let r;console.log("User authentication account created successfully");let t=0;const i=5;for(;t<i;)try{const{data:e,error:s}=await window.ezsite.apis.getUserInfo();if(!s&&e){r=e;break}t++,t<i&&await new Promise(e=>setTimeout(e,1e3))}catch(s){console.log(`Retry ${t+1} failed:`,s),t++,t<i&&await new Promise(e=>setTimeout(e,1e3))}if(!r)throw console.error("Failed to get user info after registration"),new Error("User was created but profile setup failed. Please try to create the profile manually.");console.log("Retrieved user info:",r);const l={user_id:r.ID,role:M.role,station:M.station,employee_id:M.employee_id,phone:M.phone,hire_date:M.hire_date,is_active:!0,detailed_permissions:JSON.stringify({dashboard:{view:!0,create:!1,edit:!1,delete:!1},products:{view:"employee"!==M.role,create:!1,edit:!1,delete:!1},employees:{view:"admin"===M.role,create:!1,edit:!1,delete:!1},sales_reports:{view:!0,create:"employee"!==M.role,edit:"employee"!==M.role,delete:!1},vendors:{view:"Employee"!==M.role,create:!1,edit:!1,delete:!1},orders:{view:"Employee"!==M.role,create:"Employee"!==M.role,edit:"Employee"!==M.role,delete:!1},licenses:{view:"employee"!==M.role,create:!1,edit:!1,delete:!1},salary:{view:"admin"===M.role,create:"admin"===M.role,edit:"admin"===M.role,delete:!1},inventory:{view:!0,create:"employee"!==M.role,edit:"employee"!==M.role,delete:!1},delivery:{view:"employee"!==M.role,create:"employee"!==M.role,edit:"employee"!==M.role,delete:!1},settings:{view:"admin"===M.role,create:!1,edit:"admin"===M.role,delete:!1},user_management:{view:"admin"===M.role,create:"admin"===M.role,edit:"admin"===M.role,delete:"admin"===M.role},site_management:{view:"admin"===M.role,create:"admin"===M.role,edit:"admin"===M.role,delete:"admin"===M.role},system_logs:{view:"admin"===M.role,create:!1,edit:!1,delete:!1},security_settings:{view:"admin"===M.role,create:!1,edit:"admin"===M.role,delete:!1}})};console.log("Creating user profile with data:",l);const{error:o}=await window.ezsite.apis.tableCreate(11725,l);if(o)throw console.error("Profile creation failed:",o),new Error(`Failed to create user profile: ${o}`);console.log("User profile created successfully in production database");try{const e="ALL"===M.station?"All Stations":M.station,s=`\n          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">\n            <h2 style="color: #1f2937;">Welcome to DFS Manager Portal</h2>\n            <p>Hello ${M.firstName} ${M.lastName},</p>\n            <p>Your account has been successfully created for the DFS Manager Portal.</p>\n            \n            <div style="background-color: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">\n              <h3 style="color: #374151; margin-top: 0;">Account Details:</h3>\n              <p><strong>Email:</strong> ${M.email}</p>\n              <p><strong>Employee ID:</strong> ${M.employee_id}</p>\n              <p><strong>Role:</strong> ${M.role}</p>\n              <p><strong>Station:</strong> ${e}</p>\n              <p><strong>Hire Date:</strong> ${new Date(M.hire_date).toLocaleDateString()}</p>\n            </div>\n            \n            <div style="background-color: #fef3c7; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">\n              <h4 style="color: #92400e; margin-top: 0;">Login Information:</h4>\n              <p style="color: #92400e; margin-bottom: 0;"><strong>Temporary Password:</strong> ${M.password}</p>\n              <p style="color: #92400e; font-size: 14px;"><em>Please change your password after your first login for security purposes.</em></p>\n            </div>\n            \n            ${"ALL"===M.station?'\n            <div style="background-color: #dbeafe; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6; margin: 20px 0;">\n              <h4 style="color: #1e40af; margin-top: 0;">Multi-Station Access:</h4>\n              <p style="color: #1e40af; margin-bottom: 0;">You have been granted access to <strong>ALL stations</strong>. This means you can view, edit, and delete data from all locations based on your role permissions.</p>\n            </div>\n            ':""}\n            \n            <p>You can access the portal at: <a href="${window.location.origin}" style="color: #2563eb;">${window.location.origin}</a></p>\n            \n            <p>If you have any questions or need assistance, please contact your administrator.</p>\n            \n            <p>Best regards,<br>DFS Manager Portal Team</p>\n          </div>\n        `;await window.ezsite.apis.sendEmail({from:"support@ezsite.ai",to:[M.email],subject:"Welcome to DFS Manager Portal - Account Created",html:s}),console.log("Welcome email sent successfully")}catch(a){console.warn("Failed to send welcome email:",a)}const n="ALL"===M.station?"all stations":M.station;D({title:"Success",description:`User account created successfully for ${M.firstName} ${M.lastName} with access to ${n}. Data saved to production database in real-time.`}),U({email:"",password:"",firstName:"",lastName:"",phone:"",role:"Employee",station:"MOBIL",employee_id:"",hire_date:(new Date).toISOString().split("T")[0]}),F(),E()}catch(s){console.error("Error creating user:",s),D({title:"Error",description:s instanceof Error?s.message:"Failed to create user account",variant:"destructive"})}finally{$(!1)}}},disabled:P,className:"bg-blue-600 hover:bg-blue-700",children:P?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating User..."]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Create User Account"]})})]})]})]})})};export{_ as C};
