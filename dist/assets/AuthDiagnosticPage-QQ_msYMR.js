import{j as e}from"./radix-ui-BhRELLXi.js";import{r as s}from"./react-core-CKNU0hQt.js";import{C as a,g as t,h as i,l as r,i as n,f as l,A as c,m as o,B as d,u as x,p as m,q as h,r as u,s as g}from"./index-s81fdLZV.js";import{aH as j,x as p,R as f,T as v,aK as w,aL as N,e as b,av as y,d as A,U as I,ap as P}from"./utilities-DVevn_gw.js";import"./routing-DcURAnU1.js";import"./data-management-CF8GQrOz.js";import"./animations-Cc9qW4PM.js";const S=({onApiReady:x,showFullDetails:m=!1})=>{const[h,u]=s.useState("checking"),[g,A]=s.useState(null),[I,P]=s.useState(0),[S,D]=s.useState([]),[E,z]=s.useState(null),[k,C]=s.useState(!1),R=async(e=!1)=>{e&&C(!0),u("checking"),P(e=>e+1);try{const e={windowExists:"undefined"!=typeof window,ezsiteExists:!!window.ezsite,apisExists:!!window.ezsite?.apis,specificApis:{}};if(window.ezsite?.apis){["getUserInfo","login","logout","register","sendResetPwdEmail","resetPassword","tablePage","tableCreate","tableUpdate","tableDelete","upload"].forEach(s=>{e.specificApis[s]="function"==typeof window.ezsite?.apis?.[s]})}if(z(e),!window.ezsite?.apis?.getUserInfo)return D(["Required API methods not found"]),u("unavailable"),!1;try{const e=await window.ezsite.apis.getUserInfo();return console.log("API test response:",e),u("available"),D([]),A(new Date),x&&x(),!0}catch(s){return console.error("API test failed:",s),D([`API test failed: ${s instanceof Error?s.message:String(s)}`]),u("unavailable"),!1}}catch(s){return console.error("API status check failed:",s),D([`Status check failed: ${s instanceof Error?s.message:String(s)}`]),u("unavailable"),!1}finally{e&&C(!1)}};s.useEffect(()=>{if(R(),"unavailable"===h||"checking"===h){const e=(()=>{let e=0;const s=setInterval(async()=>{e++;const a=await R();(a||e>=30)&&(clearInterval(s),a||(u("unavailable"),D(["API failed to become available after 30 attempts"])))},1e3);return s})();return()=>clearInterval(e)}},[]);return m||"available"!==h?e.jsxs(a,{className:"w-full max-w-2xl mx-auto",children:[e.jsxs(t,{children:[e.jsxs(i,{className:"flex items-center gap-2",children:[e.jsx(j,{className:"h-5 w-5"}),"API Status Monitor",(()=>{switch(h){case"checking":return e.jsx(p,{className:"h-5 w-5 animate-spin text-blue-600"});case"available":return e.jsx(b,{className:"h-5 w-5 text-green-600"});case"unavailable":return e.jsx(y,{className:"h-5 w-5 text-red-600"});default:return e.jsx(v,{className:"h-5 w-5 text-yellow-600"})}})()]}),e.jsx(r,{children:"EZSite Authentication & Database APIs"})]}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Status:"}),(()=>{switch(h){case"checking":return e.jsx(d,{variant:"secondary",children:"Checking..."});case"available":return e.jsx(d,{variant:"default",className:"bg-green-600",children:"Available"});case"unavailable":return e.jsx(d,{variant:"destructive",children:"Unavailable"});default:return e.jsx(d,{variant:"outline",children:"Unknown"})}})()]}),e.jsxs(l,{onClick:()=>{R(!0)},disabled:k,size:"sm",variant:"outline",children:[k?e.jsx(p,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(f,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:(()=>{switch(h){case"checking":return"Checking API availability...";case"available":return"All APIs are functioning correctly";case"unavailable":return"APIs are currently unavailable";default:return"API status unknown"}})()}),g&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Last checked: ",g.toLocaleTimeString()," (Attempt #",I,")"]}),S.length>0&&e.jsxs(c,{variant:"destructive",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx(o,{children:e.jsx("ul",{className:"list-disc list-inside space-y-1",children:S.map((s,a)=>e.jsx("li",{className:"text-sm",children:s},a))})})]}),m&&E&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"font-medium mb-2",children:"System Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[E.windowExists?e.jsx(w,{className:"h-4 w-4 text-green-600"}):e.jsx(N,{className:"h-4 w-4 text-red-600"}),e.jsxs("span",{children:["Window Object: ",E.windowExists?"Available":"Missing"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[E.ezsiteExists?e.jsx(w,{className:"h-4 w-4 text-green-600"}):e.jsx(N,{className:"h-4 w-4 text-red-600"}),e.jsxs("span",{children:["EZSite Object: ",E.ezsiteExists?"Available":"Missing"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[E.apisExists?e.jsx(w,{className:"h-4 w-4 text-green-600"}):e.jsx(N,{className:"h-4 w-4 text-red-600"}),e.jsxs("span",{children:["APIs Object: ",E.apisExists?"Available":"Missing"]})]})]})]}),E.specificApis&&Object.keys(E.specificApis).length>0&&e.jsxs("div",{className:"border-t pt-3",children:[e.jsx("h4",{className:"font-medium mb-2",children:"API Methods"}),e.jsx("div",{className:"grid grid-cols-2 gap-1 text-xs",children:Object.entries(E.specificApis).map(([s,a])=>e.jsxs("div",{className:"flex items-center gap-1",children:[a?e.jsx(b,{className:"h-3 w-3 text-green-600"}):e.jsx(y,{className:"h-3 w-3 text-red-600"}),e.jsx("span",{children:s})]},s))})]})]}),"unavailable"===h&&e.jsxs("div",{className:"border-t pt-3 space-y-2",children:[e.jsxs(c,{children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx(o,{children:"If this issue persists, try refreshing the page or contact support."})]}),e.jsx(l,{onClick:()=>window.location.reload(),variant:"outline",className:"w-full",children:"Refresh Page"})]})]})]}):null},D=()=>{const j=x(),[w,N]=s.useState(null),[D,E]=s.useState(!1),[z,k]=s.useState([]),C=async()=>{E(!0),k([]);const e={timestamp:(new Date).toISOString(),authContextStatus:{},apiAvailability:{},userDataIntegrity:{},permissionSystem:{},databaseConnectivity:{}},s=(e,s,a,t)=>{k(i=>[...i,{category:e,test:s,status:a,message:t,timestamp:new Date}])};try{if(s("Auth Context","Context Initialization",j.isInitialized?"pass":"fail","Auth context is "+(j.isInitialized?"initialized":"not initialized")),s("Auth Context","Loading State",j.isLoading?"warning":"pass","Loading state: "+(j.isLoading?"active":"complete")),s("Auth Context","Authentication Status",j.isAuthenticated?"pass":"warning","User is "+(j.isAuthenticated?"authenticated":"not authenticated")),j.authError?s("Auth Context","Error State","fail",`Auth error: ${j.authError}`):s("Auth Context","Error State","pass","No authentication errors"),e.authContextStatus={isInitialized:j.isInitialized,isLoading:j.isLoading,isAuthenticated:j.isAuthenticated,hasError:!!j.authError,errorMessage:j.authError},window.ezsite?.apis){s("API Availability","EZSite APIs","pass","EZSite APIs are available");const a=["getUserInfo","login","logout","register","tablePage"],t=a.filter(e=>"function"==typeof window.ezsite?.apis?.[e]);s("API Availability","Required Methods",t.length===a.length?"pass":"fail",`${t.length}/${a.length} required methods available`),e.apiAvailability={ezsiteAvailable:!0,requiredMethods:a.length,availableMethods:t.length,methods:a.map(e=>({name:e,available:"function"==typeof window.ezsite?.apis?.[e]}))}}else s("API Availability","EZSite APIs","fail","EZSite APIs are not available"),e.apiAvailability={ezsiteAvailable:!1};if(j.user){s("User Data","User Object","pass",`User ID: ${j.user.ID}, Email: ${j.user.Email}`);const a=j.user.ID&&j.user.Email&&j.user.Name;s("User Data","Required Fields",a?"pass":"fail","Required user fields are "+(a?"present":"missing")),e.userDataIntegrity={userExists:!0,userID:j.user.ID,email:j.user.Email,name:j.user.Name,hasRequiredFields:a}}else s("User Data","User Object","warning","No user data (not authenticated)"),e.userDataIntegrity={userExists:!1};if(j.userProfile?(s("User Profile","Profile Object","pass",`Role: ${j.userProfile.role}, Station: ${j.userProfile.station}`),e.userDataIntegrity.profile={exists:!0,role:j.userProfile.role,station:j.userProfile.station,isActive:j.userProfile.is_active}):(s("User Profile","Profile Object","warning","No user profile data"),e.userDataIntegrity.profile={exists:!1}),j.userProfile)try{const a=j.isAdmin(),t=j.isManager(),i=j.hasPermission("view");s("Permissions","Role Detection","pass",`Admin: ${a}, Manager: ${t}, Can View: ${i}`),e.permissionSystem={roleDetectionWorking:!0,isAdmin:a,isManager:t,canView:i,role:j.userProfile.role}}catch(a){s("Permissions","Role Detection","fail",`Permission system error: ${a instanceof Error?a.message:String(a)}`),e.permissionSystem={roleDetectionWorking:!1,error:a instanceof Error?a.message:String(a)}}else s("Permissions","Role Detection","warning","Cannot test permissions without user profile"),e.permissionSystem={roleDetectionWorking:!1};if(window.ezsite?.apis?.tablePage)try{const a=await window.ezsite.apis.tablePage(11725,{PageNo:1,PageSize:1,Filters:[]});a.error?s("Database","Table Access","warning",`Database query returned error: ${a.error}`):s("Database","Table Access","pass","Database connection and table access working"),e.databaseConnectivity={connectionWorking:!a.error,error:a.error||null}}catch(t){s("Database","Table Access","fail",`Database test failed: ${t instanceof Error?t.message:String(t)}`),e.databaseConnectivity={connectionWorking:!1,error:t instanceof Error?t.message:String(t)}}else s("Database","Table Access","fail","Database APIs not available for testing"),e.databaseConnectivity={connectionWorking:!1,error:"APIs not available"}}catch(t){s("System","Diagnostic Run","fail",`Diagnostic failed: ${t instanceof Error?t.message:String(t)}`)}N(e),E(!1)};s.useEffect(()=>{C()},[]);const R=s=>{switch(s){case"pass":return e.jsx(b,{className:"h-4 w-4 text-green-600"});case"fail":return e.jsx(y,{className:"h-4 w-4 text-red-600"});case"warning":return e.jsx(v,{className:"h-4 w-4 text-yellow-600"})}},U=s=>{switch(s){case"pass":return e.jsx(d,{variant:"default",className:"bg-green-600",children:"Pass"});case"fail":return e.jsx(d,{variant:"destructive",children:"Fail"});case"warning":return e.jsx(d,{variant:"secondary",className:"bg-yellow-500 text-white",children:"Warning"})}},$=z.reduce((e,s)=>(e[s.category]||(e[s.category]=[]),e[s.category].push(s),e),{});return e.jsxs("div",{className:"container mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(A,{className:"h-8 w-8"}),"Authentication Diagnostic"]}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Comprehensive authentication system analysis and troubleshooting"})]}),e.jsxs(l,{onClick:C,disabled:D,className:"flex items-center gap-2",children:[D?e.jsx(p,{className:"h-4 w-4 animate-spin"}):e.jsx(f,{className:"h-4 w-4"}),D?"Running...":"Run Diagnostic"]})]}),e.jsxs(m,{defaultValue:"overview",className:"w-full",children:[e.jsxs(h,{className:"grid w-full grid-cols-4",children:[e.jsx(u,{value:"overview",children:"Overview"}),e.jsx(u,{value:"tests",children:"Test Results"}),e.jsx(u,{value:"api",children:"API Status"}),e.jsx(u,{value:"details",children:"Raw Details"})]}),e.jsx(g,{value:"overview",className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs(a,{children:[e.jsx(t,{className:"pb-3",children:e.jsxs(i,{className:"text-sm flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4"}),"Authentication"]})}),e.jsx(n,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Status"}),U(j.isAuthenticated?"pass":"warning")]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Initialized"}),U(j.isInitialized?"pass":"fail")]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Loading"}),U(j.isLoading?"warning":"pass")]})]})})]}),e.jsxs(a,{children:[e.jsx(t,{className:"pb-3",children:e.jsxs(i,{className:"text-sm flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4"}),"User Data"]})}),e.jsx(n,{children:e.jsx("div",{className:"space-y-2",children:j.user?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("strong",{children:"Name:"})," ",j.user.Name]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("strong",{children:"Email:"})," ",j.user.Email]}),e.jsxs("div",{className:"text-sm",children:[e.jsx("strong",{children:"ID:"})," ",j.user.ID]})]}):e.jsx("div",{className:"text-sm text-gray-500",children:"No user data available"})})})]}),e.jsxs(a,{children:[e.jsx(t,{className:"pb-3",children:e.jsxs(i,{className:"text-sm flex items-center gap-2",children:[e.jsx(P,{className:"h-4 w-4"}),"System Status"]})}),e.jsx(n,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"APIs"}),U(window.ezsite?.apis?"pass":"fail")]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:"Database"}),U(w?.databaseConnectivity?.connectionWorking?"pass":"fail")]}),j.authError&&e.jsxs(c,{variant:"destructive",className:"mt-2",children:[e.jsx(v,{className:"h-4 w-4"}),e.jsx(o,{className:"text-xs",children:j.authError})]})]})})]})]})}),e.jsx(g,{value:"tests",className:"space-y-4",children:Object.entries($).map(([s,r])=>e.jsxs(a,{children:[e.jsx(t,{children:e.jsx(i,{className:"text-lg",children:s})}),e.jsx(n,{children:e.jsx("div",{className:"space-y-3",children:r.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[R(s.status),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-sm",children:s.test}),e.jsx("div",{className:"text-xs text-gray-600",children:s.message})]})]}),U(s.status)]},a))})})]},s))}),e.jsx(g,{value:"api",children:e.jsx(S,{showFullDetails:!0})}),e.jsx(g,{value:"details",className:"space-y-4",children:w&&e.jsxs(a,{children:[e.jsxs(t,{children:[e.jsx(i,{children:"Raw Diagnostic Data"}),e.jsx(r,{children:"Complete diagnostic results for technical analysis"})]}),e.jsx(n,{children:e.jsx("pre",{className:"bg-gray-100 p-4 rounded-lg overflow-auto text-xs",children:JSON.stringify(w,null,2)})})]})})]})]})};export{D as default};
