import{r as t}from"./react-core-CKNU0hQt.js";import{u as e,l as a}from"./index-BJg4_aev.js";const s=new class{stationsCache=[];cacheTimestamp=0;CACHE_DURATION=3e5;isLoading=!1;FALLBACK_STATIONS=[{value:"MOBIL",label:"MOBIL",color:"bg-blue-500"},{value:"AMOCO ROSEDALE",label:"AMOCO ROSEDALE",color:"bg-green-500"},{value:"AMOCO BROOKLYN",label:"AMOCO BROOKLYN",color:"bg-purple-500"}];async getStations(){if(this.isCacheValid())return this.stationsCache;if(this.isLoading)return await this.waitForLoading(),this.stationsCache;this.isLoading=!0;try{const{data:t,error:e}=await window.ezsite.apis.tablePage(12599,{PageNo:1,PageSize:100,OrderByField:"station_name",IsAsc:!0,Filters:[{name:"status",op:"Equal",value:"Active"}]});return e?(console.error("Error loading stations from database:",e),this.getFallbackStations()):(this.stationsCache=t?.List||[],this.cacheTimestamp=Date.now(),this.stationsCache)}catch(t){return console.error("Error fetching stations:",t),this.getFallbackStations()}finally{this.isLoading=!1}}async getStationOptions(t=!1,e,a){const s=(await this.getStations()).map(t=>({value:t.station_name,label:t.station_name,color:this.getStationColor(t.station_name),station:t}));return t&&this.canUserViewAll(e,a)&&s.unshift({value:"ALL_STATIONS",label:"All Stations",color:"bg-indigo-600"}),s}async getStationNames(){return(await this.getStations()).map(t=>t.station_name)}async getStationByName(t){return(await this.getStations()).find(e=>e.station_name===t)||null}getStationColor(t){return{MOBIL:"bg-blue-500","AMOCO ROSEDALE":"bg-green-500","AMOCO BROOKLYN":"bg-purple-500"}[t]||"bg-gray-500"}canUserViewAll(t,e){return t&&"string"==typeof t&&("Administrator"===t||"Management"===t||"Manager"===t||Array.isArray(e)&&e.includes("view_all_stations"))||!1}getFallbackStations(){return this.FALLBACK_STATIONS.map((t,e)=>({id:e+1,station_name:t.value,address:"Address not available",phone:"Phone not available",operating_hours:"24/7",manager_name:"Manager not assigned",status:"Active",last_updated:(new Date).toISOString(),created_by:0}))}isCacheValid(){return this.stationsCache.length>0&&Date.now()-this.cacheTimestamp<this.CACHE_DURATION}async waitForLoading(){for(;this.isLoading;)await new Promise(t=>setTimeout(t,100))}clearCache(){this.stationsCache=[],this.cacheTimestamp=0}async addStation(t){try{const{error:e}=await window.ezsite.apis.tableCreate(12599,t);return e?{success:!1,error:e}:(this.clearCache(),{success:!0})}catch(e){return{success:!1,error:String(e)}}}async updateStation(t){try{const{error:e}=await window.ezsite.apis.tableUpdate(12599,t);return e?{success:!1,error:e}:(this.clearCache(),{success:!0})}catch(e){return{success:!1,error:String(e)}}}async deleteStation(t){try{const{error:e}=await window.ezsite.apis.tableDelete(12599,{id:t});return e?{success:!1,error:e}:(this.clearCache(),{success:!0})}catch(e){return{success:!1,error:String(e)}}}async getUserAccessibleStations(t,e,a){const s=(await this.getStations()).map(t=>t.station_name);if(this.canUserViewAll(t,e))return s;const r=[];for(const i of s){const t=`view_${i.toLowerCase().replace(/\s+/g,"_")}`;(Array.isArray(e)&&e.includes(t)||Array.isArray(a)&&a.includes(i))&&r.push(i)}return r}};let r={stations:[],stationOptions:[],loading:!1,error:null,lastUpdated:0};const i=new Set,n=t=>{r={...r,...t},i.forEach(t=>t(r))},o=()=>{const{userProfile:o}=e(),{toast:l}=a(),[c,d]=t.useState(r);t.useEffect(()=>{var t;return t=d,i.add(t),()=>i.delete(t)},[]);const u=t.useCallback(async(t=!1)=>{if(c.loading)return;const e=Date.now()-c.lastUpdated<12e4;if(!(!t&&e&&c.stations.length>0)){n({loading:!0,error:null});try{const t=(()=>{if(!o?.detailed_permissions)return[];if("string"==typeof o.detailed_permissions)try{const t=JSON.parse(o.detailed_permissions);return Array.isArray(t)?t:[]}catch{return[]}return Array.isArray(o.detailed_permissions)?o.detailed_permissions:[]})(),[e,a]=await Promise.all([s.getStations(),s.getStationOptions(!0,o?.role,t)]);n({stations:e,stationOptions:a,loading:!1,error:null,lastUpdated:Date.now()})}catch(a){const t=a instanceof Error?a.message:"Failed to load stations";n({loading:!1,error:t}),l({title:"Error",description:t,variant:"destructive"})}}},[o?.role,o?.detailed_permissions,l,c.loading,c.lastUpdated,c.stations.length]),g=t.useCallback(async t=>{try{n({loading:!0,error:null});if(c.stations.find(e=>(e.name?.toLowerCase()??"")===(t.name?.toLowerCase()??"")||(e.station_name?.toLowerCase()??"")===(t.station_name?.toLowerCase()??"")))throw new Error(`Station "${t.name}" already exists`);const e=await s.addStation(t);if(!e.success)throw new Error(e.error||"Failed to add station");return await u(!0),l({title:"Success",description:`Station "${t.name}" added successfully and is now available in all dropdowns`}),{success:!0}}catch(e){const t=e.message||"Failed to add station";return n({loading:!1,error:t}),l({title:"Error",description:t,variant:"destructive"}),{success:!1,error:t}}},[c.stations,u,l]),p=t.useCallback(async t=>{try{n({loading:!0,error:null});const e=await s.updateStation(t);if(!e.success)throw new Error(e.error||"Failed to update station");return await u(!0),l({title:"Success",description:`Station "${t.name}" updated successfully`}),{success:!0}}catch(e){const t=e.message||"Failed to update station";return n({loading:!1,error:t}),l({title:"Error",description:t,variant:"destructive"}),{success:!1,error:t}}},[u,l]),h=t.useCallback(async t=>{try{n({loading:!0,error:null});const e=await s.deleteStation(t);if(!e.success)throw new Error(e.error||"Failed to delete station");return await u(!0),l({title:"Success",description:"Station deleted successfully"}),{success:!0}}catch(e){const t=e.message||"Failed to delete station";return n({loading:!1,error:t}),l({title:"Error",description:t,variant:"destructive"}),{success:!1,error:t}}},[u,l]),m=t.useCallback((t=!0)=>{let e=[...c.stationOptions];const a=(()=>{if(!o?.detailed_permissions)return[];if("string"==typeof o.detailed_permissions)try{const t=JSON.parse(o.detailed_permissions);return Array.isArray(t)?t:[]}catch{return[]}return Array.isArray(o.detailed_permissions)?o.detailed_permissions:[]})(),s="Administrator"===o?.role||"Management"===o?.role||"Manager"===o?.role||a.includes("view_all_stations");if(t&&s){const t={value:"ALL",label:"All Stations",color:"bg-indigo-600"};e=e.filter(t=>"ALL"!==t.value),e.unshift(t)}return e},[c.stationOptions,o?.role,o?.detailed_permissions]);return t.useEffect(()=>{0!==c.stations.length||c.loading||u()},[c.stations.length,c.loading,u]),{stations:c.stations,stationOptions:c.stationOptions,loading:c.loading,error:c.error,loadStations:u,addStation:g,updateStation:p,deleteStation:h,getFilteredStationOptions:m,isDataFresh:Date.now()-c.lastUpdated<12e4,getStationColor:s.getStationColor.bind(s),canSelectAll:()=>{const t=(()=>{if(!o?.detailed_permissions)return[];if("string"==typeof o.detailed_permissions)try{const t=JSON.parse(o.detailed_permissions);return Array.isArray(t)?t:[]}catch{return[]}return Array.isArray(o.detailed_permissions)?o.detailed_permissions:[]})();return"Administrator"===o?.role||"Management"===o?.role||"Manager"===o?.role||t.includes("view_all_stations")||!1}}};export{s,o as u};
