import{j as e}from"./radix-ui-woSLwCdF.js";import{r as s}from"./react-core-CKNU0hQt.js";import{l as a,D as i,m as t,e as l,a as r,b as n,c,C as d,h as o,B as m}from"./index-CIZJQuMw.js";import{i as p,c as f,f as x}from"./imageCompression-DvX-F3tO.js";import{C as u,y as h,a1 as j,a4 as g,z as b,ap as N,a2 as y,F as w}from"./utilities-DMEd7dY0.js";const v=({onFileSelect:v,onFileUpload:z,accept:F="image/*",label:C="Upload File",currentFile:_,maxSize:U=10,className:S="",disabled:$=!1,useDatabaseStorage:D=!1,associatedTable:k="",associatedRecordId:I=0,fileCategory:B="general",showPreview:M=!0})=>{const[O,P]=s.useState(!1),[W,R]=s.useState(!1),[T,A]=s.useState(!1),[E,L]=s.useState(null),[q,H]=s.useState(null),Q=s.useRef(null),{toast:G}=a(),J=F.includes("image"),K=async e=>{try{const{data:s,error:a}=await window.ezsite.apis.upload({filename:e.name,file:e});if(a)throw a;const i={file_name:e.name,file_size:e.size,file_type:e.type,store_file_id:s,uploaded_by:1,upload_date:(new Date).toISOString(),associated_table:k,associated_record_id:I,file_category:B,is_active:!0,description:"",file_url:`${window.location.origin}/file/${s}`},{data:t,error:l}=await window.ezsite.apis.tableCreate(26928,i);if(l)throw l;return{fileId:t.id,fileName:e.name,fileSize:e.size,fileType:e.type,storeFileId:s,uploadDate:i.upload_date,fileUrl:i.file_url}}catch(s){throw console.error("Database upload failed:",s),s}},V=()=>J?e.jsx(y,{className:"h-4 w-4"}):e.jsx(w,{className:"h-4 w-4"});return e.jsxs("div",{className:S,children:[e.jsxs(i,{open:O,onOpenChange:P,children:[e.jsx(t,{asChild:!0,children:e.jsxs(l,{variant:"outline",disabled:$,className:"w-full flex items-center gap-2",children:[V(),C]})}),e.jsxs(r,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(n,{children:e.jsxs(c,{className:"flex items-center gap-2",children:[V(),C]})}),e.jsxs("div",{className:"space-y-4",children:[_&&e.jsx(d,{children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Current file:"}),e.jsx(m,{variant:"secondary",children:_})]})})}),q&&M&&e.jsx(d,{className:"border-green-200 bg-green-50",children:e.jsxs(o,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(u,{className:"h-5 w-5 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-green-800",children:"File uploaded successfully!"}),e.jsx("p",{className:"text-sm text-green-600",children:q.fileName})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(l,{size:"sm",variant:"outline",onClick:()=>{q?.fileUrl&&window.open(q.fileUrl,"_blank")},children:[e.jsx(h,{className:"h-4 w-4 mr-2"}),"Preview"]}),e.jsxs(l,{size:"sm",variant:"outline",onClick:()=>{if(q?.fileUrl){const e=document.createElement("a");e.href=q.fileUrl,e.download=q.fileName,e.click()}},children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"Download"]})]})]})}),e.jsx(d,{className:"cursor-pointer hover:bg-gray-50 transition-colors",children:e.jsx(o,{className:"p-6",children:e.jsxs(l,{variant:"ghost",className:"w-full h-auto p-0 flex flex-col items-center gap-3",onClick:()=>Q.current?.click(),children:[e.jsx("div",{className:"p-4 bg-blue-100 rounded-full",children:e.jsx(g,{className:"h-8 w-8 text-blue-600"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"font-semibold",children:D?"Upload to Database":"Upload From File"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:D?"Upload and store in database":"Choose a file from your device"})]})]})})}),T&&e.jsx(d,{className:"border-blue-200 bg-blue-50",children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{className:"h-5 w-5 animate-spin text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Uploading to database..."}),e.jsx("p",{className:"text-sm text-blue-600",children:"Please wait while your file is being processed"})]})]})})}),W&&e.jsx(d,{className:"border-blue-200 bg-blue-50",children:e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(b,{className:"h-5 w-5 animate-spin text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Compressing image..."}),e.jsx("p",{className:"text-sm text-blue-600",children:"Optimizing file size for better performance"})]})]})})}),e.jsxs("div",{className:"text-center text-sm text-gray-500",children:[e.jsxs("p",{children:["Accepted file types: ",F]}),e.jsxs("p",{children:["Maximum file size: ",U,"MB"]}),p({type:F})&&e.jsx("div",{className:"mt-2 p-2 bg-green-50 rounded-lg border border-green-200",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700",children:[e.jsx(N,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Auto-compression enabled for images >1MB"})]})})]})]})]})]}),e.jsx("input",{ref:Q,type:"file",accept:F,onChange:async e=>{const s=e.target.files?.[0];s&&(e=>{if(e.size>1024*U*1024)return G({title:"File too large",description:`File size must be less than ${U}MB`,variant:"destructive"}),!1;if(F&&"*/*"!==F&&!F.split(",").map(e=>e.trim()).some(s=>{if(s.startsWith("."))return e.name.toLowerCase().endsWith(s.toLowerCase());if(s.includes("*")){const a=s.split("/")[0];return e.type.startsWith(a)}return e.type===s}))return G({title:"Invalid file type",description:`Please select a file of type: ${F}`,variant:"destructive"}),!1;return!0})(s)&&await(async e=>{if(p(e)&&e.size>1048576){R(!0);try{const a=await f(e,{maxSizeMB:1,maxWidthOrHeight:1920,quality:.8,initialQuality:.8});if(L(a),a.wasCompressed&&G({title:"Image compressed",description:`File size reduced from ${x(a.originalSize)} to ${x(a.compressedSize)} (${a.compressionRatio.toFixed(1)}x smaller)`,duration:5e3}),D){A(!0);try{const e=await K(a.file);H(e),z&&z(e),G({title:"File uploaded successfully",description:`${a.file.name} has been uploaded to the database`})}catch(s){G({title:"Upload failed",description:"string"==typeof s?s:"Failed to upload file to database",variant:"destructive"})}finally{A(!1)}}else v&&v(a.file);P(!1)}catch(s){if(console.error("Compression failed:",s),G({title:"Compression failed",description:"Using original file instead",variant:"destructive"}),D){A(!0);try{const s=await K(e);H(s),z&&z(s),G({title:"File uploaded successfully",description:`${e.name} has been uploaded to the database`})}catch(a){G({title:"Upload failed",description:"string"==typeof a?a:"Failed to upload file to database",variant:"destructive"})}finally{A(!1)}}else v&&v(e);P(!1)}finally{R(!1)}}else{if(D){A(!0);try{const s=await K(e);H(s),z&&z(s),G({title:"File uploaded successfully",description:`${e.name} has been uploaded to the database`})}catch(s){G({title:"Upload failed",description:"string"==typeof s?s:"Failed to upload file to database",variant:"destructive"})}finally{A(!1)}}else v&&v(e),G({title:"File selected",description:`${e.name} has been selected successfully`});P(!1)}})(s),Q.current&&(Q.current.value="")},className:"hidden"})]})};export{v as E};
