import{j as e,ab as s,ac as a,ad as t}from"./radix-ui-woSLwCdF.js";import{r}from"./react-core-CKNU0hQt.js";import{i,l,e as c,D as n,a as o,b as d,c as m,C as u,h as x}from"./index-CIZJQuMw.js";import{f as p,c as h}from"./imageCompression-DvX-F3tO.js";import{z as f,s as g,U as j,Z as N,a2 as b,a4 as w,V as v,i as y}from"./utilities-DMEd7dY0.js";const z=r.forwardRef(({className:a,...t},r)=>e.jsx(s,{ref:r,className:i("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",a),...t}));z.displayName=s.displayName;const U=r.forwardRef(({className:s,...t},r)=>e.jsx(a,{ref:r,className:i("aspect-square h-full w-full",s),...t}));U.displayName=a.displayName;const S=r.forwardRef(({className:s,...a},r)=>e.jsx(t,{ref:r,className:i("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...a}));S.displayName=t.displayName;const C=({imageId:s,firstName:a="",lastName:t="",size:C="md",className:I="",showFallbackIcon:P=!0,previewFile:k=null,showLoadingState:R=!0,enableHover:F=!1,rounded:$="full",alt:E,allowEdit:L=!1,onImageUpdate:O,userId:G,employeeId:_,tableName:B,recordId:D,disabled:M=!1})=>{const[q,W]=r.useState(null),[A,H]=r.useState(!1),[J,T]=r.useState(!1),[Q,V]=r.useState(!1),[Z,K]=r.useState(0),[X,Y]=r.useState(!1),[ee,se]=r.useState(null),[ae,te]=r.useState(!1),[re,ie]=r.useState(!1),[le,ce]=r.useState(null),{toast:ne}=l();r.useEffect(()=>{if(k){const e=URL.createObjectURL(k);return W(e),T(!1),V(!1),H(!0),()=>{URL.revokeObjectURL(e)}}W(null),T(!1),V(!1),H(!1)},[k]),r.useEffect(()=>{s?(H(!0),T(!1),V(!1),K(0)):(H(!1),T(!1),V(!1))},[s]);const oe=()=>{if(!a&&!t)return"U";const e=a.charAt(0).toUpperCase(),s=t.charAt(0).toUpperCase();return e&&s?`${e}${s}`:e||s||"U"},de=q||(()=>{if(!s)return;const e=Date.now();if("string"==typeof s&&s.startsWith("http"))return s;return`${window.location.origin}/api/files/${s}?t=${e}`})(),me=!de||Q||!J&&!A,ue=()=>{switch(C){case"sm":return"w-3 h-3";case"md":default:return"w-4 h-4";case"lg":return"w-6 h-6";case"xl":return"w-8 h-8";case"2xl":return"w-12 h-12"}},xe=()=>E||((a||t)&&`${a} ${t}`.trim()||"Profile picture"),pe=i((()=>{switch(C){case"sm":return"w-8 h-8 text-xs";case"md":default:return"w-10 h-10 text-sm";case"lg":return"w-16 h-16 text-lg";case"xl":return"w-24 h-24 text-xl";case"2xl":return"w-32 h-32 text-2xl"}})(),(()=>{switch($){case"md":return"rounded-md";case"lg":return"rounded-lg";case"xl":return"rounded-xl";default:return"rounded-full"}})(),"border-2 border-gray-200 transition-all duration-200",F&&"hover:border-blue-300 hover:shadow-md cursor-pointer",I),he=i("bg-gradient-to-br from-gray-100 to-gray-200 text-gray-600 font-medium","flex items-center justify-center",Q&&"bg-red-50 text-red-400");return e.jsxs("div",{className:"relative inline-block group",children:[e.jsxs(z,{className:pe,children:[A&&R&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100 rounded-full",children:e.jsx(f,{className:i(ue(),"animate-spin text-gray-400")})}),de&&e.jsx(U,{src:de,alt:xe(),className:i("object-cover transition-opacity duration-200",A&&R&&"opacity-0",J&&"opacity-100"),onLoad:()=>{T(!0),V(!1),H(!1)},onError:()=>{T(!1),H(!1),Z<2&&s?setTimeout(()=>{K(e=>e+1),V(!1),H(!0)},1e3+500*Z):V(!0)},onLoadStart:()=>{R&&H(!0)}}),me&&e.jsx(S,{className:he,children:Q?e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-1",children:[e.jsx(g,{className:ue()}),("xl"===C||"2xl"===C)&&e.jsx("span",{className:"text-xs text-center",children:"Error"})]}):"U"!==oe()?e.jsx("span",{className:"font-semibold tracking-wider",children:oe()}):P?e.jsx(j,{className:ue()}):e.jsx("span",{className:"font-semibold",children:"U"})})]}),L&&!M&&e.jsx(c,{type:"button",size:"sm",variant:"default",onClick:()=>Y(!0),className:i("absolute -bottom-1 -right-1 rounded-full p-0 shadow-lg bg-blue-600 hover:bg-blue-700 opacity-0 group-hover:opacity-100 transition-opacity duration-200",(()=>{switch(C){case"sm":return"w-6 h-6";case"md":default:return"w-7 h-7";case"lg":return"w-8 h-8";case"xl":return"w-10 h-10";case"2xl":return"w-12 h-12"}})()),children:e.jsx(N,{className:"w-3 h-3"})}),A&&R&&("xl"===C||"2xl"===C)&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-blue-500 rounded-full p-1",children:e.jsx(f,{className:"w-3 h-3 animate-spin text-white"})}),Q&&("xl"===C||"2xl"===C)&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-red-500 rounded-full p-1",children:e.jsx(g,{className:"w-3 h-3 text-white"})}),k&&e.jsx("div",{className:"absolute -bottom-1 -right-1 bg-green-500 rounded-full p-1",children:e.jsx("div",{className:"w-3 h-3 bg-white rounded-full animate-pulse"})}),L&&e.jsx(n,{open:X,onOpenChange:Y,children:e.jsxs(o,{className:"max-w-lg",children:[e.jsx(d,{children:e.jsxs(m,{className:"flex items-center gap-2",children:[e.jsx(b,{className:"h-5 w-5"}),"Edit Profile Picture"]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(z,{className:"w-24 h-24 border-2 border-gray-200",children:ee?e.jsx(U,{src:URL.createObjectURL(ee),alt:"New profile picture",className:"object-cover"}):de?e.jsx(U,{src:de,alt:xe(),className:"object-cover"}):e.jsx(S,{className:he,children:"U"!==oe()?e.jsx("span",{className:"font-semibold tracking-wider text-lg",children:oe()}):e.jsx(j,{className:"w-8 h-8"})})})}),e.jsx(u,{className:"cursor-pointer hover:bg-gray-50 transition-colors border-dashed border-2",children:e.jsx(x,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col items-center gap-3 text-center",children:[e.jsx("div",{className:"p-4 bg-blue-100 rounded-full",children:e.jsx(w,{className:"h-8 w-8 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Choose Profile Picture"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Click here to select an image"})]})]})})}),re&&e.jsx(u,{className:"border-blue-200 bg-blue-50",children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(f,{className:"h-5 w-5 animate-spin text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Optimizing image..."}),e.jsx("p",{className:"text-sm text-blue-600",children:"Preparing for upload"})]})]})})}),ee&&e.jsxs("div",{className:"p-3 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("p",{className:"text-sm font-medium text-green-800",children:"New picture selected:"}),e.jsx("p",{className:"text-sm text-green-600",children:ee.name}),le&&e.jsx("p",{className:"text-xs text-green-500 mt-1",children:le.wasCompressed?`Optimized to ${p(le.compressedSize)}`:`File size: ${p(le.originalSize)}`})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(c,{variant:"outline",size:"sm",onClick:()=>document.getElementById("profile-picture-input")?.click(),disabled:ae||re,children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Select Image"]}),(s||ee)&&e.jsxs(c,{variant:"outline",size:"sm",onClick:async()=>{try{if(te(!0),B&&D){const e={ID:D};("employees"===B||"user_profiles"===B)&&(e.profile_image_id=null);const s="employees"===B?"11727":"11725",{error:a}=await window.ezsite.apis.tableUpdate(s,e);if(a)throw a}O&&O(null),ne({title:"Image removed",description:"Profile picture removed successfully"}),Y(!1),se(null),ce(null)}catch(e){console.error("Remove failed:",e),ne({title:"Remove failed",description:e instanceof Error?e.message:"Failed to remove image",variant:"destructive"})}finally{te(!1)}},disabled:ae||re,className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:[e.jsx(v,{className:"w-4 h-4 mr-2"}),"Remove"]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(c,{variant:"outline",onClick:()=>Y(!1),disabled:ae||re,children:"Cancel"}),e.jsx(c,{onClick:async()=>{if(ee){te(!0);try{const{data:e,error:s}=await window.ezsite.apis.upload({filename:ee.name,file:ee});if(s)throw s;if(B&&D){const s={ID:D};("employees"===B||"user_profiles"===B)&&(s.profile_image_id=e);const a="employees"===B?"11727":"11725",{error:t}=await window.ezsite.apis.tableUpdate(a,s);if(t)throw t}O&&O(e),ne({title:"Upload successful",description:"Profile picture updated successfully"}),Y(!1),se(null),ce(null)}catch(e){console.error("Upload failed:",e),ne({title:"Upload failed",description:e instanceof Error?e.message:"Failed to upload image",variant:"destructive"})}finally{te(!1)}}},disabled:!ee||ae||re,children:ae?e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-4 h-4 mr-2"}),"Save Changes"]})})]})]}),e.jsxs("div",{className:"text-center text-sm text-gray-500 space-y-1",children:[e.jsx("p",{children:"Supported formats: JPG, PNG, GIF"}),e.jsx("p",{children:"Maximum file size: 5MB"}),e.jsx("p",{children:"Recommended: Square image, at least 200x200 pixels"}),e.jsx("div",{className:"mt-3 p-2 bg-green-50 rounded-lg border border-green-200",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700",children:[e.jsx(b,{className:"h-4 w-4"}),e.jsx("span",{className:"text-xs font-medium",children:"Images are automatically optimized"})]})})]})]})]})}),e.jsx("input",{id:"profile-picture-input",type:"file",accept:"image/*",onChange:async e=>{const s=e.target.files?.[0];if(s&&(e=>e.size>5242880?(ne({title:"File too large",description:"File size must be less than 5MB",variant:"destructive"}),!1):!!e.type.startsWith("image/")||(ne({title:"Invalid file type",description:"Please select an image file (JPG, PNG, GIF)",variant:"destructive"}),!1))(s)){const e=await(async e=>{ie(!0);try{const s=await h(e,{maxSizeMB:1,maxWidthOrHeight:800,quality:.85,initialQuality:.85});return ce(s),s.wasCompressed&&ne({title:"Image optimized",description:`File size reduced from ${p(s.originalSize)} to ${p(s.compressedSize)}`,duration:5e3}),s.file}catch(s){return console.error("Compression failed:",s),ne({title:"Optimization failed",description:"Using original file instead",variant:"destructive"}),e}finally{ie(!1)}})(s);se(e)}e.target.value=""},className:"hidden"})]})};export{C as P};
