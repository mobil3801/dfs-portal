import{j as e}from"./radix-ui-Crli8-Dx.js";import{A as s,x as a,m as t,C as i,g as l,h as r,i as n,B as c,n as d,L as o,f as m,I as h,u as x,p as u,q as p,r as j,s as g,T as v,a as f,b as N,c as y,d as w,e as E,v as b}from"./index-CNwujOOT.js";import{r as C}from"./react-core-CKNU0hQt.js";import{S as A,c as _,d as D,a as S,b as T}from"./select-Cf4csPfA.js";import{S as k}from"./switch-D1dWGluT.js";import{D as I,a as O,b as P,c as R}from"./dialog-W_eRI_WK.js";import{e as L,T as V,d as U,aI as F,r as M,j as q,R as B,V as $,s as z,ad as K,Q as W,W as G,O as Y,ay as J,aJ as H,av as Q}from"./utilities-BH0DC7Sl.js";import{P as Z}from"./progress-BHQ4F-zE.js";import{A as X}from"./AccessDenied-C7Oks6IT.js";import"./routing-DcURAnU1.js";import"./data-management-CVsxhheF.js";import"./animations-CAl9KjXG.js";const ee=({errors:d,className:o="",showTitle:m=!0})=>{const h=s=>{switch(s){case"email":return e.jsx(M,{className:"h-4 w-4"});case"role":return e.jsx(F,{className:"h-4 w-4"});case"admin_protection":return e.jsx(U,{className:"h-4 w-4"});default:return e.jsx(V,{className:"h-4 w-4"})}},x=e=>{switch(e){case"admin_protection":return"destructive";case"role":case"email":return"default";default:return"secondary"}};if(0===d.length)return e.jsxs(s,{className:`border-green-200 bg-green-50 ${o}`,children:[e.jsx(L,{className:"h-4 w-4 text-green-600"}),e.jsx(a,{className:"text-green-800",children:"Validation Passed"}),e.jsx(t,{className:"text-green-700",children:"All user data is valid and ready for processing."})]});const u=d.reduce((e,s)=>(e[s.type]||(e[s.type]=[]),e[s.type].push(s),e),{});return e.jsxs(i,{className:`border-red-200 bg-red-50 ${o}`,children:[m&&e.jsx(l,{className:"pb-3",children:e.jsxs(r,{className:"text-red-800 flex items-center gap-2",children:[e.jsx(V,{className:"h-5 w-5"}),"User Validation Errors (",d.length,")"]})}),e.jsxs(n,{className:"space-y-4",children:[Object.entries(u).map(([a,i])=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[h(a),e.jsxs(c,{variant:x(a),children:[a.replace("_"," ").toUpperCase()," (",i.length,")"]})]}),e.jsx("div",{className:"space-y-1 ml-6",children:i.map((a,i)=>e.jsx(s,{className:"py-2",children:e.jsxs(t,{className:"text-sm",children:[e.jsxs("span",{className:"font-medium",children:[a.field,":"]})," ",a.message]})},i))})]},a)),u.admin_protection&&e.jsxs(s,{className:"border-orange-200 bg-orange-50",children:[e.jsx(U,{className:"h-4 w-4 text-orange-600"}),e.jsx(a,{className:"text-orange-800",children:"Admin Protection Active"}),e.jsx(t,{className:"text-orange-700",children:"The system is protecting the admin@dfs-portal.com account from unauthorized changes. This ensures continued system access and security."})]})]})]})};const se=new class{PROTECTED_ADMIN_EMAIL="admin@dfs-portal.com";VALID_ROLES=["Administrator","Management","Employee"];CONFLICTING_ROLES=[["Administrator","Employee"],["Management","Employee"]];async validateUser(e,s=!1){const a=[];try{if(e.email){const s=await this.validateEmail(e.email,e.id);a.push(...s)}if(e.role){const s=await this.validateRole(e);a.push(...s)}if(s&&e.email===this.PROTECTED_ADMIN_EMAIL){const s=this.validateAdminProtection(e);a.push(...s)}return a}catch(t){return console.error("User validation error:",t),[{field:"general",message:"Validation service error occurred",type:"general"}]}}async validateEmail(e,s){const a=[];try{const t=await window.ezsite.apis.tablePage("User",{PageNo:1,PageSize:1,Filters:[{name:"Email",op:"Equal",value:e}]});if(t.error)throw new Error(t.error);if(t.data?.List?.length>0){const e=t.data.List[0];s&&e.ID===s||a.push({field:"email",message:"This email address is already in use by another user",type:"email"})}const i=await window.ezsite.apis.tablePage(11727,{PageNo:1,PageSize:1,Filters:[{name:"email",op:"Equal",value:e}]});i.data?.List?.length>0&&a.push({field:"email",message:"This email address is already registered as an employee",type:"email"})}catch(t){console.error("Email validation error:",t),a.push({field:"email",message:"Unable to verify email uniqueness",type:"email"})}return a}async validateRole(e){const s=[];if(!this.VALID_ROLES.includes(e.role))return s.push({field:"role",message:`Invalid role. Must be one of: ${this.VALID_ROLES.join(", ")}`,type:"role"}),s;try{if(e.station&&e.user_id){const a=await window.ezsite.apis.tablePage(11725,{PageNo:1,PageSize:100,Filters:[{name:"station",op:"Equal",value:e.station},{name:"user_id",op:"Equal",value:e.user_id},{name:"is_active",op:"Equal",value:!0}]});if(a.data?.List?.length>0){const t=a.data.List[0];for(const[a,i]of this.CONFLICTING_ROLES)(e.role===a&&t.role===i||e.role===i&&t.role===a)&&s.push({field:"role",message:`Role conflict: Cannot assign ${e.role} role when user already has ${t.role} role at ${e.station}`,type:"role"})}if("admin"===e.role){const a=await window.ezsite.apis.tablePage(11725,{PageNo:1,PageSize:1,Filters:[{name:"role",op:"Equal",value:"Administrator"},{name:"is_active",op:"Equal",value:!0}]});if(a.data?.List?.length>0){a.data.List[0].id!==e.id&&s.push({field:"role",message:"Only one Administrator role is allowed in the system",type:"role"})}}}}catch(a){console.error("Role validation error:",a),s.push({field:"role",message:"Unable to verify role conflicts",type:"role"})}return s}validateAdminProtection(e){const s=[];return e.email===this.PROTECTED_ADMIN_EMAIL&&(e.role&&"Administrator"!==e.role&&s.push({field:"role",message:"Admin@dfs-portal.com must maintain Administrator role for system security",type:"admin_protection"}),!1===e.is_active&&s.push({field:"is_active",message:"Admin@dfs-portal.com account cannot be deactivated",type:"admin_protection"})),s}async canDeleteUser(e,s){const a=[];try{if(!s){const a=await window.ezsite.apis.tablePage("User",{PageNo:1,PageSize:1,Filters:[{name:"ID",op:"Equal",value:e}]});a.data?.List?.length>0&&(s=a.data.List[0].Email)}s===this.PROTECTED_ADMIN_EMAIL&&a.push({field:"delete",message:"Admin@dfs-portal.com account cannot be deleted for system security",type:"admin_protection"})}catch(t){console.error("Delete validation error:",t),a.push({field:"delete",message:"Unable to verify if user can be deleted",type:"general"})}return a}async validateBulkOperation(e,s){const a={};for(const t of e){const e=t.id?.toString()||t.user_id?.toString()||"new";switch(s){case"create":a[e]=await this.validateUser(t,!1);break;case"update":a[e]=await this.validateUser(t,!0);break;case"delete":a[e]=await this.canDeleteUser(t.id,t.email)}}return a}async getRoleConflicts(e,s,a){const t=[];try{const i=this.CONFLICTING_ROLES.filter(([s,a])=>s===e||a===e).flatMap(([s,a])=>e===s?[a]:[s]);for(const l of i){const i=await window.ezsite.apis.tablePage(11725,{PageNo:1,PageSize:100,Filters:[{name:"role",op:"Equal",value:l},{name:"station",op:"Equal",value:s},{name:"is_active",op:"Equal",value:!0}]});if(i.data?.List){const s=a?i.data.List.filter(e=>e.user_id!==a):i.data.List;t.push(...s.map(s=>({...s,conflictType:`${e} conflicts with ${l}`})))}}}catch(i){console.error("Error checking role conflicts:",i)}return t}};function ae(e={}){const[s,a]=C.useState(!1),[t,i]=C.useState([]),{toast:l}=d(),{showToasts:r=!0,onValidationError:n,onValidationSuccess:c}=e,o=C.useCallback(async(e,s=!1)=>{a(!0),i([]);try{const a=await se.validateUser(e,s);return i(a),a.length>0?(r&&a.forEach(e=>{l({title:"Validation Error",description:e.message,variant:"destructive"})}),n?.(a),!1):(r&&l({title:"Validation Passed",description:"User data is valid",variant:"default"}),c?.(),!0)}catch(t){const e=t instanceof Error?t.message:"Validation failed";return r&&l({title:"Validation Error",description:e,variant:"destructive"}),!1}finally{a(!1)}},[l,r,n,c]),m=C.useCallback(async(e,s)=>{a(!0);try{const a=(await se.validateUser({email:e,id:s},!!s)).filter(e=>"email"===e.type);return!(a.length>0)||(r&&a.forEach(e=>{l({title:"Email Validation Error",description:e.message,variant:"destructive"})}),!1)}catch(t){return r&&l({title:"Email Validation Error",description:"Failed to validate email",variant:"destructive"}),!1}finally{a(!1)}},[l,r]),h=C.useCallback(async(e,s,a)=>{try{return await se.getRoleConflicts(e,s,a)}catch(t){return console.error("Error checking role conflicts:",t),[]}},[]),x=C.useCallback(async(e,s)=>{a(!0);try{const a=await se.validateBulkOperation(e,s),t=Object.values(a).reduce((e,s)=>e+s.length,0),i=e.length;return r&&l(t>0?{title:"Bulk Validation Results",description:`${t} errors found across ${i} users`,variant:"destructive"}:{title:"Bulk Validation Passed",description:`All ${i} users passed validation`,variant:"default"}),a}catch(t){return r&&l({title:"Bulk Validation Error",description:"Failed to validate users",variant:"destructive"}),{}}finally{a(!1)}},[l,r]),u=C.useCallback(async(e,s)=>{try{const a=await se.canDeleteUser(e,s);return!(a.length>0)||(r&&a.forEach(e=>{l({title:"Delete Validation Error",description:e.message,variant:"destructive"})}),!1)}catch(a){return r&&l({title:"Delete Validation Error",description:"Failed to validate user deletion",variant:"destructive"}),!1}},[l,r]),p=C.useCallback(e=>t.filter(s=>s.field===e),[t]),j=t.length>0,g=t.some(e=>"email"===e.type),v=t.some(e=>"role"===e.type),f=t.some(e=>"admin_protection"===e.type);return{isValidating:s,validationErrors:t,hasValidationErrors:j,hasEmailErrors:g,hasRoleErrors:v,hasAdminProtectionErrors:f,validateUser:o,validateEmail:m,checkRoleConflicts:h,validateBulkOperation:x,canDeleteUser:u,getValidationErrorsByField:p,clearErrors:()=>i([])}}const te=({selectedRole:a,selectedStation:d,excludeUserId:h,onConflictsFound:x,autoCheck:u=!0,className:p=""})=>{const[j,g]=C.useState(a||""),[v,f]=C.useState(d||""),[N,y]=C.useState([]),[w,E]=C.useState(!1),{checkRoleConflicts:b}=ae({showToasts:!1}),k=async()=>{if(j&&v){E(!0);try{const e=await b(j,v,h);y(e),x?.(e)}catch(e){console.error("Error checking conflicts:",e)}finally{E(!1)}}};C.useEffect(()=>{a&&g(a)},[a]),C.useEffect(()=>{d&&f(d)},[d]),C.useEffect(()=>{u&&j&&v&&k()},[j,v,h,u]);return e.jsxs(i,{className:`${p}`,children:[e.jsx(l,{children:e.jsxs(r,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-5 w-5"}),"Role Conflict Checker"]})}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"role-select",children:"Role"}),e.jsxs(A,{value:j,onValueChange:g,children:[e.jsx(_,{id:"role-select",children:e.jsx(D,{placeholder:"Select role"})}),e.jsx(S,{children:["Administrator","Management","Employee"].map(s=>e.jsx(T,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"station-select",children:"Station"}),e.jsxs(A,{value:v,onValueChange:f,children:[e.jsx(_,{id:"station-select",children:e.jsx(D,{placeholder:"Select station"})}),e.jsx(S,{children:["MOBIL","AMOCO ROSEDALE","AMOCO BROOKLYN"].map(s=>e.jsx(T,{value:s,children:s},s))})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(m,{onClick:k,disabled:!j||!v||w,className:"w-full",children:[w?e.jsx(B,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(V,{className:"h-4 w-4 mr-2"}),"Check Conflicts"]})})]}),j&&v&&e.jsx("div",{className:"space-y-3",children:0===N.length?e.jsxs(s,{className:"border-green-200 bg-green-50",children:[e.jsx(L,{className:"h-4 w-4 text-green-600"}),e.jsxs(t,{className:"text-green-700",children:["No role conflicts found for ",j," at ",v]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs(s,{className:"border-orange-200 bg-orange-50",children:[e.jsx(V,{className:"h-4 w-4 text-orange-600"}),e.jsxs(t,{className:"text-orange-700",children:[N.length," role conflict(s) found for ",j," at ",v]})]}),e.jsx("div",{className:"space-y-2",children:N.map((a,l)=>{return e.jsx(i,{className:"border-red-200 bg-red-50",children:e.jsxs(n,{className:"p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium text-red-800",children:["User ID: ",a.user_id]}),e.jsxs("p",{className:"text-sm text-red-700",children:["Current Role: ",a.role," at ",a.station]}),e.jsxs("p",{className:"text-sm text-red-600",children:["Employee ID: ",a.employee_id]})]}),e.jsx(c,{variant:(r=a.conflictType,r.includes("Administrator")?"destructive":r.includes("Management")?"default":"secondary"),children:"Conflict"})]}),e.jsx(s,{className:"mt-2 py-1",children:e.jsx(t,{className:"text-sm",children:a.conflictType})})]})},l);var r})})]})})]})]})};const ie=({email:a="",userId:d,onValidationChange:x,autoCheck:u=!0,className:p=""})=>{const[j,g]=C.useState(a),[v,f]=C.useState({isValid:!1,message:"",checked:!1}),{validateEmail:N,isValidating:y}=ae({showToasts:!1}),w=function(e,s){const[a,t]=C.useState(e);return C.useEffect(()=>{const a=setTimeout(()=>{t(e)},s);return()=>{clearTimeout(a)}},[e,s]),a}(j,500),E=async e=>{if(!e||!b(e))return f({isValid:!1,message:"Please enter a valid email address",checked:!0}),void x?.(!1,"Invalid email format");try{const s=await N(e,d),a=s?"Email is available and unique":"Email is already in use";f({isValid:s,message:a,checked:!0}),x?.(s,a)}catch(s){const e="Failed to check email uniqueness";f({isValid:!1,message:e,checked:!0}),x?.(!1,e)}},b=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);C.useEffect(()=>{a!==j&&g(a)},[a]),C.useEffect(()=>{u&&w&&E(w)},[w,d,u]);return e.jsxs(i,{className:p,children:[e.jsx(l,{children:e.jsxs(r,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"h-5 w-5"}),"Email Uniqueness Checker"]})}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"email-input",children:"Email Address"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(h,{id:"email-input",type:"email",value:j,onChange:e=>{g(e.target.value),f(e=>({...e,checked:!1}))},placeholder:"Enter email address",className:"pr-10"}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:y?e.jsx(B,{className:"h-4 w-4 animate-spin text-blue-500"}):v.checked?v.isValid?e.jsx(L,{className:"h-4 w-4 text-green-500"}):e.jsx(V,{className:"h-4 w-4 text-red-500"}):e.jsx(M,{className:"h-4 w-4 text-gray-400"})})]}),!u&&e.jsx(m,{onClick:()=>{j&&E(j)},disabled:!j||y,variant:"outline",children:e.jsx($,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Validation Status:"}),y?e.jsx(c,{variant:"secondary",children:"Checking..."}):v.checked?e.jsx(c,{variant:v.isValid?"default":"destructive",children:v.isValid?"Available":"Unavailable"}):e.jsx(c,{variant:"outline",children:"Not Checked"})]}),v.checked&&e.jsxs(s,{className:v.isValid?"border-green-200 bg-green-50":"border-red-200 bg-red-50",children:[v.isValid?e.jsx(L,{className:"h-4 w-4 text-green-600"}):e.jsx(V,{className:"h-4 w-4 text-red-600"}),e.jsx(t,{className:v.isValid?"text-green-700":"text-red-700",children:v.message})]}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[e.jsx("p",{children:"• Email addresses must be unique across all user accounts"}),e.jsx("p",{children:"• System checks both user and employee tables"}),e.jsx("p",{children:"• Admin@dfs-portal.com is protected and cannot be duplicated"}),d&&e.jsxs("p",{children:["• Checking for user ID: ",d]})]})]})]})},le=({userEmail:d,isProtectedAdmin:o,showDetails:m=!0,className:h=""})=>{const x="admin@dfs-portal.com";return o||d===x||d===x?e.jsxs("div",{className:`space-y-4 ${h}`,children:[e.jsxs(s,{className:"border-orange-200 bg-orange-50",children:[e.jsx(U,{className:"h-4 w-4 text-orange-600"}),e.jsxs(a,{className:"text-orange-800 flex items-center gap-2",children:["Admin Protection Active",e.jsx(c,{variant:"secondary",className:"bg-orange-100 text-orange-800",children:"PROTECTED"})]}),e.jsxs(t,{className:"text-orange-700",children:["The account ",e.jsx("strong",{children:x})," is protected by the system security policy. Certain changes are restricted to maintain administrative access."]})]}),m&&e.jsxs(i,{className:"border-blue-200 bg-blue-50",children:[e.jsx(l,{className:"pb-3",children:e.jsxs(r,{className:"text-blue-800 flex items-center gap-2 text-lg",children:[e.jsx(z,{className:"h-5 w-5"}),"Protection Details"]})}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-blue-800 mb-2 flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),"Restricted Operations"]}),e.jsxs("div",{className:"space-y-2 ml-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"destructive",className:"text-xs",children:"BLOCKED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Role changes from Administrator"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"destructive",className:"text-xs",children:"BLOCKED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Account deactivation"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"destructive",className:"text-xs",children:"BLOCKED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Account deletion"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"destructive",className:"text-xs",children:"BLOCKED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Email address changes"})]})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-blue-800 mb-2 flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4"}),"Allowed Operations"]}),e.jsxs("div",{className:"space-y-2 ml-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"default",className:"text-xs bg-green-100 text-green-800",children:"ALLOWED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Password changes"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"default",className:"text-xs bg-green-100 text-green-800",children:"ALLOWED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Profile information updates"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"default",className:"text-xs bg-green-100 text-green-800",children:"ALLOWED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Station assignments"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{variant:"default",className:"text-xs bg-green-100 text-green-800",children:"ALLOWED"}),e.jsx("span",{className:"text-sm text-blue-700",children:"Permission modifications"})]})]})]}),e.jsxs(s,{className:"border-gray-200 bg-gray-50",children:[e.jsx(K,{className:"h-4 w-4 text-gray-600"}),e.jsxs(t,{className:"text-gray-700",children:[e.jsx("strong",{children:"Security Notice:"})," These protections ensure that the system always has at least one administrator account with full access. Contact your system administrator if you need to modify these restrictions."]})]})]})]})]}):null},re=()=>{const[s,a]=C.useState([]),[t,b]=C.useState([]),[V,F]=C.useState(null),[M,$]=C.useState(null),[z,K]=C.useState(!1),[J,H]=C.useState(!1),[Q,Z]=C.useState(!1),[X,se]=C.useState({name:"",email:"",role:"Employee",station:"",employee_id:"",phone:"",hire_date:(new Date).toISOString().split("T")[0],is_active:!0}),{toast:re}=d(),{user:ne}=x(),{validateUser:ce,validationErrors:de,hasValidationErrors:oe,isValidating:me,clearErrors:he}=ae(),xe=async()=>{try{Z(!0);const e=await window.ezsite.apis.tablePage("User",{PageNo:1,PageSize:100,OrderByField:"CreateTime",IsAsc:!1});if(e.error)throw new Error(e.error);a(e.data?.List||[]);const s=await window.ezsite.apis.tablePage(11725,{PageNo:1,PageSize:100,OrderByField:"id",IsAsc:!1});if(s.error)throw new Error(s.error);b(s.data?.List||[])}catch(e){console.error("Error loading users:",e),re({title:"Error",description:"Failed to load users",variant:"destructive"})}finally{Z(!1)}};C.useEffect(()=>{xe()},[]);const ue=e=>t.find(s=>s.user_id===e),pe=()=>{se({name:"",email:"",role:"Employee",station:"",employee_id:"",phone:"",hire_date:(new Date).toISOString().split("T")[0],is_active:!0}),F(null),$(null),he()},je=e=>{switch(e){case"Administrator":return"destructive";case"Management":return"default";case"Employee":return"secondary";default:return"outline"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(i,{children:e.jsxs(l,{children:[e.jsxs(r,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-6 w-6"}),"Enhanced User Management System",e.jsx(c,{variant:"outline",className:"ml-2",children:"With Validation & Protection"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(m,{onClick:()=>K(!0),children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Add User"]}),e.jsxs(m,{variant:"outline",onClick:xe,disabled:Q,children:[e.jsx(B,{className:"h-4 w-4 mr-2 "+(Q?"animate-spin":"")}),"Refresh"]})]})]})}),e.jsxs(u,{defaultValue:"users",className:"space-y-6",children:[e.jsxs(p,{children:[e.jsx(j,{value:"users",children:"User Management"}),e.jsx(j,{value:"validation",children:"Validation Tools"}),e.jsx(j,{value:"protection",children:"Admin Protection"})]}),e.jsx(g,{value:"users",className:"space-y-4",children:e.jsxs(i,{children:[e.jsx(l,{children:e.jsxs(r,{children:["Users & Profiles (",s.length,")"]})}),e.jsx(n,{children:Q?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(B,{className:"h-6 w-6 animate-spin mr-2"}),"Loading users..."]}):e.jsxs(v,{children:[e.jsx(f,{children:e.jsxs(N,{children:[e.jsx(y,{children:"Name"}),e.jsx(y,{children:"Email"}),e.jsx(y,{children:"Role"}),e.jsx(y,{children:"Station"}),e.jsx(y,{children:"Status"}),e.jsx(y,{children:"Protection"}),e.jsx(y,{children:"Actions"})]})}),e.jsx(w,{children:s.map(s=>{const a=ue(s.ID),t="admin@dfs-portal.com"===s.Email;return e.jsxs(N,{children:[e.jsx(E,{className:"font-medium",children:s.Name}),e.jsx(E,{children:s.Email}),e.jsx(E,{children:a?e.jsx(c,{variant:je(a.role),children:a.role}):e.jsx(c,{variant:"outline",children:"No Profile"})}),e.jsx(E,{children:a?.station||"N/A"}),e.jsx(E,{children:e.jsx(c,{variant:a?.is_active?"default":"secondary",children:a?.is_active?"Active":"Inactive"})}),e.jsx(E,{children:t&&e.jsxs(c,{variant:"destructive",className:"gap-1",children:[e.jsx(U,{className:"h-3 w-3"}),"Protected"]})}),e.jsx(E,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(m,{size:"sm",variant:"outline",onClick:()=>(e=>{const s=ue(e.ID);s&&(F(e),$(s),se({name:e.Name,email:e.Email,role:s.role,station:s.station,employee_id:s.employee_id,phone:s.phone,hire_date:s.hire_date?.split("T")[0]||"",is_active:s.is_active}),H(!0))})(s),disabled:!a,children:e.jsx(G,{className:"h-4 w-4"})}),e.jsx(m,{size:"sm",variant:"outline",onClick:()=>(async e=>{if("admin@dfs-portal.com"!==e.Email)try{const s=ue(e.ID);if(s){const e=await window.ezsite.apis.tableDelete(11725,{ID:s.id});if(e.error)throw new Error(e.error);re({title:"Success",description:"User profile deleted successfully"}),await xe()}}catch(s){console.error("Error deleting user:",s),re({title:"Error",description:"Failed to delete user",variant:"destructive"})}else re({title:"Cannot Delete",description:"Admin account cannot be deleted for security reasons",variant:"destructive"})})(s),disabled:!a||t,children:e.jsx(Y,{className:"h-4 w-4"})})]})})]},s.ID)})})]})})]})}),e.jsx(g,{value:"validation",className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(ie,{}),e.jsx(te,{})]})}),e.jsx(g,{value:"protection",className:"space-y-4",children:e.jsx(le,{userEmail:"admin@dfs-portal.com",showDetails:!0})})]}),e.jsx(I,{open:J,onOpenChange:H,children:e.jsxs(O,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(P,{children:e.jsxs(R,{className:"flex items-center gap-2",children:[e.jsx(G,{className:"h-5 w-5"}),"Edit User: ",V?.Name]})}),e.jsxs("div",{className:"space-y-6",children:["admin@dfs-portal.com"===V?.Email&&e.jsx(le,{userEmail:V.Email,showDetails:!0}),oe&&e.jsx(ee,{errors:de}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"name",children:"Name"}),e.jsx(h,{id:"name",value:X.name,onChange:e=>se(s=>({...s,name:e.target.value})),disabled:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"email",children:"Email"}),e.jsx(h,{id:"email",type:"email",value:X.email,onChange:e=>se(s=>({...s,email:e.target.value})),disabled:"admin@dfs-portal.com"===V?.Email})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"role",children:"Role"}),e.jsxs(A,{value:X.role,onValueChange:e=>se(s=>({...s,role:e})),disabled:"admin@dfs-portal.com"===V?.Email,children:[e.jsx(_,{children:e.jsx(D,{})}),e.jsx(S,{children:["Administrator","Management","Employee"].map(s=>e.jsx(T,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"station",children:"Station"}),e.jsxs(A,{value:X.station,onValueChange:e=>se(s=>({...s,station:e})),children:[e.jsx(_,{children:e.jsx(D,{})}),e.jsx(S,{children:["MOBIL","AMOCO ROSEDALE","AMOCO BROOKLYN"].map(s=>e.jsx(T,{value:s,children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"employee_id",children:"Employee ID"}),e.jsx(h,{id:"employee_id",value:X.employee_id,onChange:e=>se(s=>({...s,employee_id:e.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"phone",children:"Phone"}),e.jsx(h,{id:"phone",value:X.phone,onChange:e=>se(s=>({...s,phone:e.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"hire_date",children:"Hire Date"}),e.jsx(h,{id:"hire_date",type:"date",value:X.hire_date,onChange:e=>se(s=>({...s,hire_date:e.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(o,{htmlFor:"is_active",children:"Active Status"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{id:"is_active",checked:X.is_active,onCheckedChange:e=>se(s=>({...s,is_active:e})),disabled:"admin@dfs-portal.com"===V?.Email}),e.jsx("span",{className:"text-sm text-gray-600",children:X.is_active?"Active":"Inactive"})]})]})]}),X.role&&X.station&&e.jsx(te,{selectedRole:X.role,selectedStation:X.station,excludeUserId:V?.ID,autoCheck:!0}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx(m,{variant:"outline",onClick:()=>H(!1),children:"Cancel"}),e.jsxs(m,{onClick:async()=>{const e={email:X.email,role:X.role,station:X.station,user_id:V?.ID,id:M?.id,is_active:X.is_active};if(await ce(e,!!V))try{if(Z(!0),V){const e={id:M.id,role:X.role,station:X.station,employee_id:X.employee_id,phone:X.phone,hire_date:X.hire_date,is_active:X.is_active},s=await window.ezsite.apis.tableUpdate(11725,e);if(s.error)throw new Error(s.error);re({title:"Success",description:"User updated successfully in production database"})}else re({title:"Info",description:"User creation requires registration process"});await xe(),K(!1),H(!1),pe()}catch(s){console.error("Error saving user:",s),re({title:"Error",description:s instanceof Error?s.message:"Failed to save user",variant:"destructive"})}finally{Z(!1)}},disabled:Q||me||oe,children:[Q?e.jsx(B,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(L,{className:"h-4 w-4 mr-2"}),"Update User"]})]})]})]})})]})},ne=()=>{const[a,o]=C.useState([]),[h,x]=C.useState(!1),[v,f]=C.useState(""),[N,y]=C.useState(0),{toast:w}=d(),{validateUser:E,validateEmail:b,canDeleteUser:A}=ae({showToasts:!1}),_=[{id:"email-unique-1",name:"Valid New Email",description:"Test with a unique email address",testData:{email:`test-${Date.now()}@example.com`},expectedResult:"pass",category:"email"},{id:"email-duplicate-1",name:"Duplicate Admin Email",description:"Test with admin@dfs-portal.com",testData:{email:"admin@dfs-portal.com"},expectedResult:"fail",category:"email"},{id:"email-invalid-1",name:"Invalid Email Format",description:"Test with invalid email format",testData:{email:"invalid-email"},expectedResult:"fail",category:"email"},{id:"role-conflict-1",name:"Valid Employee Role",description:"Assign Employee role to new user",testData:{role:"Employee",station:"MOBIL",user_id:9999},expectedResult:"pass",category:"role"},{id:"role-conflict-2",name:"Multiple Admin Conflict",description:"Try to create second Administrator",testData:{role:"Administrator",station:"MOBIL",user_id:9999},expectedResult:"fail",category:"role"},{id:"role-invalid-1",name:"Invalid Role",description:"Test with non-existent role",testData:{role:"SuperUser",station:"MOBIL",user_id:9999},expectedResult:"fail",category:"role"},{id:"admin-protect-1",name:"Admin Role Change Block",description:"Try to change admin role to Employee",testData:{email:"admin@dfs-portal.com",role:"Employee",id:1},expectedResult:"fail",category:"admin"},{id:"admin-protect-2",name:"Admin Deactivation Block",description:"Try to deactivate admin account",testData:{email:"admin@dfs-portal.com",is_active:!1,id:1},expectedResult:"fail",category:"admin"},{id:"admin-protect-3",name:"Admin Deletion Block",description:"Try to delete admin account",testData:{userId:1,userEmail:"admin@dfs-portal.com"},expectedResult:"fail",category:"admin"}],D=async e=>{f(e.name);try{let s=!1,a="",t={};switch(e.category){case"email":"email-invalid-1"===e.id?(s=!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.testData.email),a=s?"Email format validation working":"Email format validation failed"):(s=await b(e.testData.email),a=s?"Email is unique":"Email already exists");break;case"role":const i=await E(e.testData);s=0===i.length,a=s?"Role validation passed":`Role validation failed: ${i.map(e=>e.message).join(", ")}`,t={errors:i};break;case"admin":if("admin-protect-3"===e.id)s=!(await A(e.testData.userId,e.testData.userEmail)),a=s?"Admin deletion blocked":"Admin deletion not blocked";else{const i=await E(e.testData,!0);s=i.some(e=>"admin_protection"===e.type),a=s?"Admin protection active":"Admin protection failed",t={errors:i}}break;default:s=!1,a="Unknown test category"}const i="pass"===e.expectedResult?s:!s;return{testId:e.id,passed:i,message:i?`✓ ${a}`:`✗ ${a}`,details:t}}catch(s){return{testId:e.id,passed:!1,message:`Error: ${s instanceof Error?s.message:"Unknown error"}`,details:{error:s}}}},S=e=>_.filter(s=>s.category===e),T=e=>{const s=_.filter(s=>s.category===e).map(e=>e.id);return a.filter(e=>s.includes(e.testId))},k=({category:s,title:a,description:t})=>{const d=(e=>{const s=T(e).filter(e=>e.passed).length,a=S(e).length;return{passed:s,total:a,percentage:a>0?s/a*100:0}})(s),u=T(s);return e.jsxs(i,{children:[e.jsxs(l,{children:[e.jsxs(r,{className:"flex items-center justify-between",children:[a,e.jsxs(c,{variant:d.passed===d.total?"default":"destructive",children:[d.passed,"/",d.total]})]}),e.jsx("p",{className:"text-sm text-gray-600",children:t})]}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(m,{size:"sm",onClick:()=>(async e=>{const s=_.filter(s=>s.category===e);x(!0),o([]),y(0);const a=[];for(let t=0;t<s.length;t++){const e=s[t],i=await D(e);a.push(i),o([...a]),y((t+1)/s.length*100),await new Promise(e=>setTimeout(e,300))}f(""),x(!1)})(s),disabled:h,children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Run Tests"]}),d.total>0&&e.jsxs("span",{className:"text-sm text-gray-600",children:[d.percentage.toFixed(0),"% passed"]})]}),u.length>0&&e.jsx("div",{className:"space-y-2",children:S(s).map(s=>{const a=u.find(e=>e.testId===s.id);return e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.name}),e.jsx("p",{className:"text-xs text-gray-600",children:s.description})]}),a&&e.jsxs("div",{className:"flex items-center gap-2",children:[a.passed?e.jsx(L,{className:"h-4 w-4 text-green-600"}):e.jsx(Q,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-xs",children:a.message})]})]},s.id)})})]})]})},I={passed:a.filter(e=>e.passed).length,total:a.length,percentage:a.length>0?a.filter(e=>e.passed).length/a.length*100:0};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(i,{className:"border-blue-200 bg-blue-50",children:e.jsxs(l,{children:[e.jsxs(r,{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(J,{className:"h-6 w-6"}),"User Validation Test Suite",e.jsxs(c,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:[_.length," Tests"]})]}),e.jsx("p",{className:"text-blue-700",children:"Comprehensive testing of user validation, role conflicts, and admin protection"})]})}),e.jsxs(i,{children:[e.jsx(l,{children:e.jsx(r,{children:"Test Controls"})}),e.jsxs(n,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(m,{onClick:async()=>{x(!0),o([]),y(0);const e=[];for(let t=0;t<_.length;t++){const s=_[t],a=await D(s);e.push(a),o([...e]),y((t+1)/_.length*100),await new Promise(e=>setTimeout(e,500))}f(""),x(!1);const s=e.filter(e=>e.passed).length,a=e.length;w({title:"Test Suite Complete",description:`${s}/${a} tests passed`,variant:s===a?"default":"destructive"})},disabled:h,children:[e.jsx(H,{className:"h-4 w-4 mr-2"}),"Run All Tests (",_.length,")"]}),I.total>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:["Results: ",I.passed,"/",I.total," passed"]}),e.jsxs(c,{variant:I.passed===I.total?"default":"destructive",children:[I.percentage.toFixed(0),"%"]})]})]}),h&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:v?`Running: ${v}`:"Preparing tests..."}),e.jsxs("span",{className:"text-sm text-gray-600",children:[N.toFixed(0),"%"]})]}),e.jsx(Z,{value:N,className:"w-full"})]})]})]}),e.jsxs(u,{defaultValue:"overview",className:"space-y-4",children:[e.jsxs(p,{children:[e.jsx(j,{value:"overview",children:"Overview"}),e.jsx(j,{value:"email",children:"Email Tests"}),e.jsx(j,{value:"role",children:"Role Tests"}),e.jsx(j,{value:"admin",children:"Admin Protection"})]}),e.jsxs(g,{value:"overview",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(k,{category:"email",title:"Email Uniqueness",description:"Tests for email validation and uniqueness checking"}),e.jsx(k,{category:"role",title:"Role Conflicts",description:"Tests for role assignment and conflict detection"}),e.jsx(k,{category:"admin",title:"Admin Protection",description:"Tests for admin account protection mechanisms"})]}),a.length>0&&e.jsxs(s,{className:I.passed===I.total?"border-green-200 bg-green-50":"border-orange-200 bg-orange-50",children:[I.passed===I.total?e.jsx(L,{className:"h-4 w-4 text-green-600"}):e.jsx(V,{className:"h-4 w-4 text-orange-600"}),e.jsxs(t,{className:I.passed===I.total?"text-green-700":"text-orange-700",children:["Test suite ",I.passed===I.total?"completed successfully":"completed with issues",".",I.passed,"/",I.total," tests passed (",I.percentage.toFixed(0),"%)."]})]})]}),e.jsx(g,{value:"email",children:e.jsx(k,{category:"email",title:"Email Uniqueness Tests",description:"Comprehensive testing of email validation and uniqueness"})}),e.jsx(g,{value:"role",children:e.jsx(k,{category:"role",title:"Role Conflict Tests",description:"Testing role assignment validation and conflict detection"})}),e.jsx(g,{value:"admin",children:e.jsx(k,{category:"admin",title:"Admin Protection Tests",description:"Testing admin account protection and security measures"})})]})]})},ce=()=>{const{hasAdminAccess:s}=b();return s?e.jsxs("div",{className:"space-y-6",children:[e.jsx(i,{className:"border-blue-200 bg-blue-50",children:e.jsxs(l,{children:[e.jsxs(r,{className:"flex items-center gap-2 text-blue-800",children:[e.jsx(U,{className:"h-6 w-6"}),"User Validation & Protection System",e.jsx(c,{variant:"secondary",className:"bg-blue-100 text-blue-800",children:"ADMIN ONLY"})]}),e.jsx("p",{className:"text-blue-700",children:"Comprehensive user management with role conflict prevention, email uniqueness validation, and admin account protection."})]})}),e.jsxs(u,{defaultValue:"management",className:"space-y-6",children:[e.jsxs(p,{className:"grid w-full grid-cols-2",children:[e.jsxs(j,{value:"management",className:"flex items-center gap-2",children:[e.jsx(q,{className:"h-4 w-4"}),"User Management"]}),e.jsxs(j,{value:"testing",className:"flex items-center gap-2",children:[e.jsx(J,{className:"h-4 w-4"}),"Validation Testing"]})]}),e.jsx(g,{value:"management",children:e.jsx(re,{})}),e.jsx(g,{value:"testing",className:"space-y-6",children:e.jsx(ne,{})})]})]}):e.jsx(X,{})};export{ce as default};
