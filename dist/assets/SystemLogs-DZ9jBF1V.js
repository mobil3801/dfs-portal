import{j as e}from"./radix-ui-woSLwCdF.js";import{r as s}from"./react-core-CKNU0hQt.js";import{v as t,l as a,e as l,C as i,h as r,I as c,f as n,g as d,B as o}from"./index-CIZJQuMw.js";import{T as x,a as m,b as h,c as u,d as j,e as g}from"./table-vnZa3hwR.js";import{S as p,c as v,d as f,a as N,b as w}from"./select-aqE1UuiG.js";import{u as y,B as b,C as S,a as C}from"./BatchDeleteDialog-CSYMbd-n.js";import{A}from"./AccessDenied-DixbFBF5.js";import{F as _,R as L,a1 as D,b as k,T as F,I as R,Y as E,f as T,U as B,C as P,g as I,aw as O}from"./utilities-DMEd7dY0.js";import"./routing-DcURAnU1.js";import"./data-management-r38r-ocq.js";import"./animations-CdlE0-Ca.js";const U=()=>{const{isAdmin:U}=t(),[$,V]=s.useState([]),[M,z]=s.useState(!1),[J,q]=s.useState(""),[W,Y]=s.useState("All"),[G,H]=s.useState("All"),[K,Q]=s.useState("today"),[X,Z]=s.useState(!1),[ee,se]=s.useState(!1),{toast:te}=a(),ae=y();s.useEffect(()=>{le()},[]);const le=async()=>{try{const{data:e,error:s}=await window.ezsite.apis.tablePage(12706,{PageNo:1,PageSize:100,OrderByField:"event_timestamp",IsAsc:!1,Filters:[]});if(s)return console.error("Error fetching audit logs:",s),void V([]);V(e?.List||[])}catch(e){console.error("Error fetching audit logs:",e),te({title:"Error",description:"Failed to fetch system logs",variant:"destructive"}),V([])}},ie=()=>$.filter(e=>{const s=e.event_type.toLowerCase().includes(J.toLowerCase())||e.action_performed.toLowerCase().includes(J.toLowerCase())||e.username&&e.username.toLowerCase().includes(J.toLowerCase()),t="All"===W||e.event_status===W,a="All"===G||e.event_type===G,l=new Date(e.event_timestamp),i=new Date;let r=!0;switch(K){case"today":r=l.toDateString()===i.toDateString();break;case"week":r=l>=new Date(i.getTime()-6048e5);break;case"month":r=l>=new Date(i.getTime()-2592e6);break;default:r=!0}return s&&t&&a&&r}),re=s=>{switch(s){case"Failed":return e.jsx(k,{className:"w-4 h-4 text-red-500"});case"Blocked":return e.jsx(F,{className:"w-4 h-4 text-yellow-500"});case"Success":return e.jsx(P,{className:"w-4 h-4 text-green-500"});case"Suspicious":return e.jsx(F,{className:"w-4 h-4 text-orange-500"});default:return e.jsx(R,{className:"w-4 h-4 text-blue-500"})}},ce=e=>{switch(e){case"Failed":return"bg-red-100 text-red-800";case"Blocked":return"bg-yellow-100 text-yellow-800";case"Success":return"bg-green-100 text-green-800";case"Suspicious":return"bg-orange-100 text-orange-800";default:return"bg-blue-100 text-blue-800"}},ne=s=>{switch(s){case"Login":case"Logout":case"Failed Login":case"Registration":case"Password Reset":return e.jsx(B,{className:"w-4 h-4"});case"Data Access":case"Data Modification":return e.jsx(O,{className:"w-4 h-4"});case"Permission Change":case"Admin Action":return e.jsx(I,{className:"w-4 h-4"});default:return e.jsx(_,{className:"w-4 h-4"})}},de=ie(),oe=$.filter(e=>"Failed"===e.event_status).length,xe=$.filter(e=>"Blocked"===e.event_status).length,me=$.filter(e=>"Success"===e.event_status).length;return U?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(_,{className:"w-8 h-8 text-blue-600"}),e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Audit Logs"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(l,{onClick:async()=>{z(!0);try{await le(),te({title:"Logs Refreshed",description:"System logs have been updated"})}catch(e){te({title:"Error",description:"Failed to refresh logs",variant:"destructive"})}finally{z(!1)}},disabled:M,variant:"outline",children:[e.jsx(L,{className:"w-4 h-4 mr-2 "+(M?"animate-spin":"")}),"Refresh"]}),e.jsxs(l,{onClick:()=>{const e=[["Timestamp","Event Type","Status","User","Action","Resource","IP Address","Station"],...ie().map(e=>[e.event_timestamp,e.event_type,e.event_status,e.username||"",e.action_performed||"",e.resource_accessed||"",e.ip_address||"",e.station||""])].map(e=>e.join(",")).join("\n"),s=new Blob([e],{type:"text/csv"}),t=window.URL.createObjectURL(s),a=document.createElement("a");a.href=t,a.download=`audit-logs-${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(t),te({title:"Export Complete",description:"Audit logs have been exported to CSV file"})},variant:"outline",children:[e.jsx(D,{className:"w-4 h-4 mr-2"}),"Export"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(_,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Logs"}),e.jsx("p",{className:"text-2xl font-bold",children:$.length})]})]})})}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(k,{className:"w-8 h-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Errors"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:oe})]})]})})}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(F,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Warnings"}),e.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:xe})]})]})})}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(R,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Info"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600",children:me})]})]})})})]}),e.jsx(b,{selectedCount:ae.selectedCount,onBatchDelete:()=>{0!==ae.getSelectedData(de,e=>e.id).length?Z(!0):te({title:"No Selection",description:"Please select log entries to delete",variant:"destructive"})},onClearSelection:ae.clearSelection,isLoading:ee,showEdit:!1}),e.jsx(i,{children:e.jsx(r,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(E,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(c,{placeholder:"Search logs...",value:J,onChange:e=>q(e.target.value),className:"pl-10"})]}),e.jsxs(p,{value:W,onValueChange:Y,children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Filter by level"})}),e.jsxs(N,{children:[e.jsx(w,{value:"All",children:"All Levels"}),["Success","Failed","Blocked","Suspicious"].map(s=>e.jsx(w,{value:s,children:s},s))]})]}),e.jsxs(p,{value:G,onValueChange:H,children:[e.jsx(v,{children:e.jsx(f,{placeholder:"Filter by category"})}),e.jsxs(N,{children:[e.jsx(w,{value:"All",children:"All Categories"}),["Login","Logout","Failed Login","Registration","Password Reset","Data Access","Data Modification","Permission Change","Admin Action"].map(s=>e.jsx(w,{value:s,children:s},s))]})]}),e.jsxs(p,{value:K,onValueChange:Q,children:[e.jsx(v,{children:e.jsx(f,{})}),e.jsx(N,{children:[{value:"today",label:"Today"},{value:"week",label:"Last 7 days"},{value:"month",label:"Last 30 days"},{value:"all",label:"All time"}].map(s=>e.jsx(w,{value:s.value,children:s.label},s.value))})]}),e.jsx(l,{variant:"outline",onClick:()=>{q(""),Y("All"),H("All"),Q("today")},children:"Clear Filters"})]})})}),e.jsxs(i,{children:[e.jsx(n,{children:e.jsxs(d,{children:["Audit Logs (",de.length,")"]})}),e.jsxs(r,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(x,{children:[e.jsx(m,{children:e.jsxs(h,{children:[e.jsx(u,{className:"w-12",children:e.jsx(S,{checked:de.length>0&&ae.selectedCount===de.length,onCheckedChange:()=>ae.toggleSelectAll(de,e=>e.id),"aria-label":"Select all logs"})}),e.jsx(u,{children:"Time"}),e.jsx(u,{children:"Status"}),e.jsx(u,{children:"Event Type"}),e.jsx(u,{children:"Action"}),e.jsx(u,{children:"User"}),e.jsx(u,{children:"IP Address"})]})}),e.jsx(j,{children:de.map(s=>e.jsxs(h,{className:ae.isSelected(s.id)?"bg-blue-50":"",children:[e.jsx(g,{children:e.jsx(S,{checked:ae.isSelected(s.id),onCheckedChange:()=>ae.toggleItem(s.id),"aria-label":`Select log ${s.id}`})}),e.jsx(g,{className:"font-mono text-sm",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{children:new Date(s.event_timestamp).toLocaleString()})]})}),e.jsx(g,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[re(s.event_status),e.jsx(o,{className:ce(s.event_status),children:s.event_status})]})}),e.jsx(g,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[ne(s.event_type),e.jsx("span",{children:s.event_type})]})}),e.jsxs(g,{className:"max-w-md",children:[e.jsx("div",{className:"truncate",title:s.action_performed,children:s.action_performed}),s.failure_reason&&e.jsxs("div",{className:"text-xs text-red-600 mt-1",children:["Reason: ",s.failure_reason]}),s.additional_data&&"{}"!==s.additional_data&&e.jsxs("details",{className:"mt-1",children:[e.jsx("summary",{className:"text-xs text-gray-500 cursor-pointer hover:text-gray-700",children:"View details"}),e.jsx("pre",{className:"text-xs bg-gray-50 p-2 rounded mt-1 overflow-x-auto",children:JSON.stringify(JSON.parse(s.additional_data),null,2)})]})]}),e.jsx(g,{children:s.username&&e.jsxs("div",{className:"flex items-center space-x-1",children:[e.jsx(B,{className:"w-3 h-3 text-gray-400"}),e.jsx("span",{className:"text-sm",children:s.username})]})}),e.jsx(g,{className:"font-mono text-sm",children:s.ip_address})]},s.id))})]})}),0===de.length&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No logs found matching the current filters."})]})]}),e.jsx(C,{isOpen:X,onClose:()=>Z(!1),onConfirm:async()=>{se(!0);try{const e=ae.getSelectedData(de,e=>e.id),s=e.map(e=>e.id),t=$.filter(e=>!s.includes(e.id));V(t),te({title:"Success",description:`Deleted ${e.length} log entries successfully`}),Z(!1),ae.clearSelection()}catch(e){console.error("Error in batch delete:",e),te({title:"Error",description:`Failed to delete log entries: ${e}`,variant:"destructive"})}finally{se(!1)}},selectedCount:ae.selectedCount,isLoading:ee,itemName:"log entries",selectedItems:ae.getSelectedData(de,e=>e.id).map(e=>({id:e.id,name:`${e.level} - ${e.category} - ${e.message.substring(0,50)}...`}))})]}):e.jsx(A,{feature:"System Logs",requiredRole:"Administrator"})};export{U as default};
