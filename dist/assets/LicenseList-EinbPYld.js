import{j as e}from"./radix-ui-woSLwCdF.js";import{r as t}from"./react-core-CKNU0hQt.js";import{D as s,a,b as n,c as i,e as r,C as o,f as c,g as l,B as d,h as m,S as u,o as g,u as h,t as p,k as x,I as f,d as y}from"./index-mhPlV2HJ.js";import{T as v,a as b,b as S,c as w,d as j,e as N}from"./table-CifGLKnD.js";import{g as C,a9 as _,F as D,n as M,X as E,C as k,T as A,an as L,ao as P,ap as F,W as I,Y as z,Z as T,V as $}from"./utilities-BBdJI3Xi.js";import{S as O}from"./supabaseMigrationHelper-B4g1uCE9.js";import{u as B}from"./routing-DcURAnU1.js";import"./data-management-r38r-ocq.js";import"./animations-CdlE0-Ca.js";const R=({license:t,isOpen:h,onClose:p})=>{if(!t)return null;const x=e=>e?new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}):"N/A",f=((e,t)=>{const s=new Date,a=new Date(t),n=Math.ceil((a.getTime()-s.getTime())/864e5);switch(e.toLowerCase()){case"active":return n<=30?{color:"text-yellow-600",bgColor:"bg-yellow-50",borderColor:"border-yellow-200",icon:"⚠️",message:`Expires in ${n} days - Renewal Required Soon`}:n<=90?{color:"text-blue-600",bgColor:"bg-blue-50",borderColor:"border-blue-200",icon:"📅",message:`Expires in ${n} days - Plan Renewal`}:{color:"text-green-600",bgColor:"bg-green-50",borderColor:"border-green-200",icon:"✅",message:"Active and Valid"};case"expired":return{color:"text-red-600",bgColor:"bg-red-50",borderColor:"border-red-200",icon:"❌",message:`Expired ${Math.abs(n)} days ago - Immediate Action Required`};case"pending renewal":return{color:"text-yellow-600",bgColor:"bg-yellow-50",borderColor:"border-yellow-200",icon:"⏳",message:"Renewal in Progress"};default:return{color:"text-gray-600",bgColor:"bg-gray-50",borderColor:"border-gray-200",icon:"❓",message:"Status Unknown"}}})(t.status,t.expiry_date),y={Business:{icon:"🏢",description:"General business operations license"},Environmental:{icon:"🌱",description:"Environmental compliance and permits"},Safety:{icon:"🦺",description:"Safety regulations and protocols"},Health:{icon:"🏥",description:"Public health requirements"},Fire:{icon:"🔥",description:"Fire safety and prevention"},Building:{icon:"🏗️",description:"Construction and building permits"}}[t.category]||{icon:"📄",description:"License certification"};const v={MOBIL:{color:"bg-red-500",description:"Mobil Gas Station"},"AMOCO ROSEDALE":{color:"bg-blue-500",description:"Amoco Rosedale Station"},"AMOCO BROOKLYN":{color:"bg-green-500",description:"Amoco Brooklyn Station"},ALL:{color:"bg-gray-500",description:"All Station Locations"}}[b=t.station]||{color:"bg-gray-500",description:b};var b;const S=()=>{const e=`\n      <!DOCTYPE html>\n      <html>\n        <head>\n          <title>License Certificate - ${t.license_name}</title>\n          <style>\n            @page {\n              size: A4;\n              margin: 0.5in;\n            }\n            body {\n              font-family: 'Arial', sans-serif;\n              margin: 0;\n              padding: 0;\n              color: #333;\n              line-height: 1.5;\n            }\n            .certificate-header {\n              text-align: center;\n              margin-bottom: 40px;\n              border: 3px solid #2563eb;\n              padding: 30px;\n              border-radius: 15px;\n              background: linear-gradient(135deg, #f8fafc, #e2e8f0);\n            }\n            .company-logo {\n              font-size: 32px;\n              font-weight: bold;\n              color: #1e40af;\n              margin-bottom: 10px;\n            }\n            .certificate-title {\n              font-size: 24px;\n              color: #374151;\n              margin-bottom: 15px;\n              text-transform: uppercase;\n              letter-spacing: 2px;\n            }\n            .certificate-subtitle {\n              font-size: 16px;\n              color: #6b7280;\n              font-style: italic;\n            }\n            .license-info {\n              background: white;\n              border: 2px solid #e5e7eb;\n              border-radius: 10px;\n              padding: 30px;\n              margin: 30px 0;\n              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n            }\n            .license-name {\n              font-size: 28px;\n              font-weight: bold;\n              text-align: center;\n              color: #1f2937;\n              margin-bottom: 20px;\n              padding: 15px;\n              background: #f3f4f6;\n              border-radius: 8px;\n            }\n            .info-grid {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 20px;\n              margin: 25px 0;\n            }\n            .info-item {\n              padding: 15px;\n              border: 1px solid #e5e7eb;\n              border-radius: 8px;\n              background: #fafafa;\n            }\n            .info-label {\n              font-size: 12px;\n              color: #6b7280;\n              text-transform: uppercase;\n              font-weight: 600;\n              margin-bottom: 8px;\n            }\n            .info-value {\n              font-size: 16px;\n              font-weight: bold;\n              color: #1f2937;\n            }\n            .status-section {\n              background: ${f.bgColor};\n              border: 2px solid ${f.borderColor.replace("border-","")};\n              border-radius: 10px;\n              padding: 20px;\n              margin: 25px 0;\n              text-align: center;\n            }\n            .status-icon {\n              font-size: 48px;\n              margin-bottom: 10px;\n            }\n            .status-message {\n              font-size: 18px;\n              font-weight: bold;\n              color: ${f.color.replace("text-","")};\n              margin-bottom: 10px;\n            }\n            .dates-section {\n              display: grid;\n              grid-template-columns: repeat(2, 1fr);\n              gap: 20px;\n              margin: 25px 0;\n            }\n            .date-card {\n              text-align: center;\n              padding: 20px;\n              border: 2px solid #e5e7eb;\n              border-radius: 10px;\n              background: white;\n            }\n            .date-label {\n              font-size: 14px;\n              color: #6b7280;\n              text-transform: uppercase;\n              font-weight: 600;\n              margin-bottom: 10px;\n            }\n            .date-value {\n              font-size: 18px;\n              font-weight: bold;\n              color: #1f2937;\n            }\n            .authority-section {\n              background: #f0f9ff;\n              border: 2px solid #0ea5e9;\n              border-radius: 10px;\n              padding: 20px;\n              margin: 25px 0;\n            }\n            .category-badge {\n              display: inline-block;\n              padding: 8px 16px;\n              border-radius: 20px;\n              font-size: 14px;\n              font-weight: 600;\n              margin: 5px;\n            }\n            .station-badge {\n              background: ${v.color};\n              color: white;\n            }\n            .category-business { background: #dbeafe; color: #1e40af; }\n            .category-environmental { background: #dcfce7; color: #166534; }\n            .category-safety { background: #fed7aa; color: #c2410c; }\n            .category-health { background: #e9d5ff; color: #7c2d12; }\n            .category-fire { background: #fecaca; color: #dc2626; }\n            .category-building { background: #f3f4f6; color: #374151; }\n            .footer {\n              margin-top: 50px;\n              text-align: center;\n              font-size: 12px;\n              color: #6b7280;\n              border-top: 2px solid #e5e7eb;\n              padding-top: 30px;\n            }\n            .official-seal {\n              position: absolute;\n              top: 20px;\n              right: 20px;\n              width: 80px;\n              height: 80px;\n              border: 3px solid #2563eb;\n              border-radius: 50%;\n              display: flex;\n              align-items: center;\n              justify-content: center;\n              background: white;\n              font-size: 10px;\n              text-align: center;\n              font-weight: bold;\n              color: #2563eb;\n            }\n            .watermark {\n              position: fixed;\n              top: 50%;\n              left: 50%;\n              transform: translate(-50%, -50%) rotate(-45deg);\n              font-size: 120px;\n              color: rgba(37, 99, 235, 0.05);\n              font-weight: bold;\n              z-index: -1;\n              pointer-events: none;\n            }\n            @media print {\n              body { font-size: 11pt; }\n            }\n          </style>\n        </head>\n        <body>\n          <div class="watermark">OFFICIAL</div>\n          <div class="official-seal">\n            DFS<br>OFFICIAL<br>SEAL\n          </div>\n\n          <div class="certificate-header">\n            <div class="company-logo">DFS Manager Portal</div>\n            <div class="certificate-title">License & Certificate Record</div>\n            <div class="certificate-subtitle">Official Documentation System</div>\n          </div>\n\n          <div class="license-info">\n            <div class="license-name">${t.license_name}</div>\n            \n            <div class="info-grid">\n              <div class="info-item">\n                <div class="info-label">License Number</div>\n                <div class="info-value" style="font-family: monospace; font-size: 18px;">${t.license_number}</div>\n              </div>\n              <div class="info-item">\n                <div class="info-label">Record ID</div>\n                <div class="info-value">#${t.ID}</div>\n              </div>\n              <div class="info-item">\n                <div class="info-label">Category</div>\n                <div class="info-value">\n                  <span class="category-badge category-${t.category.toLowerCase()}">${y.icon} ${t.category}</span>\n                </div>\n              </div>\n              <div class="info-item">\n                <div class="info-label">Station Coverage</div>\n                <div class="info-value">\n                  <span class="category-badge station-badge">${t.station}</span>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div class="dates-section">\n            <div class="date-card">\n              <div class="date-label">📅 Issue Date</div>\n              <div class="date-value">${x(t.issue_date)}</div>\n            </div>\n            <div class="date-card">\n              <div class="date-label">⏰ Expiry Date</div>\n              <div class="date-value">${x(t.expiry_date)}</div>\n            </div>\n          </div>\n\n          <div class="status-section">\n            <div class="status-icon">${f.icon}</div>\n            <div class="status-message">${t.status.toUpperCase()}</div>\n            <div style="font-size: 14px; color: #6b7280;">${f.message}</div>\n          </div>\n\n          <div class="authority-section">\n            <div class="info-label">Issuing Authority</div>\n            <div style="font-size: 20px; font-weight: bold; color: #0ea5e9; margin-top: 10px;">\n              ${t.issuing_authority}\n            </div>\n            <div style="font-size: 14px; color: #6b7280; margin-top: 10px;">\n              ${y.description}\n            </div>\n          </div>\n\n          <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin: 25px 0;">\n            <div class="info-label">Document Information</div>\n            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">\n              <div>\n                <span style="font-size: 12px; color: #6b7280;">File Reference ID:</span><br>\n                <span style="font-weight: bold;">${t.document_file_id||"Not Available"}</span>\n              </div>\n              <div>\n                <span style="font-size: 12px; color: #6b7280;">Created by User:</span><br>\n                <span style="font-weight: bold;">#${t.created_by}</span>\n              </div>\n            </div>\n          </div>\n\n          <div class="footer">\n            <div style="font-weight: bold; margin-bottom: 10px;">\n              This is an official license certificate document\n            </div>\n            <div>\n              Generated on ${(new Date).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}\n            </div>\n            <div style="margin-top: 15px; font-style: italic;">\n              DFS Manager Portal - License Management System v2.0\n            </div>\n            <div style="margin-top: 10px; font-size: 10px;">\n              This document is valid only when accompanied by the original license certificate.\n              For verification, contact the issuing authority directly.\n            </div>\n          </div>\n        </body>\n      </html>\n    `,s=window.open("","_blank");s&&(s.document.write(e),s.document.close(),s.focus(),setTimeout(()=>{s.print(),s.close()},500))};return e.jsx(s,{open:h,onOpenChange:p,children:e.jsxs(a,{className:"max-w-4xl max-h-[95vh] overflow-y-auto",children:[e.jsx(n,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(i,{className:"flex items-center gap-2",children:[e.jsx(C,{className:"h-5 w-5 text-blue-600"}),"Enhanced License Certificate - ",t.license_name]}),e.jsxs(r,{onClick:S,variant:"outline",size:"sm",className:"flex items-center gap-2 text-blue-600 hover:text-blue-700 hover:bg-blue-50",children:[e.jsx(_,{className:"h-4 w-4"}),"Print Certificate"]})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(o,{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200",children:e.jsx(c,{children:e.jsxs("div",{className:"text-center",children:[e.jsx(l,{className:"text-2xl text-blue-800 mb-2",children:t.license_name}),e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx(d,{className:`${v.color} text-white`,children:t.station}),e.jsx(d,{variant:"outline",className:"text-blue-600",children:t.license_number})]})]})})}),e.jsx(o,{className:`border-2 ${f.borderColor} ${f.bgColor}`,children:e.jsxs(m,{className:"p-6 text-center",children:[e.jsx("div",{className:"text-4xl mb-2",children:f.icon}),e.jsx("div",{className:`text-xl font-bold ${f.color} mb-2`,children:t.status.toUpperCase()}),e.jsx("div",{className:"text-sm text-gray-600",children:f.message})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(o,{children:[e.jsx(c,{children:e.jsxs(l,{className:"text-sm flex items-center gap-2",children:[e.jsx(D,{className:"h-4 w-4"}),"License Details"]})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase font-medium",children:"Category"}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-lg",children:y.icon}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:t.category}),e.jsx("div",{className:"text-xs text-gray-500",children:y.description})]})]})]}),e.jsx(u,{}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase font-medium",children:"Issuing Authority"}),e.jsx("div",{className:"font-medium mt-1",children:t.issuing_authority})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase font-medium",children:"Document File ID"}),e.jsx("div",{className:"font-medium mt-1",children:t.document_file_id||"Not Available"})]})]})]}),e.jsxs(o,{children:[e.jsx(c,{children:e.jsxs(l,{className:"text-sm flex items-center gap-2",children:[e.jsx(M,{className:"h-4 w-4"}),"Important Dates"]})}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase font-medium",children:"Issue Date"}),e.jsx("div",{className:"font-medium mt-1",children:x(t.issue_date)})]}),e.jsx(u,{}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase font-medium",children:"Expiry Date"}),e.jsx("div",{className:"font-medium mt-1",children:x(t.expiry_date)})]}),e.jsx(u,{}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 uppercase font-medium",children:"Station Coverage"}),e.jsxs("div",{className:"mt-1",children:[e.jsx(d,{className:`${v.color} text-white`,children:t.station}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:v.description})]})]})]})]})]}),e.jsxs(o,{children:[e.jsx(c,{children:e.jsx(l,{className:"text-sm",children:"System Information"})}),e.jsx(m,{children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Record ID:"}),e.jsxs("span",{className:"font-medium",children:["#",t.ID]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Created by User:"}),e.jsxs("span",{className:"font-medium",children:["#",t.created_by]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Document Generated:"}),e.jsx("span",{className:"font-medium",children:(w=(new Date).toISOString(),w?new Date(w).toLocaleDateString():"N/A")})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"System Version:"}),e.jsx("span",{className:"font-medium",children:"DFS Portal v2.0"})]})]})})]})]}),e.jsxs(g,{className:"flex justify-end space-x-2",children:[e.jsxs(r,{variant:"outline",onClick:p,children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Close"]}),e.jsxs(r,{onClick:S,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(_,{className:"w-4 h-4 mr-2"}),"Print Certificate"]})]})]})});var w};class q{config=null;isConfigured=!1;testNumbers=[];apiBaseUrl="https://rest.clicksend.com/v3";constructor(){this.initializeWithCredentials()}async initializeWithCredentials(){try{await this.configure({username:"mobil3801beach@gmail.com",apiKey:"54DC23E4-34D7-C6B1-0601-112E36A46B49",fromNumber:"DFS",testMode:!1,webhookUrl:void 0}),console.log("ClickSend SMS service initialized with provided credentials")}catch(e){console.error("Failed to initialize ClickSend with provided credentials:",e)}}async configure(e){this.config=e,this.isConfigured=!0;try{await this.validateCredentials(),console.log("ClickSend SMS service configured successfully")}catch(t){throw console.error("Failed to configure ClickSend:",t),this.isConfigured=!1,t}}async loadConfiguration(){this.isConfigured||await this.initializeWithCredentials();try{const{data:e,error:t}=await window.ezsite.apis.tablePage(24201,{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_enabled",op:"Equal",value:!0}]});if(!t&&e?.List&&e.List.length>0){const t=e.List[0];await this.configure({username:t.username||"mobil3801beach@gmail.com",apiKey:t.api_key||"54DC23E4-34D7-C6B1-0601-112E36A46B49",fromNumber:t.from_number||"DFS",testMode:t.test_mode||!1,webhookUrl:t.webhook_url})}}catch(e){console.error("Error loading SMS configuration:",e)}}async validateCredentials(){if(!this.config)return!1;try{return(await this.makeClickSendRequest("GET","/account")).success}catch(e){return console.error("ClickSend credential validation failed:",e),!1}}async makeClickSendRequest(e,t,s){if(!this.config)throw new Error("SMS service not configured");const a=`${this.apiBaseUrl}${t}`,n=btoa(`${this.config.username}:${this.config.apiKey}`);try{const t={method:e,headers:{Authorization:`Basic ${n}`,"Content-Type":"application/json"}};!s||"POST"!==e&&"PUT"!==e||(t.body=JSON.stringify(s));const i=await fetch(a,t),r=await i.json();if(!i.ok)throw new Error(r.response_msg||r.error_message||`HTTP ${i.status}: ${i.statusText}`);return{success:!0,data:r}}catch(i){return console.error("ClickSend API request failed:",i),{success:!1,error:i instanceof Error?i.message:"Unknown error"}}}async sendSMS(e){if(!this.isConfigured||!this.config)return{success:!1,error:"SMS service not configured. Please configure ClickSend settings."};if(!this.isValidPhoneNumber(e.to))return{success:!1,error:"Invalid phone number format. Use E.164 format (+1234567890)"};if(this.config.testMode&&!this.testNumbers.includes(e.to))return{success:!1,error:"Test mode is enabled. Phone number must be verified for testing."};try{await this.checkDailyLimit();let t=e.message;e.templateId&&(t=await this.processTemplate(e.templateId,e.placeholders||{}));const s=await this.sendToClickSend({to:e.to,message:t,type:e.type});return await this.logSMSHistory({recipient_phone:e.to,message_content:t,status:s.success?"Sent":"Failed",sent_at:(new Date).toISOString(),sms_provider_id:s.clickSendMessageId,error_message:s.error,cost:s.cost||0}),s.success&&await this.updateDailyCount(),s}catch(t){return console.error("SMS sending error:",t),{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}async sendToClickSend(e){try{const t={messages:[{source:this.config?.fromNumber||"DFS",to:e.to,body:e.message}]};console.log("Sending to ClickSend:",t);const s=await this.makeClickSendRequest("POST","/sms/send",t);if(s.success&&s.data?.data?.messages?.[0]){const e=s.data.data.messages[0];return{success:"SUCCESS"===e.status,messageId:e.message_id,clickSendMessageId:e.message_id,cost:parseFloat(e.message_price)||0,status:e.status,error:"SUCCESS"!==e.status?e.custom_string:void 0}}return{success:!1,error:s.error||"Failed to send SMS"}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error occurred"}}}async processTemplate(e,t){try{const{data:s,error:a}=await window.ezsite.apis.tablePage("sms_templates",{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"id",op:"Equal",value:e}]});if(a)throw new Error(a);if(s?.List&&s.List.length>0){let e=s.List[0].message_content;return Object.entries(t).forEach(([t,s])=>{e=e.replace(new RegExp(`{${t}}`,"g"),s)}),e}throw new Error("Template not found")}catch(s){throw console.error("Error processing template:",s),s}}async checkDailyLimit(){try{const{data:e,error:t}=await window.ezsite.apis.tablePage(24201,{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_enabled",op:"Equal",value:!0}]});if(t)throw new Error(t);if(e?.List&&e.List.length>0){const t=e.List[0],s=(new Date).toISOString().split("T")[0],{data:a}=await window.ezsite.apis.tablePage(24202,{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"sent_at",op:"StringStartsWith",value:s},{name:"status",op:"Equal",value:"Sent"}]});if((a?.VirtualCount||0)>=t.daily_limit)throw new Error("Daily SMS limit exceeded. Please contact administrator or wait for tomorrow.")}}catch(e){throw console.error("Error checking daily limit:",e),e}}async updateDailyCount(){}async logSMSHistory(e){try{await window.ezsite.apis.tableCreate(24202,{...e,sent_by_user_id:1})}catch(t){console.error("Error logging SMS history:",t)}}isValidPhoneNumber(e){return/^\+[1-9]\d{1,14}$/.test(e)}async sendBulkSMS(e){const t=[];for(const a of e)try{const e=await this.sendSMS(a);t.push(e),await new Promise(e=>setTimeout(e,500))}catch(s){t.push({success:!1,error:s instanceof Error?s.message:"Unknown error"})}return t}async getDeliveryStatus(e){if(!this.isConfigured)throw new Error("SMS service not configured");try{const t=await this.makeClickSendRequest("GET",`/sms/history/${e}`);if(t.success&&t.data){const e=t.data.data.status;return{status:e,delivered:"Delivered"===e}}return{status:"unknown",delivered:!1}}catch(t){return console.error("Error getting delivery status:",t),{status:"error",delivered:!1}}}async testSMS(e){const t={to:e,message:`DFS Manager SMS Test - ${(new Date).toLocaleString()}. If you receive this message, ClickSend SMS is working correctly with your provided credentials.`,type:"test"};return this.sendSMS(t)}async addTestNumber(e){if(!this.isValidPhoneNumber(e))throw new Error("Invalid phone number format");this.testNumbers.push(e)}async removeTestNumber(e){this.testNumbers=this.testNumbers.filter(t=>t!==e)}getTestNumbers(){return[...this.testNumbers]}async getDailyUsage(){try{const{data:e,error:t}=await window.ezsite.apis.tablePage(24201,{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_enabled",op:"Equal",value:!0}]});if(t)throw new Error(t);if(e?.List&&e.List.length>0){const t=e.List[0],s=(new Date).toISOString().split("T")[0],{data:a}=await window.ezsite.apis.tablePage(24202,{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"sent_at",op:"StringStartsWith",value:s},{name:"status",op:"Equal",value:"Sent"}]}),n=a?.VirtualCount||0,i=t.daily_limit;return{used:n,limit:i,percentage:n/i*100}}return{used:0,limit:100,percentage:0}}catch(e){return console.error("Error getting daily usage:",e),{used:0,limit:100,percentage:0}}}isServiceConfigured(){return this.isConfigured}getConfiguration(){return this.config}async getServiceStatus(){try{if(!this.isConfigured)return{available:!1,message:"SMS service not configured. Please configure ClickSend settings."};const e=await this.makeClickSendRequest("GET","/account"),t=[{name:"ClickSend",available:this.isConfigured&&e.success}],s={quotaRemaining:e.success&&e.data?.data?.balance||0};return{available:e.success,message:e.success?"ClickSend SMS service is configured and ready":"ClickSend connection failed",providers:t,quota:s}}catch(e){return console.error("Error checking service status:",e),{available:!1,message:"Error checking service status"}}}async sendSimpleSMS(e,t,s){const a=this.config;s&&this.config&&(this.config={...this.config,fromNumber:s});try{return await this.sendSMS({to:e,message:t,type:"custom"})}finally{a&&(this.config=a)}}async getAvailableFromNumbers(){try{const{data:e,error:t}=await window.ezsite.apis.tablePage(24201,{PageNo:1,PageSize:10,OrderByField:"id",IsAsc:!1,Filters:[]});if(t)throw new Error(t);return(e?.List||[]).map(e=>({number:e.from_number||"DFS",provider:"ClickSend",isActive:e.is_enabled,testMode:e.test_mode||!1}))}catch(e){return console.error("Error getting available from numbers:",e),[{number:"DFS",provider:"ClickSend",isActive:!0,testMode:!1}]}}async sendCustomSMS(e,t,s){return this.sendSimpleSMS(e,t,s)}async getAccountBalance(){try{const e=await this.makeClickSendRequest("GET","/account");return e.success&&e.data&&e.data.data.balance||0}catch(e){return console.error("Error getting account balance:",e),0}}}const U=new q;new class extends q{async loadEnvironmentConfig(){try{const e={username:"mobil3801beach@gmail.com",apiKey:"54DC23E4-34D7-C6B1-0601-112E36A46B49",fromNumber:"DFS",testMode:!1,webhookUrl:void 0};await this.configure(e),console.log("ClickSend SMS service configured with provided credentials")}catch(e){throw console.error("Error loading SMS configuration:",e),e}}async initializeForProduction(){try{await this.loadEnvironmentConfig(),console.log("Production ClickSend SMS service initialized with your credentials")}catch(e){throw console.error("Failed to initialize production SMS service:",e),e}}};new class{constructor(e=U){this.baseService=e,this.initializeBaseService()}jobQueue=new Map;retryQueue=[];async initializeBaseService(){try{console.log("🔧 Enhanced ClickSend SMS service initialized")}catch(e){console.error("Failed to initialize enhanced SMS service:",e)}}async sendAdvancedSMS(e,t,s={}){try{let a=t;if(s.template&&s.variables&&(a=this.processMessageTemplate(s.template,s.variables)),s.scheduledTime&&s.scheduledTime>new Date)return this.scheduleMessage(e,a,s);const n={to:e,message:a,type:s.priority||"normal"},i=await this.baseService.sendSMS(n);return!i.success&&s.retryAttempts&&s.retryAttempts>0&&this.addToRetryQueue(n,s.retryAttempts),await this.logAdvancedAnalytics(e,a,i,s),i}catch(a){return console.error("Advanced SMS sending error:",a),{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}processMessageTemplate(e,t){let s=e;return Object.entries(t).forEach(([e,t])=>{const a=new RegExp(`{{${e}}}`,"g");s=s.replace(a,t)}),s}async scheduleMessage(e,t,s){const a=s.scheduledTime.getTime()-Date.now();return a>0?(setTimeout(async()=>{await this.baseService.sendSMS({to:e,message:t,type:"scheduled"})},a),{success:!0,messageId:`scheduled_${Date.now()}`,status:"scheduled"}):this.baseService.sendSMS({to:e,message:t,type:"immediate"})}addToRetryQueue(e,t){this.retryQueue.push({message:e,attempts:0,maxAttempts:t})}async processRetryQueue(){const e=[...this.retryQueue];this.retryQueue=[];for(const s of e){s.attempts++;try{!(await this.baseService.sendSMS(s.message)).success&&s.attempts<s.maxAttempts&&setTimeout(()=>{this.retryQueue.push(s)},1e3*Math.pow(2,s.attempts))}catch(t){console.error("Retry queue processing error:",t)}}}async sendBulkSMSWithProgress(e){const t=`bulk_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={id:t,status:"pending",totalMessages:e.length,sentMessages:0,failedMessages:0,createdAt:new Date};return this.jobQueue.set(t,s),this.processBulkJob(t,e),s}async processBulkJob(e,t){const s=this.jobQueue.get(e);if(s){s.status="processing";for(const{phoneNumber:e,message:n,options:i}of t)try{(await this.sendAdvancedSMS(e,n,i||{})).success?s.sentMessages++:s.failedMessages++,await new Promise(e=>setTimeout(e,200))}catch(a){s.failedMessages++,console.error(`Bulk SMS error for ${e}:`,a)}s.status="completed",s.completedAt=new Date}}getBulkJobStatus(e){return this.jobQueue.get(e)||null}async getSMSAnalytics(e){try{const t=[];e&&t.push({name:"sent_at",op:"GreaterThanOrEqual",value:e.start.toISOString()},{name:"sent_at",op:"LessThanOrEqual",value:e.end.toISOString()});const{data:s,error:a}=await window.ezsite.apis.tablePage(24062,{PageNo:1,PageSize:1e3,OrderByField:"sent_at",IsAsc:!1,Filters:t});if(a)throw new Error(a);const n=s?.List||[],i=n.length,r=n.filter(e=>"Delivered"===e.status).length,o=n.filter(e=>"Failed"===e.status).length,c=i>0?r/i*100:0,l=n.reduce((e,t)=>e+(t.cost||0),0),d=i>0?l/i:0,m=n.reduce((e,t)=>(e[t.recipient_phone]=(e[t.recipient_phone]||0)+1,e),{}),u=Object.entries(m).map(([e,t])=>({phone:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,10);return{totalSent:i,totalDelivered:r,totalFailed:o,deliveryRate:c,averageCost:d,topRecipients:u,dailyStats:this.calculateDailyStats(n)}}catch(t){throw console.error("Error getting SMS analytics:",t),t}}calculateDailyStats(e){const t=new Map;return e.forEach(e=>{const s=e.sent_at?.split("T")[0];if(!s)return;t.has(s)||t.set(s,{sent:0,delivered:0});const a=t.get(s);a.sent++,"Delivered"===e.status&&a.delivered++}),Array.from(t.entries()).map(([e,t])=>({date:e,...t})).sort((e,t)=>e.date.localeCompare(t.date)).slice(-30)}async logAdvancedAnalytics(e,t,s,a){console.log("SMS Analytics:",{phoneNumber:e,messageLength:t.length,success:s.success,cost:s.cost,priority:a.priority,timestamp:(new Date).toISOString()})}async sendEmergencyAlert(e,t={}){try{const{data:s,error:a}=await window.ezsite.apis.tablePage(24061,{PageNo:1,PageSize:100,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_emergency",op:"Equal",value:!0},{name:"is_active",op:"Equal",value:!0}]});if(a)throw new Error(a);const n=s?.List||[],i=[];for(const r of n){const s=await this.sendAdvancedSMS(r.phone_number,`🚨 EMERGENCY ALERT: ${e}`,{...t,priority:"high"});i.push(s),await new Promise(e=>setTimeout(e,100))}return i}catch(s){throw console.error("Emergency alert sending error:",s),s}}async validatePhoneNumbers(e){const t=[],s=[];return e.forEach(e=>{/^\+[1-9]\d{1,14}$/.test(e)?t.push(e):s.push(e)}),{valid:t,invalid:s}}async getServiceHealth(){const e=Date.now();try{if(!this.baseService.isServiceConfigured())return{status:"down",lastCheck:new Date,responseTime:0,errorRate:100,balance:0};const t=await this.baseService.getServiceStatus(),s=Date.now()-e,a=new Date;a.setDate(a.getDate()-1);const{data:n}=await window.ezsite.apis.tablePage(24062,{PageNo:1,PageSize:100,OrderByField:"sent_at",IsAsc:!1,Filters:[{name:"sent_at",op:"GreaterThanOrEqual",value:a.toISOString()}]}),i=n?.List||[],r=i.filter(e=>"Failed"===e.status).length,o=i.length>0?r/i.length*100:0,c=await this.baseService.getAccountBalance();let l="healthy";return t.available?(o>10||s>5e3||c<10)&&(l="degraded"):l="down",{status:l,lastCheck:new Date,responseTime:s,errorRate:o,balance:c}}catch(t){return console.error("Service health check error:",t),{status:"down",lastCheck:new Date,responseTime:Date.now()-e,errorRate:100,balance:0}}}async createMessageTemplate(e,t,s="custom"){try{await window.ezsite.apis.tableCreate("sms_templates",{template_name:e,message_content:t,template_type:s,is_active:!0,priority_level:"normal",created_by:1})}catch(a){throw console.error("Error creating message template:",a),a}}async getMessageTemplates(){try{const{data:e,error:t}=await window.ezsite.apis.tablePage("sms_templates",{PageNo:1,PageSize:100,OrderByField:"template_name",IsAsc:!0,Filters:[{name:"is_active",op:"Equal",value:!0}]});if(t)throw new Error(t);return e?.List||[]}catch(e){return console.error("Error getting message templates:",e),[]}}async sendSMS(e){return this.baseService.sendSMS(e)}async testSMS(e){return this.baseService.testSMS(e)}async getAccountBalance(){return this.baseService.getAccountBalance()}async getServiceStatus(){return this.baseService.getServiceStatus()}isServiceConfigured(){return this.baseService.isServiceConfigured()}};class G{constructor(){console.log("Legacy SMS Service initialized - All requests will be handled by ClickSend")}async configure(e){return console.log("Redirecting configuration to ClickSend service"),U.configure(e)}async loadConfiguration(){return U.loadConfiguration()}async sendSMS(e){return U.sendSMS(e)}async sendBulkSMS(e){return U.sendBulkSMS(e)}async getDeliveryStatus(e){return U.getDeliveryStatus(e)}async testSMS(e){return U.testSMS(e)}async addTestNumber(e){return U.addTestNumber(e)}async removeTestNumber(e){return U.removeTestNumber(e)}getTestNumbers(){return U.getTestNumbers()}async getDailyUsage(){return U.getDailyUsage()}isServiceConfigured(){return U.isServiceConfigured()}getConfiguration(){return U.getConfiguration()}async getServiceStatus(){return U.getServiceStatus()}async sendSimpleSMS(e,t,s){return U.sendSimpleSMS(e,t,s)}async getAvailableFromNumbers(){return U.getAvailableFromNumbers()}async sendCustomSMS(e,t,s){return U.sendCustomSMS(e,t,s)}async getAccountBalance(){return U.getAccountBalance()}}const Q=new G;new class extends G{async loadEnvironmentConfig(){console.log("Legacy production service redirecting to ClickSend production service"),await U.loadConfiguration()}async initializeForProduction(){console.log("🚀 Legacy production SMS service redirected to ClickSend production service"),await this.loadEnvironmentConfig()}},console.warn("\n⚠️  DEPRECATION NOTICE: smsService.ts is deprecated\n📱 All SMS functionality now uses ClickSend exclusively\n🔄 Please migrate to: import { clickSendSmsService } from './clickSendSmsService'\n✅ Your provided ClickSend credentials are active: mobil3801beach@gmail.com\n");const V=new class{async checkAndSendAlerts(){try{const e=O.getInstance(),{data:t,error:s}=await e.callApi("tablePage",12611,{PageNo:1,PageSize:100,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_active",op:"Equal",value:!0}]});if(s)return void console.error("Error loading SMS settings:",s);const a=t.List||[];if(0===a.length)return void console.log("No active SMS alert settings found");const{data:n,error:i}=await e.callApi("tablePage",11731,{PageNo:1,PageSize:1e3,OrderByField:"expiry_date",IsAsc:!0,Filters:[{name:"status",op:"Equal",value:"Active"}]});if(i)return void console.error("Error loading licenses:",i);const r=n.List||[];console.log(`Found ${r.length} active licenses to check`);const{data:o,error:c}=await e.callApi("tablePage",12612,{PageNo:1,PageSize:100,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_active",op:"Equal",value:!0}]});if(c)return void console.error("Error loading SMS contacts:",c);const l=o.List||[];if(0===l.length)return void console.log("No active SMS contacts found");const d=new Date;let m=0;for(const u of r){const e=new Date(u.expiry_date),t=Math.ceil((e.getTime()-d.getTime())/864e5);for(const s of a)if(t<=s.days_before_expiry&&t>0){if(await this.shouldSendAlert(u.id,s.id,s.alert_frequency_days)){const e=this.getRelevantContacts(l,u.station);for(const a of e)await this.sendLicenseAlert(u,a,s,t),m++}}}console.log(`License alert check completed. ${m} alerts sent.`)}catch(e){console.error("Error in license alert service:",e)}}async shouldSendAlert(e,t,s){try{const t=O.getInstance(),{data:a,error:n}=await t.callApi("tablePage",12613,{PageNo:1,PageSize:1,OrderByField:"sent_date",IsAsc:!1,Filters:[{name:"license_id",op:"Equal",value:e}]});if(n)return console.error("Error checking alert history:",n),!0;const i=a.List||[];if(0===i.length)return!0;const r=new Date(i[0].sent_date),o=new Date;return Math.ceil((o.getTime()-r.getTime())/864e5)>=s}catch(a){return console.error("Error checking alert frequency:",a),!0}}getRelevantContacts(e,t){return e.filter(e=>"ALL"===e.station||e.station===t)}async sendLicenseAlert(e,t,s,a){try{const n=this.createMessageFromTemplate(s.message_template,e,a),i=await Q.sendSMS({to:t.mobile_number,message:n,type:"license_alert"}),r=O.getInstance();await r.callApi("tableCreate",12613,{license_id:e.id,contact_id:t.id,mobile_number:t.mobile_number,message_content:n,sent_date:(new Date).toISOString(),delivery_status:i.success?"Sent":`Failed - ${i.error}`,days_before_expiry:a,created_by:1}),i.success?console.log(`License alert sent successfully to ${t.contact_name}`):console.error(`License alert failed to ${t.contact_name}:`,i.error)}catch(n){console.error(`Error sending license alert to ${t.contact_name}:`,n)}}createMessageFromTemplate(e,t,s){const a=new Date(t.expiry_date).toLocaleDateString();return e.replace(/{license_name}/g,t.license_name).replace(/{station}/g,t.station).replace(/{expiry_date}/g,a).replace(/{days_remaining}/g,s.toString()).replace(/{license_number}/g,t.license_number).replace(/{category}/g,t.category)}async sendImmediateAlert(e){try{const t=O.getInstance(),{data:s,error:a}=await t.callApi("tablePage",11731,{PageNo:1,PageSize:1,OrderByField:"id",IsAsc:!1,Filters:[{name:"ID",op:"Equal",value:e}]});if(a||!s.List||0===s.List.length)return{success:!1,message:"License not found"};const n=s.List[0],i=new Date(n.expiry_date),r=new Date,o=Math.ceil((i.getTime()-r.getTime())/864e5),{data:c,error:l}=await t.callApi("tablePage",12612,{PageNo:1,PageSize:100,OrderByField:"id",IsAsc:!1,Filters:[{name:"is_active",op:"Equal",value:!0}]});if(l)return{success:!1,message:"Failed to load contacts"};const d=c.List||[],m=this.getRelevantContacts(d,n.station);if(0===m.length)return{success:!1,message:"No active contacts found for this station"};const u=`🚨 URGENT: License '${n.license_name}' for ${n.station} expires in ${o} days (${i.toLocaleDateString()}). Please renew immediately!`;let g=0;for(const e of m){const s=await Q.sendSMS({to:e.mobile_number,message:u,type:"immediate_alert"});await t.callApi("tableCreate",12613,{license_id:n.ID,contact_id:e.id,mobile_number:e.mobile_number,message_content:u,sent_date:(new Date).toISOString(),delivery_status:s.success?"Sent":`Failed - ${s.error}`,days_before_expiry:o,created_by:1}),s.success&&g++}return{success:g>0,message:`Alert sent to ${g}/${m.length} contacts`}}catch(t){return console.error("Error sending immediate alert:",t),{success:!1,message:"Failed to send alert"}}}},H=()=>{const[u,C]=t.useState([]),[M,E]=t.useState(!0),[O,q]=t.useState(""),[U,G]=t.useState(1),[Q,H]=t.useState(0),[W,Y]=t.useState(null),[K,J]=t.useState(!1),[Z,X]=t.useState(!1),[ee,te]=t.useState(null),[se,ae]=t.useState(!1),[ne,ie]=t.useState(null),[re,oe]=t.useState(!0),ce=B(),{userProfile:le,isAdmin:de}=h();t.useEffect(()=>{me()},[U,O,re]);const me=async()=>{try{E(!0);const e=[];O&&e.push({name:"license_name",op:"StringContains",value:O}),re||e.push({name:"status",op:"StringContains",value:"Active"});const{data:t,error:s}=await window.ezsite.apis.tablePage("11731",{PageNo:U,PageSize:10,OrderByField:"expiry_date",IsAsc:!0,Filters:e});if(s)throw s;C(t?.List||[]),H(t?.VirtualCount||0)}catch(e){console.error("Error loading licenses:",e),p({title:"Error",description:"Failed to load licenses",variant:"destructive"})}finally{E(!1)}},ue=e=>{switch(e.toLowerCase()){case"active":return"bg-green-500";case"expired":return"bg-red-500";case"pending renewal":return"bg-yellow-500";default:return"bg-gray-500"}},ge=e=>{switch(e.toUpperCase()){case"MOBIL":return"bg-blue-600";case"AMOCO ROSEDALE":return"bg-green-600";case"AMOCO BROOKLYN":return"bg-purple-600";default:return"bg-gray-600"}},he=e=>e?new Date(e).toLocaleDateString():"N/A",pe=e=>{if(!e)return!1;const t=new Date,s=new Date(e),a=Math.ceil((s.getTime()-t.getTime())/864e5);return a<=30&&a>=0},xe=e=>{if(!e)return!1;const t=new Date;return new Date(e)<t},fe=Math.ceil(Q/10),ye=u.reduce((e,t)=>({active:e.active+("active"===t.status.toLowerCase()?1:0),expiring_soon:e.expiring_soon+(pe(t.expiry_date)&&"cancelled"!==t.status.toLowerCase()?1:0),expired:e.expired+(xe(t.expiry_date)&&"cancelled"!==t.status.toLowerCase()?1:0),cancelled:e.cancelled+("cancelled"===t.status.toLowerCase()||"inactive"===t.status.toLowerCase()?1:0)}),{active:0,expiring_soon:0,expired:0,cancelled:0});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(o,{children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(k,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Active Licenses"}),e.jsx("p",{className:"text-2xl font-bold",children:ye.active})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"w-8 h-8 text-yellow-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Expiring Soon"}),e.jsx("p",{className:"text-2xl font-bold",children:ye.expiring_soon})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(D,{className:"w-8 h-8 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Expired"}),e.jsx("p",{className:"text-2xl font-bold",children:ye.expired})]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(L,{className:"w-8 h-8 text-gray-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Cancelled"}),e.jsx("p",{className:"text-2xl font-bold",children:ye.cancelled})]})]})})})]}),e.jsxs(o,{children:[e.jsx(c,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(l,{className:"flex items-center space-x-2",children:[e.jsx(D,{className:"w-6 h-6"}),e.jsx("span",{children:"Licenses & Certificates"})]}),e.jsx(x,{children:"Manage your business licenses and certificates"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[de()&&e.jsxs(e.Fragment,{children:[e.jsxs(r,{onClick:async()=>{try{X(!0),p({title:"📱 Checking Licenses",description:"Analyzing licenses for expiry alerts..."}),await V.checkAndSendAlerts(),p({title:"✅ License Alerts Complete",description:"SMS alerts sent for expiring licenses. Check SMS History for details."})}catch(e){console.error("Error sending SMS alerts:",e),p({title:"❌ Alert Failed",description:"Failed to send SMS alerts. Please try again.",variant:"destructive"})}finally{X(!1)}},disabled:Z,variant:"outline",className:"flex items-center space-x-2",children:[e.jsx(P,{className:"w-4 h-4"}),e.jsx("span",{children:Z?"Sending...":"Send SMS Alerts"})]}),e.jsxs(r,{onClick:()=>ce("/admin/sms"),variant:"outline",className:"flex items-center space-x-2",children:[e.jsx(F,{className:"w-4 h-4"}),e.jsx("span",{children:"SMS Settings"})]})]}),e.jsxs(r,{onClick:()=>ce("/licenses/new"),className:"flex items-center space-x-2",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{children:"Add License"})]})]})]})}),e.jsxs(m,{children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(f,{placeholder:"Search licenses...",value:O,onChange:e=>q(e.target.value),className:"pl-10"})]})}),M?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((t,s)=>e.jsx("div",{className:"h-16 bg-gray-100 rounded animate-pulse"},s))}):0===u.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(D,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"No licenses found"}),e.jsx(r,{variant:"outline",className:"mt-4",onClick:()=>ce("/licenses/new"),children:"Add Your First License"})]}):e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(v,{children:[e.jsx(b,{children:e.jsxs(S,{children:[e.jsx(w,{children:"License Name"}),e.jsx(w,{children:"License Number"}),e.jsx(w,{children:"Category"}),e.jsx(w,{children:"Station"}),e.jsx(w,{children:"Issue Date"}),e.jsx(w,{children:"Expiry Date"}),e.jsx(w,{children:"Status"}),e.jsx(w,{children:"Actions"})]})}),e.jsx(j,{children:u.map(t=>{return e.jsxs(S,{className:xe(t.expiry_date)?"bg-red-50":pe(t.expiry_date)?"bg-yellow-50":"",children:[e.jsx(N,{children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.license_name}),e.jsx("p",{className:"text-sm text-gray-500",children:t.issuing_authority})]})}),e.jsx(N,{className:"font-medium",children:t.license_number}),e.jsx(N,{children:e.jsx(d,{className:`text-white ${s=t.category,{Business:"bg-blue-500",Environmental:"bg-green-500",Safety:"bg-orange-500",Health:"bg-purple-500",Fire:"bg-red-500",Building:"bg-gray-500"}[s]||"bg-gray-500"}`,children:t.category})}),e.jsx(N,{children:e.jsx(d,{className:`text-white ${ge(t.station)}`,children:t.station})}),e.jsx(N,{children:he(t.issue_date)}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:he(t.expiry_date)}),xe(t.expiry_date)&&e.jsx(A,{className:"w-4 h-4 text-red-500"}),pe(t.expiry_date)&&!xe(t.expiry_date)&&e.jsx(A,{className:"w-4 h-4 text-yellow-500"})]})}),e.jsx(N,{children:e.jsx(d,{className:`text-white ${ue(t.status)}`,children:t.status})}),e.jsx(N,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(r,{variant:"outline",size:"sm",onClick:()=>(e=>{Y(e),J(!0)})(t),className:"text-blue-600 hover:text-blue-700",title:"Print Document",children:e.jsx(_,{className:"w-4 h-4"})}),(pe(t.expiry_date)||xe(t.expiry_date))&&e.jsx(r,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{const t=await V.sendImmediateAlert(e);t.success?p({title:"📱 SMS Alert Sent",description:t.message}):p({title:"❌ Alert Failed",description:t.message,variant:"destructive"})}catch(t){console.error("Error sending immediate alert:",t),p({title:"Error",description:"Failed to send SMS alert",variant:"destructive"})}})(t.ID),className:"text-orange-600 hover:text-orange-700",title:"Send SMS Alert",children:e.jsx(F,{className:"w-4 h-4"})}),de()&&e.jsxs(e.Fragment,{children:[e.jsx(r,{variant:"outline",size:"sm",onClick:()=>{try{ce(`/licenses/${t.ID}/edit`)}catch(e){console.error("Error navigating to edit license:",e),p({title:"Navigation Error",description:"Failed to open edit form. Please try again.",variant:"destructive"})}},title:"Edit License",children:e.jsx(T,{className:"w-4 h-4"})}),"cancelled"===t.status.toLowerCase()||"inactive"===t.status.toLowerCase()?e.jsx(r,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{te(e);const{error:t}=await window.ezsite.apis.tableUpdate("11731",{ID:e,status:"Active"});if(t)throw t;p({title:"✅ License Reactivated",description:"License has been successfully reactivated.",duration:3e3}),await me()}catch(t){console.error("Error reactivating license:",t),p({title:"❌ Reactivation Failed",description:`Failed to reactivate license: ${t}`,variant:"destructive"})}finally{te(null)}})(t.ID),disabled:ee===t.ID,className:""+(ee===t.ID?"text-gray-400":"text-green-600 hover:text-green-700"),title:ee===t.ID?"Processing...":"Reactivate License",children:e.jsx(k,{className:"w-4 h-4 "+(ee===t.ID?"animate-spin":"")})}):e.jsx(r,{variant:"outline",size:"sm",onClick:()=>(e=>{ie(e),ae(!0)})(t),disabled:ee===t.ID,className:""+(ee===t.ID?"text-gray-400":"text-red-600 hover:text-red-700"),title:ee===t.ID?"Processing...":"Delete License",children:e.jsx($,{className:"w-4 h-4 "+(ee===t.ID?"animate-spin":"")})})]})]})})]},t.ID);var s})})]})}),!de()&&e.jsx("div",{className:"mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700",children:[e.jsx("strong",{children:"Access Restrictions:"}),"Only administrators can edit, delete, or manage SMS alerts for licenses."]})}),fe>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["Showing ",10*(U-1)+1," to ",Math.min(10*U,Q)," of ",Q," licenses"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(r,{variant:"outline",size:"sm",onClick:()=>G(e=>Math.max(e-1,1)),disabled:1===U,children:"Previous"}),e.jsxs("span",{className:"text-sm",children:["Page ",U," of ",fe]}),e.jsx(r,{variant:"outline",size:"sm",onClick:()=>G(e=>Math.min(e+1,fe)),disabled:U===fe,children:"Next"})]})]})]})]}),e.jsx(R,{license:W,isOpen:K,onClose:()=>{J(!1),Y(null)}}),e.jsx(s,{open:se,onOpenChange:ae,children:e.jsxs(a,{className:"sm:max-w-[425px]",children:[e.jsxs(n,{children:[e.jsxs(i,{className:"flex items-center space-x-2",children:[e.jsx($,{className:"w-5 h-5 text-red-500"}),e.jsx("span",{children:"Delete License"})]}),e.jsxs(y,{children:["Choose how you want to handle the license: ",e.jsx("strong",{children:ne?.license_name})]})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-start space-x-3 p-4 border rounded-lg bg-yellow-50",children:[e.jsx(L,{className:"w-5 h-5 text-yellow-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-yellow-800",children:"Soft Delete (Recommended)"}),e.jsx("p",{className:"text-sm text-yellow-700",children:"Mark as cancelled but keep all data for potential recovery. This is safer and maintains audit trails."})]})]}),e.jsxs("div",{className:"flex items-start space-x-3 p-4 border rounded-lg bg-red-50",children:[e.jsx($,{className:"w-5 h-5 text-red-600 mt-1"}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-red-800",children:"Permanent Delete"}),e.jsx("p",{className:"text-sm text-red-700",children:"Completely remove the license and all associated files and SMS history. This cannot be undone."})]})]})]})}),e.jsxs(g,{className:"space-x-2",children:[e.jsx(r,{variant:"outline",onClick:()=>ae(!1),disabled:null!==ee,children:"Cancel"}),e.jsxs(r,{variant:"outline",onClick:()=>{(async e=>{try{te(e);const{error:t}=await window.ezsite.apis.tableUpdate("11731",{ID:e,status:"Cancelled"});if(t)throw t;p({title:"✅ License Deactivated",description:"License has been marked as cancelled. It can be reactivated later if needed.",duration:5e3}),await me()}catch(t){console.error("Error deactivating license:",t),p({title:"❌ Deactivation Failed",description:`Failed to deactivate license: ${t}`,variant:"destructive"})}finally{te(null)}})(ne?.ID||0),ae(!1)},disabled:null!==ee,className:"text-yellow-600 hover:text-yellow-700 border-yellow-200 hover:bg-yellow-50",children:[e.jsx(L,{className:"w-4 h-4 mr-2"}),"Soft Delete"]}),e.jsxs(r,{variant:"destructive",onClick:()=>{(async e=>{if(de()){te(e);try{const{data:n,error:i}=await window.ezsite.apis.tablePage("11731",{PageNo:1,PageSize:1,Filters:[{name:"ID",op:"Equal",value:e}]});if(i)throw i;const r=n?.List?.[0];if(!r)throw new Error("License not found");if(p({title:"🗑️ Deleting License",description:"Removing associated files and data..."}),r.document_file_id)try{console.log(`Deleting file with ID: ${r.document_file_id}`)}catch(t){console.warn("File deletion warning:",t)}try{const{data:t,error:s}=await window.ezsite.apis.tablePage("12613",{PageNo:1,PageSize:100,Filters:[{name:"license_id",op:"Equal",value:e}]});if(!s&&t?.List?.length>0){for(const e of t.List)await window.ezsite.apis.tableDelete("12613",{ID:e.ID});console.log(`Deleted ${t.List.length} SMS alert history records`)}}catch(s){console.warn("SMS alert history cleanup warning:",s)}try{const{data:e,error:t}=await window.ezsite.apis.tablePage("12642",{PageNo:1,PageSize:100,Filters:[{name:"alert_type",op:"Equal",value:"License Expiry"},{name:"station_filter",op:"Equal",value:r.station}]});!t&&e?.List?.length>0&&console.log(`Found ${e.List.length} related alert schedules`)}catch(a){console.warn("Alert schedule cleanup warning:",a)}const{error:o}=await window.ezsite.apis.tableDelete("11731",{ID:e});if(o)throw o;p({title:"✅ License Deleted Successfully",description:`${r.license_name} and all associated data have been removed from the system.`,duration:5e3}),await me()}catch(n){console.error("Error during license deletion:",n),p({title:"❌ Deletion Failed",description:`Failed to delete license: ${n}`,variant:"destructive",duration:7e3})}finally{te(null)}}else p({title:"Access Denied",description:"Only administrators can permanently delete licenses.",variant:"destructive"})})(ne?.ID||0),ae(!1)},disabled:null!==ee,children:[e.jsx($,{className:"w-4 h-4 mr-2"}),"Permanent Delete"]})]})]})})]})};export{H as default};
