import{j as e}from"./radix-ui-woSLwCdF.js";import{r as s}from"./react-core-CKNU0hQt.js";import{s as t,g as a}from"./invariantSafeHelper-CpdXj1Qs.js";import{u as l,j as r,t as i,C as n,h as c,f as o,g as d,B as m,k as x,e as h,I as j}from"./index-BJg4_aev.js";import{T as u,a as p,b as _,c as g,d as N,e as f}from"./table-DMcwkzpY.js";import{E as b}from"./EnhancedSalesReportPrintDialog-CYyelS_f.js";import{S as y}from"./StationDropdown-C_R2yek6.js";import{s as v}from"./use-station-store-cuzAOZQB.js";import{u as S}from"./routing-DcURAnU1.js";import{D as A,p as w,n as D,W as C,Y as L,a8 as E,a9 as O,Z as I,V as T}from"./utilities-DMEd7dY0.js";import"./data-management-r38r-ocq.js";import"./animations-CdlE0-Ca.js";import"./select-DCbSmMef.js";const P=e=>(e=>{const{userProfile:t}=l(),[a,r]=s.useState([]),[i,n]=s.useState(!0);s.useEffect(()=>{(async()=>{try{n(!0);const e=await v.getUserAccessibleStations(t?.role,t?.permissions,t?.stationAccess);r(e)}catch(e){console.error("Error loading accessible stations:",e),r([])}finally{n(!1)}})()},[t?.role,t?.permissions,t?.stationAccess]);const c=s.useCallback(()=>"ALL_STATIONS"===e||"ALL"===e?0===a.length?[{name:"station",op:"Equal",value:"__NO_ACCESS__"}]:1===a.length?[{name:"station",op:"Equal",value:a[0]}]:null:[{name:"station",op:"Equal",value:e}],[e,a]),o=e&&"ALL_STATIONS"!==e&&"ALL"!==e,d=s.useCallback(()=>a.map(e=>({name:"station",op:"Equal",value:e})),[a]);return{stationFilters:c(),shouldFilterByStation:o,isAllSelected:"ALL_STATIONS"===e||"ALL"===e,accessibleStations:a,accessibleStationsFilter:d(),loading:i}})(e),M=()=>{const[v,M]=s.useState([]),[F,R]=s.useState(!0),[k,z]=s.useState(""),[Y,B]=s.useState("ALL_STATIONS"),[$,V]=s.useState(1),[q,G]=s.useState(0),[U,Z]=s.useState(!1),[H,K]=s.useState(null),W=S(),{userProfile:J,isAdmin:Q}=l(),{canCreate:X,canEdit:ee,canDelete:se,isModuleAccessEnabled:te}=r(),ae=X("sales"),le=ee("sales")&&Q(),re=se("sales")&&Q();console.log("Permission states:",{canCreateSales:ae,canEditSales:le,canDeleteSales:re,isAdmin:Q()});const{stationFilters:ie,isAllSelected:ne}=P(Y);s.useEffect(()=>{ce()},[$,k,Y]);const ce=async()=>{try{console.log("Loading sales reports with:",{currentPage:$,searchTerm:k,selectedStation:Y,stationFilters:ie}),R(!0);const e=[];ie&&e.push(...ie),k&&e.push({name:"station",op:"StringContains",value:k});const{data:s,error:t}=await window.ezsite.apis.tablePage("12356",{PageNo:$,PageSize:10,OrderByField:"report_date",IsAsc:!1,Filters:e});if(t)throw console.error("API error in tablePage:",t),t;console.log("Received sales reports data:",s),M(s?.List||[]),G(s?.VirtualCount||0)}catch(e){console.error("Error loading sales reports:",e),i({title:"Error",description:"Failed to load sales reports",variant:"destructive"})}finally{R(!1)}},oe=()=>{if(console.log("Attempting to create new sales report"),!ae)return console.warn("Create permission denied for user"),void i({title:"Access Denied",description:"You don't have permission to create sales reports.",variant:"destructive"});W("/sales/new")},de="employee"===J?.role||Q(),me=e=>{switch(e.toUpperCase()){case"MOBIL":return"bg-blue-500";case"AMOCO ROSEDALE":return"bg-green-500";case"AMOCO BROOKLYN":return"bg-purple-500";default:return"bg-gray-500"}},xe=e=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e),he=Math.ceil(q/10),je=v.reduce((e,s)=>{const t=s.total_sales||0,a=s.cash_amount||0,l=s.credit_card_amount||0,r=s.debit_card_amount||0,i=s.mobile_amount||0,n=s.grocery_sales||0,c=s.total_gallons||0,o=s.lottery_total_cash||0,d=a+l+r+i;return Math.abs(d+n-t)>.01&&console.warn(`Report ID ${s.ID}: Payment methods + grocery (${d+n}) don't match total (${t})`),{total_sales:e.total_sales+t,cash_amount:e.cash_amount+a,credit_card_amount:e.credit_card_amount+l,debit_card_amount:e.debit_card_amount+r,mobile_amount:e.mobile_amount+i,grocery_sales:e.grocery_sales+n,total_gallons:e.total_gallons+c,lottery_total_cash:e.lottery_total_cash+o}},{total_sales:0,cash_amount:0,credit_card_amount:0,debit_card_amount:0,mobile_amount:0,grocery_sales:0,total_gallons:0,lottery_total_cash:0}),ue=je.cash_amount+je.credit_card_amount+je.debit_card_amount+je.mobile_amount,pe=ue+je.grocery_sales;return console.log("Summary calculations:",{total_sales:je.total_sales,payment_total:ue,with_grocery:pe,payment_matches:Math.abs(pe-je.total_sales)<=.01}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(n,{children:e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"w-8 h-8 text-green-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Sales"}),e.jsx("p",{className:"text-2xl font-bold",children:xe(je.total_sales)}),ne&&e.jsx("p",{className:"text-xs text-blue-600",children:"All Stations"})]})]})})}),e.jsx(n,{children:e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Gallons"}),e.jsx("p",{className:"text-2xl font-bold",children:je.total_gallons.toFixed(2)}),ne&&e.jsx("p",{className:"text-xs text-blue-600",children:"All Stations"})]})]})})}),e.jsx(n,{children:e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"w-8 h-8 text-purple-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Grocery Sales"}),e.jsx("p",{className:"text-2xl font-bold",children:xe(je.grocery_sales)}),ne&&e.jsx("p",{className:"text-xs text-blue-600",children:"All Stations"})]})]})})}),e.jsx(n,{children:e.jsx(c,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(D,{className:"w-8 h-8 text-orange-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Reports"}),e.jsx("p",{className:"text-2xl font-bold",children:q}),ne&&e.jsx("p",{className:"text-xs text-blue-600",children:"All Stations"})]})]})})})]}),e.jsxs(n,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(d,{className:"flex items-center space-x-2",children:[e.jsx(w,{className:"w-6 h-6"}),e.jsx("span",{children:"Daily Sales Reports"}),ne&&e.jsx(m,{variant:"outline",className:"ml-2",children:"Viewing All Stations"})]}),e.jsxs(x,{children:["Track daily sales performance across ",ne?"all stations":"selected station"]})]}),ae&&de?e.jsxs(h,{onClick:oe,className:"flex items-center space-x-2",children:[e.jsx(C,{className:"w-4 h-4"}),e.jsx("span",{children:"Add Report"})]}):te&&e.jsx(m,{variant:"secondary",className:"text-xs",children:"Create access disabled by admin"})]})}),e.jsxs(c,{children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1 max-w-sm",children:[e.jsx(L,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(j,{placeholder:"Search by station...",value:k,onChange:e=>z(e.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{className:"w-4 h-4 text-gray-500"}),e.jsx(y,{value:Y,onValueChange:B,placeholder:"Filter by station",includeAll:!0,showBadge:!0,className:"min-w-[200px]"})]})]}),F?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((s,t)=>e.jsx("div",{className:"h-16 bg-gray-100 rounded animate-pulse"},t))}):0===v.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(w,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),e.jsxs("p",{className:"text-gray-500",children:["No sales reports found","ALL_STATIONS"!==Y&&"ALL"!==Y&&e.jsxs("span",{children:[" for ",Y]})]}),ae&&de&&e.jsx(h,{variant:"outline",className:"mt-4",onClick:oe,children:"Add Your First Sales Report"})]}):e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs(u,{children:[e.jsx(p,{children:e.jsxs(_,{children:[e.jsx(g,{children:"Date"}),e.jsx(g,{children:"Station"}),e.jsx(g,{children:"Shift"}),e.jsx(g,{children:"Total Sales"}),e.jsx(g,{children:"Gallons"}),e.jsx(g,{children:"Grocery"}),e.jsx(g,{children:"Payment Methods"}),e.jsx(g,{children:"Employee"}),e.jsx(g,{children:"Actions"})]})}),e.jsxs(N,{children:[t(v,(s,t)=>{return e.jsxs(_,{children:[e.jsx(f,{className:"font-medium",children:(l=s.report_date,l?new Date(l).toLocaleDateString():"N/A")}),e.jsx(f,{children:e.jsx(m,{className:`text-white ${me(s.station)}`,children:s.station})}),e.jsx(f,{children:e.jsx(m,{variant:"DAY"===s.shift?"default":"secondary",children:s.shift||"DAY"})}),e.jsx(f,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:xe(s.total_sales)}),(()=>{const t=s.total_sales||0,a=(s.cash_amount||0)+(s.credit_card_amount||0)+(s.debit_card_amount||0)+(s.mobile_amount||0)+(s.grocery_sales||0);return Math.abs(a-t)<=.01?e.jsx("span",{className:"text-green-600 text-xs",children:"✓"}):e.jsx("span",{className:"text-red-600 text-xs",title:`Payment total: ${xe(a)}`,children:"⚠️"})})()]})}),e.jsx(f,{children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{children:(s.total_gallons||0).toFixed(2)})})}),e.jsx(f,{children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{children:xe(s.grocery_sales)})})}),e.jsx(f,{children:e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{children:["Cash: ",xe(s.cash_amount)]}),e.jsxs("div",{children:["Credit: ",xe(s.credit_card_amount)]}),e.jsxs("div",{children:["Debit: ",xe(s.debit_card_amount)]}),e.jsxs("div",{children:["Mobile: ",xe(s.mobile_amount)]})]})}),e.jsx(f,{children:s.employee_name}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>(e=>{K(e),Z(!0)})(s),title:"View / Print Report",children:e.jsx(O,{className:"w-4 h-4"})}),le&&e.jsx(h,{variant:"outline",size:"sm",onClick:()=>(e=>{if(console.log("Attempting to edit report ID:",e),!le)return console.warn("Edit permission denied for user"),void i({title:"Access Denied",description:"Only administrators can edit sales reports.",variant:"destructive"});W(`/sales/${e}/edit`)})(s.ID),title:"Edit Report",children:e.jsx(I,{className:"w-4 h-4"})}),re&&e.jsx(h,{variant:"outline",size:"sm",onClick:()=>(async e=>{if(console.log("Attempting to delete report ID:",e),!re)return console.warn("Delete permission denied for user"),void i({title:"Access Denied",description:"Only administrators can delete sales reports.",variant:"destructive"});if(confirm("Are you sure you want to delete this sales report?"))try{const{error:s}=await window.ezsite.apis.tableDelete("12356",{ID:e});if(s)throw console.error("API error in tableDelete:",s),s;i({title:"Success",description:"Sales report deleted successfully"}),ce()}catch(s){console.error("Error deleting sales report:",s),i({title:"Error",description:"Failed to delete sales report",variant:"destructive"})}})(s.ID),className:"text-red-600 hover:text-red-700",title:"Delete Report",children:e.jsx(T,{className:"w-4 h-4"})})]})})]},a(s,t,"report"));var l}),v.length>0&&e.jsxs(_,{className:"bg-gray-50 font-semibold border-t-2",children:[e.jsx(f,{className:"font-bold",children:"TOTALS"}),e.jsx(f,{children:e.jsxs(m,{variant:"outline",className:"text-xs",children:[v.length," reports"]})}),e.jsx(f,{className:"text-gray-500",children:"-"}),e.jsx(f,{className:"font-bold text-green-600",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("span",{children:xe(je.total_sales)}),Math.abs(pe-je.total_sales)<=.01?e.jsx("span",{className:"text-green-600 text-xs",children:"✓"}):e.jsx("span",{className:"text-red-600 text-xs",children:"⚠️"})]})}),e.jsx(f,{className:"font-bold text-blue-600",children:je.total_gallons.toFixed(2)}),e.jsx(f,{className:"font-bold text-purple-600",children:xe(je.grocery_sales)}),e.jsx(f,{children:e.jsxs("div",{className:"space-y-1 text-xs",children:[e.jsxs("div",{className:"font-medium",children:["Cash: ",xe(je.cash_amount)]}),e.jsxs("div",{className:"font-medium",children:["Credit: ",xe(je.credit_card_amount)]}),e.jsxs("div",{className:"font-medium",children:["Debit: ",xe(je.debit_card_amount)]}),e.jsxs("div",{className:"font-medium",children:["Mobile: ",xe(je.mobile_amount)]})]})}),e.jsx(f,{className:"text-gray-500",children:"-"}),e.jsx(f,{className:"text-gray-500",children:"-"})]})]})]})}),(!le||!re)&&te&&e.jsx("div",{className:"mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg",children:e.jsxs("p",{className:"text-sm text-amber-700",children:[e.jsx("strong",{children:"Access Restrictions:"}),!le&&" Edit access restricted to administrators.",!re&&" Delete access restricted to administrators."]})}),he>1&&e.jsxs("div",{className:"flex items-center justify-between mt-6",children:[e.jsxs("p",{className:"text-sm text-gray-700",children:["Showing ",10*($-1)+1," to ",Math.min(10*$,q)," of ",q," reports","ALL"!==Y&&e.jsxs("span",{children:[" for ",Y]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>V(e=>Math.max(e-1,1)),disabled:1===$,children:"Previous"}),e.jsxs("span",{className:"text-sm",children:["Page ",$," of ",he]}),e.jsx(h,{variant:"outline",size:"sm",onClick:()=>V(e=>Math.min(e+1,he)),disabled:$===he,children:"Next"})]})]})]})]}),e.jsx(b,{open:U,onOpenChange:Z,report:H})]})};export{M as default};
